<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","account.rs"],"content":"/*\n * src/controllers/account.rs\n *\n * File for Account Controller API Endpoints\n *\n * Purpose:\n *   Serve Account Related API Requests\n */\n\nuse argon2::{\n\tArgon2,\n\tpassword_hash::{PasswordHash, PasswordHasher, PasswordVerifier, SaltString, rand_core::OsRng},\n};\nuse axum::{\n\tExtension, Json,\n\trouting::{get, post},\n};\n#[cfg(test)]\nuse tower_cookies::cookie::CookieJar;\nuse tower_cookies::{\n\tCookie, Cookies,\n\tcookie::{\n\t\tKey, SameSite,\n\t\ttime::{Duration, OffsetDateTime},\n\t},\n};\n\nuse sqlx::PgPool;\nuse tracing::debug;\nuse utoipa::OpenApi;\n\nuse crate::http_models::account::*;\nuse crate::middleware::{AuthUser, middleware_auth};\nuse crate::{\n\tcontrollers::AxumRouter,\n\terror::{ApiResult, AppError},\n\tsql_models::{BudgetBucket, RiskTolerence, account::AccountRow},\n\tswagger::SecurityAddon,\n};\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_signup,\n\t\tapi_login,\n\t\tapi_logout,\n\t\tapi_validate,\n\t\tapi_update,\n\t\tapi_current\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n    info(\n    \ttitle=\"Account Routes\",\n    \tdescription = \"API endpoints dealing with authentication and account info.\"\n    ),\n    tags((name=\"Account\"))\n)]\npub struct AccountApiDoc;\n\npub trait CookieStore {\n\tfn private_add(\u0026mut self, key: \u0026Key, cookie: Cookie\u003c'static\u003e);\n}\nimpl CookieStore for Cookies {\n\t#[inline(always)]\n\tfn private_add(\u0026mut self, key: \u0026Key, cookie: Cookie\u003c'static\u003e) {\n\t\tself.private(key).add(cookie)\n\t}\n}\n#[cfg(test)]\nimpl CookieStore for CookieJar {\n\t#[inline(always)]\n\tfn private_add(\u0026mut self, _key: \u0026Key, cookie: Cookie\u003c'static\u003e) {\n\t\tself.add(cookie)\n\t}\n}\n\n/// Creates and sets the cookie containing the hashed account id, expiration time, and other data.\n///\n/// Notes:\n/// - Token format is `user-\u003cid\u003e.\u003cexp\u003e.sign`, where `\u003cexp\u003e` is epoch seconds (UTC) ~3 days out.\n/// - Cookie name is `auth-token`; in development it uses `SameSite=Lax`, not `Secure`.\nfn set_cookie(account_id: i32, expired: bool, cookies: \u0026mut impl CookieStore, key: \u0026Key) {\n\t// Create token and set cookie as before\n\tlet domain = option_env!(\"DOMAIN\").unwrap_or(\"localhost\");\n\tlet app_env = option_env!(\"APP_ENV\").unwrap_or(\"development\");\n\tlet on_production = app_env == \"production\";\n\n\t// Create a token value (in a real app, this would be a JWT or similar)\n\t// Embed expiration epoch seconds inside the token for server-side validation\n\tlet (expires, max_age) = if expired {\n\t\t(OffsetDateTime::UNIX_EPOCH, Duration::days(0))\n\t} else {\n\t\tlet age = Duration::days(3);\n\t\t(OffsetDateTime::now_utc() + age, age)\n\t};\n\tlet token_value = format!(\"user-{}.{}.sign\", account_id, expires.unix_timestamp());\n\n\tdebug!(\n\t\t\"INFO -\u003e\u003e Generated token: {}. Production is: {}\",\n\t\ttoken_value, on_production\n\t);\n\n\t// Build the cookie with enhanced security\n\t// Store encrypted (private) cookie so value is confidential and authenticated\n\tlet cookie = Cookie::build((\"auth-token\", token_value.clone()))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.expires(Some(expires))\n\t\t.max_age(max_age)\n\t\t.build();\n\n\t// encrypt/sign cookie (private cookie via CookieManagerLayer key)\n\tcookies.private_add(key, cookie);\n}\n\n/// Create a new user.\n///\n/// # Method\n/// `POST /api/account/signup`\n///\n/// # Request Body\n/// - `email`: A valid email address (string, required).\n/// - `first_name`: The user's first name (string, required).\n/// - 'last_name': The user's last name (string, required).\n/// - 'password': The user's password (string, required).\n///\n/// # Responses\n/// - `200 OK` - Signup successful\n/// - `400 BAD_REQUEST` - Validation failure (public error)\n/// - `409 CONFLICT` - Email already exists (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/signup\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///        \"email\": \"alice@example.com\",\n///        \"first_name\": \"alice\",\n///        \"last_name\": \"grace\",\n///        \"password\": \"password123.\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/signup\",\n\tsummary=\"Create a new account\",\n\tdescription=\"Inserts account details into db (if email isn't already taken), and returns with a cookie.\",\n\trequest_body(\n\t\tcontent=SignupRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Email must not already be taken. Password must be in plaintext.\",\n\t\texample=json!({\n\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\"first_name\": \"First\",\n\t\t\t\"last_name\": \"Last\",\n\t\t\t\"password\": \"Password_123\"\n\t\t})\n\t),\n\tresponses(\n\t\t(status=200, description=\"Account successfully created\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=409, description=\"Email already in use\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n\ttag=\"Account\"\n)]\npub async fn api_signup\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(payload): Json\u003cSignupRequest\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/signup 'api_signup' - Payload: {:?}\",\n\t\tpayload\n\t);\n\n\t// Validate input\n\tif let Err(validation_error) = payload.validate() {\n\t\treturn Err(AppError::Validation(validation_error));\n\t}\n\n\t// Check if user already exists\n\tlet existing_user_result =\n\t\tsqlx::query!(\"SELECT id FROM accounts WHERE email = $1\", payload.email)\n\t\t\t.fetch_optional(\u0026pool)\n\t\t\t.await;\n\n\tmatch existing_user_result {\n\t\tOk(Some(_)) =\u003e {\n\t\t\treturn Err(AppError::Conflict(\"email already exists\".to_string()));\n\t\t}\n\t\tErr(e) =\u003e {\n\t\t\treturn Err(AppError::from(e));\n\t\t}\n\t\tOk(None) =\u003e {\n\t\t\t// User doesn't exist, proceed with signup\n\t\t}\n\t}\n\n\t// Hash the password\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\tlet password_hash = argon2\n\t\t.hash_password(payload.password.as_bytes(), \u0026salt)\n\t\t.map_err(|e| AppError::from(e))?\n\t\t.to_string();\n\n\t// Insert new user into database\n\tlet insert_result = sqlx::query!(\n\t\t\"INSERT INTO accounts (email, first_name, last_name, password)\n         VALUES ($1, $2, $3, $4)\n         RETURNING id\",\n\t\tpayload.email,\n\t\tpayload.first_name,\n\t\tpayload.last_name,\n\t\tpassword_hash\n\t)\n\t.fetch_one(\u0026pool)\n\t.await;\n\n\tmatch insert_result {\n\t\tOk(record) =\u003e {\n\t\t\tdebug!(\n\t\t\t\t\"INFO -\u003e\u003e /api/account/signup 'api_signup' - Created user with id: {}\",\n\t\t\t\trecord.id\n\t\t\t);\n\n\t\t\tset_cookie(record.id, false, cookies, \u0026key);\n\n\t\t\tOk(())\n\t\t}\n\t\tErr(e) =\u003e Err(AppError::from(e)),\n\t}\n}\n\n/// Attempt user login\n///\n/// # Method\n/// `POST /api/account/login`\n///\n/// # Request Body\n/// - `email`: A valid email address (string, required).\n/// - 'password': The user's password (string, required).\n///\n/// # Responses\n/// - `200 OK` - Login successful with private cookie set\n/// - `400 BAD_REQUEST` - Invalid credentials (public error)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/login\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///        \"email\": \"alice@example.com\",\n///        \"password\": \"password123.\"\n///       }'\n/// ```\n///\n/// Notes:\n/// - Token format is `user-\u003cid\u003e.\u003cexp\u003e.sign`, where `\u003cexp\u003e` is epoch seconds (UTC) ~3 days out.\n/// - Cookie name is `auth-token`; in development it uses `SameSite=Lax`, not `Secure`.\n#[utoipa::path(\n\tpost,\n\tpath=\"/login\",\n\tsummary=\"Attempt user login\",\n\tdescription=\"Attempts to login and return with a cookie.\",\n\trequest_body(\n\t\tcontent=LoginRequest,\n\t\tcontent_type=\"application/json\",\n\t\texample=json!({\n\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\"password\": \"Password_123\"\n\t\t})\n\t),\n\tresponses(\n\t\t(status=200, description=\"Login succeeded\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n\ttag=\"Account\"\n)]\npub async fn api_login\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(payload): Json\u003cLoginRequest\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/login 'api_login' - Payload: {:?}\",\n\t\tpayload\n\t);\n\n\t// Get user from database as Account\n\tlet user_result = sqlx::query_as!(\n\t\tAccountRow,\n\t\tr#\"\n        SELECT\n            id,\n            email,\n            password\n        FROM accounts\n        WHERE email = $1\n        \"#,\n\t\tpayload.email\n\t)\n\t.fetch_one(\u0026pool)\n\t.await;\n\n\tmatch user_result {\n\t\tOk(result) =\u003e {\n\t\t\t// Verify password\n\t\t\tlet parsed_hash = PasswordHash::new(\u0026result.password).map_err(|e| AppError::from(e))?;\n\n\t\t\t// Attempt to match the password hashes\n\t\t\tif let Err(_) =\n\t\t\t\tArgon2::default().verify_password(payload.password.as_bytes(), \u0026parsed_hash)\n\t\t\t{\n\t\t\t\treturn Err(AppError::BadRequest(\"invalid credentials\".to_string()));\n\t\t\t}\n\n\t\t\tset_cookie(result.id, false, cookies, \u0026key);\n\n\t\t\treturn Ok(());\n\t\t}\n\t\tErr(_) =\u003e {\n\t\t\treturn Err(AppError::BadRequest(\"invalid credentials\".to_string()));\n\t\t}\n\t}\n}\n\n/// Returns whether the user has a valid auth token.\n/// Hit this route to validate the `auth-token` private cookie.\n///\n/// # Method\n/// `GET /api/account/validate`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - user has a valid auth token\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n#[utoipa::path(\n\tget,\n\tpath=\"/validate\",\n\tsummary=\"Whether the user has a valid auth-token\",\n\tdescription=\"Returns 200 if token is valid, or 401 if invalid or nonexistant.\",\n\tresponses(\n\t\t(status=200, description=\"User has a valid cookie\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_validate(Extension(user): Extension\u003cAuthUser\u003e) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/validate 'api_validate' - User ID: {}\",\n\t\tuser.id\n\t);\n\tOk(())\n}\n\n/// Get information about the user\n///\n/// # Method\n/// `GET /api/account/current`\n///\n/// # Responses\n/// - `200 OK` - with body: [CurrentResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/account/current\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/current\",\n\tsummary=\"Get account information\",\n\tdescription=\"Returns the user's non-sensitive account information.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"User's non-sensitive account information\",\n\t\t\tbody=CurrentResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\t\"first_name\": \"First\",\n\t\t\t\t\"last_name\": \"Last\",\n\t\t\t\t\"budget_preference\": \"MediumBudget\",\n\t\t\t\t\"risk_preference\": \"Adventurer\",\n\t\t\t\t\"food_allergies\": \"peanuts,vegetarian,pollen\",\n\t\t\t\t\"disabilities\": \"knee replacement\"\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_current(\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n) -\u003e ApiResult\u003cJson\u003cCurrentResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/current 'api_current' - User ID: {}\",\n\t\tuser.id\n\t);\n\t// Load current user's full account row\n\tlet account = sqlx::query_as!(\n\t\tCurrentResponse,\n\t\tr#\"\n        SELECT\n            email,\n            first_name,\n            last_name,\n            budget_preference as \"budget_preference: BudgetBucket\",\n            risk_preference as \"risk_preference: RiskTolerence\",\n            food_allergies,\n            disabilities\n        FROM accounts\n        WHERE id = $1\n        \"#,\n\t\tuser.id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(Json(account))\n}\n\n/// Update information about the user\n///\n/// # Method\n/// `POST /api/account/update`\n///\n/// # Request Body\n/// - `email`: A valid email address (string).\n/// - 'first_name': The user's first name (string).\n/// - 'last_name': The user's last name (string).\n/// - 'password': The user's password (string).\n/// - 'budget_preference': The user's budget preference (string).\n/// - 'risk_preference': The user's risk preference (string).\n/// - 'food_allergies': The user's allergies (string).\n/// - 'disabilities': The user's disabilities (string).\n///\n/// # Responses\n/// - `200 OK` - with body: [UpdateResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/update\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"email\": \"\",\n///         \"first_name\": \"\",\n///         \"last_name\": \"\",\n///         \"password\": \"\",\n///         \"budget_preference\": \"\",\n///         \"risk_preference\": \"\",\n///         \"food_allergies\": \"\",\n///         \"disabilities\": \"\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/update\",\n\tsummary=\"Update information about the user\",\n\tdescription=\"Update account info with provided data.\",\n\trequest_body(\n\t\tcontent=UpdateRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Non-null fields will update that field. Null fields will not update that field.\",\n\t\texample=json!({\n\t\t\t\"budget_preference\": \"LowBudget\"\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Account info updated successfully\",\n\t\t\tbody=UpdateResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\t\"first_name\": \"First\",\n\t\t\t\t\"last_name\": \"last\",\n\t\t\t\t\"budget_preference\": \"LowBudget\",\n\t\t\t\t\"risk_preference\": \"Adventurer\",\n\t\t\t\t\"food_allergies\": \"peanuts,vegetarian,pollen\",\n\t\t\t\t\"disabilities\": \"knee replacement\"\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_update(\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tJson(payload): Json\u003cUpdateRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cUpdateResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/update 'api_update' - User ID: {} Payload: {:?}\",\n\t\tuser.id, payload\n\t);\n\n\t// If password provided, hash it before update\n\tlet hashed_password: Option\u003cString\u003e = if let Some(pw) = \u0026payload.password {\n\t\tlet salt = SaltString::generate(\u0026mut OsRng);\n\t\tlet argon2 = Argon2::default();\n\t\tSome(\n\t\t\targon2\n\t\t\t\t.hash_password(pw.as_bytes(), \u0026salt)\n\t\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t\t.to_string(),\n\t\t)\n\t} else {\n\t\tNone\n\t};\n\n\tlet account = sqlx::query_as!(\n\t\tUpdateResponse,\n\t\tr#\"\n        UPDATE accounts SET\n            email = COALESCE($1, email),\n            first_name = COALESCE($2, first_name),\n            last_name = COALESCE($3, last_name),\n            password = COALESCE($4, password),\n            budget_preference = COALESCE($5, budget_preference),\n            risk_preference = COALESCE($6, risk_preference),\n            food_allergies = COALESCE($7, food_allergies),\n            disabilities = COALESCE($8, disabilities)\n        WHERE id = $9\n        RETURNING\n            email,\n            first_name,\n            last_name,\n            budget_preference as \"budget_preference: BudgetBucket\",\n            risk_preference as \"risk_preference: RiskTolerence\",\n            food_allergies,\n            disabilities\n        \"#,\n\t\tpayload.email,\n\t\tpayload.first_name,\n\t\tpayload.last_name,\n\t\thashed_password,\n\t\tpayload.budget_preference as Option\u003cBudgetBucket\u003e,\n\t\tpayload.risk_preference as Option\u003cRiskTolerence\u003e,\n\t\tpayload.food_allergies,\n\t\tpayload.disabilities,\n\t\tuser.id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(Json(account))\n}\n\n/// Logout by setting cookie to expired.\n///\n/// # Method\n/// `GET /api/account/logout`\n///\n/// # Responses\n/// - `200 OK` - with body: [UpdateResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/account/logout\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/logout\",\n\tsummary=\"Logout by returning with expired cookie\",\n\tdescription=\"Sets the HTTP-only cookie as expired, which deauthenticates the user.\",\n\tresponses(\n\t\t(status=200, description=\"Logged out successfully\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_logout\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/logout 'api_logout' - User ID: {}\",\n\t\tuser.id\n\t);\n\tset_cookie(user.id, true, cookies, \u0026key);\n\tOk(())\n}\n\n/// Create the account routes with authentication middleware.\n///\n/// # Routes\n/// ## Protected Routes (require authentication)\n/// - `POST /update` - Update user account information\n/// - `GET /current` - Get current user's account details\n/// - `POST /validate` - Validate authentication token\n/// - `GET /logout` - Logout by making cookie expired\n///\n/// ## Public Routes (no authentication required)\n/// - `POST /signup` - Create a new user account\n/// - `POST /login` - Authenticate user and set auth cookie\n///\n/// # Middleware\n/// Protected routes are secured by `middleware_auth` which validates the `auth-token` cookie.\n/// Public routes (signup/login) are accessible without authentication.\npub fn account_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/update\", post(api_update))\n\t\t.route(\"/current\", get(api_current))\n\t\t.route(\"/validate\", get(api_validate))\n\t\t.route(\n\t\t\t\"/logout\",\n\t\t\tget(|mut c, k, u| async move { api_logout::\u003cCookies\u003e(\u0026mut c, k, u).await }),\n\t\t)\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n\t\t.route(\n\t\t\t\"/signup\",\n\t\t\tpost(|mut c, k, p, b| async move { api_signup::\u003cCookies\u003e(\u0026mut c, k, p, b).await }),\n\t\t)\n\t\t.route(\n\t\t\t\"/login\",\n\t\t\tpost(|mut c, k, p, b| async move { api_login::\u003cCookies\u003e(\u0026mut c, k, p, b).await }),\n\t\t)\n}\n","traces":[{"line":69,"address":[18304231,18303984],"length":1,"stats":{"Line":1}},{"line":70,"address":[18304012,18304105],"length":1,"stats":{"Line":2}},{"line":86,"address":[18321584,18321566,18318480,18324664,18321560,18324670],"length":1,"stats":{"Line":2}},{"line":88,"address":[18321649,18318545],"length":1,"stats":{"Line":2}},{"line":89,"address":[18318607,18321711],"length":1,"stats":{"Line":2}},{"line":90,"address":[18321749,18318645],"length":1,"stats":{"Line":2}},{"line":94,"address":[18318685,18318863,18321789,18321967,18318951,18322055],"length":1,"stats":{"Line":6}},{"line":95,"address":[18321969,18318865],"length":1,"stats":{"Line":1}},{"line":97,"address":[18321797,18318693],"length":1,"stats":{"Line":2}},{"line":98,"address":[18321822,18318718],"length":1,"stats":{"Line":2}},{"line":100,"address":[18322087,18318983],"length":1,"stats":{"Line":2}},{"line":102,"address":[18322332,18322798,18319307,18319694,18319228,18322411],"length":1,"stats":{"Line":5}},{"line":109,"address":[18321250,18321164,18324268,18319657,18320998,18321415,18324354,18324102,18324519,18322761],"length":1,"stats":{"Line":10}},{"line":110,"address":[18321123,18324227,18321104,18324642,18321172,18324208,18324276,18321538],"length":1,"stats":{"Line":4}},{"line":112,"address":[18321274,18324378],"length":1,"stats":{"Line":2}},{"line":114,"address":[18321309,18324431,18324441,18321327,18321337,18324413],"length":1,"stats":{"Line":6}},{"line":115,"address":[18324433,18321329],"length":1,"stats":{"Line":0}},{"line":117,"address":[18321319,18324423],"length":1,"stats":{"Line":2}},{"line":119,"address":[18324472,18321368],"length":1,"stats":{"Line":2}},{"line":120,"address":[18324559,18321455],"length":1,"stats":{"Line":2}},{"line":124,"address":[18321509,18324613],"length":1,"stats":{"Line":2}},{"line":185,"address":[18327936,18328064],"length":1,"stats":{"Line":2}},{"line":191,"address":[18336555,18337107,18328797,18328651,18329203,18336701],"length":1,"stats":{"Line":5}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[18329171,18330454,18338358,18337075],"length":1,"stats":{"Line":4}},{"line":198,"address":[18330543,18338447],"length":1,"stats":{"Line":1}},{"line":202,"address":[18331635,18339126,18338713,18331412,18331357,18330677,18338643,18330739,18339261,18339316,18339539,18338581,18330809,18331222],"length":1,"stats":{"Line":6}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[18339200,18331296],"length":1,"stats":{"Line":2}},{"line":205,"address":[17460959,17460399],"length":1,"stats":{"Line":8}},{"line":207,"address":[18331750,18331873,18339654,18339777],"length":1,"stats":{"Line":4}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[18341466,18331887,18339791,18333562],"length":1,"stats":{"Line":2}},{"line":211,"address":[18331794,18339698],"length":1,"stats":{"Line":0}},{"line":212,"address":[18331855,18339759,18333691,18341595],"length":1,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[18339833,18331929],"length":1,"stats":{"Line":2}},{"line":221,"address":[18331959,18339863],"length":1,"stats":{"Line":2}},{"line":222,"address":[18333557,18331985,18332191,18332125,18339889,18340095,18340029,18341461],"length":1,"stats":{"Line":4}},{"line":223,"address":[18339906,18332002],"length":1,"stats":{"Line":2}},{"line":224,"address":[18344064,18344076,18344012,18340006,18332102,18344000,18332159,18340063],"length":1,"stats":{"Line":2}},{"line":228,"address":[18332362,18332477,18332547,18340266,18340381,18341198,18341439,18340451,18334139,18333294,18342043,18333535,18333477,18341381],"length":1,"stats":{"Line":6}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[18333365,18341269],"length":1,"stats":{"Line":2}},{"line":238,"address":[17460418,17460978],"length":1,"stats":{"Line":8}},{"line":240,"address":[18334201,18342105],"length":1,"stats":{"Line":2}},{"line":241,"address":[18342216,18334312],"length":1,"stats":{"Line":2}},{"line":242,"address":[18342230,18334326,18334775,18342679],"length":1,"stats":{"Line":3}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[18342639,18334735],"length":1,"stats":{"Line":2}},{"line":249,"address":[18343834,18335930],"length":1,"stats":{"Line":2}},{"line":251,"address":[18342142,18343872,18334238,18335968],"length":1,"stats":{"Line":0}},{"line":307,"address":[18349792,18349920],"length":1,"stats":{"Line":2}},{"line":313,"address":[18350409,18354966,18350955,18354841,18355387,18350534],"length":1,"stats":{"Line":5}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[18357208,18352237,18352641,18350908,18356669,18357480,18355340,18357073,18352170,18352828,18353048,18356602,18352776,18357260],"length":1,"stats":{"Line":6}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[18352715,18357147],"length":1,"stats":{"Line":2}},{"line":332,"address":[17459364,17459684],"length":1,"stats":{"Line":8}},{"line":334,"address":[18353190,18357622],"length":1,"stats":{"Line":2}},{"line":335,"address":[18357693,18353261],"length":1,"stats":{"Line":2}},{"line":337,"address":[18358924,18358401,18358976,18357757,18357832,18353969,18353325,18358912,18353400,18358988],"length":1,"stats":{"Line":4}},{"line":340,"address":[18353736,18358168],"length":1,"stats":{"Line":2}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[18358248,18358176,18353816,18353744],"length":1,"stats":{"Line":2}},{"line":346,"address":[18353783,18358215],"length":1,"stats":{"Line":1}},{"line":348,"address":[18353955,18358387],"length":1,"stats":{"Line":1}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[18354083,18357659,18358515,18353227],"length":1,"stats":{"Line":2}},{"line":385,"address":[18362336,18362500,18362470,18364169,18362383],"length":1,"stats":{"Line":4}},{"line":386,"address":[18362442,18363014,18362546],"length":1,"stats":{"Line":2}},{"line":390,"address":[18362936],"length":1,"stats":{"Line":1}},{"line":438,"address":[17631984],"length":1,"stats":{"Line":1}},{"line":442,"address":[18364690,18364816,18365237],"length":1,"stats":{"Line":3}},{"line":447,"address":[18367542,18366418,18367066,18366485,18367021,18367466,18366889,18367288,18365190],"length":1,"stats":{"Line":4}},{"line":463,"address":[18366963],"length":1,"stats":{"Line":1}},{"line":464,"address":[17549664],"length":1,"stats":{"Line":4}},{"line":465,"address":[18367510,18368112,18367443,18368124],"length":1,"stats":{"Line":1}},{"line":467,"address":[18367711],"length":1,"stats":{"Line":1}},{"line":543,"address":[17639344],"length":1,"stats":{"Line":1}},{"line":548,"address":[18371439,18371564,18372011],"length":1,"stats":{"Line":3}},{"line":554,"address":[18371938,18373422,18373478],"length":1,"stats":{"Line":3}},{"line":555,"address":[18373446],"length":1,"stats":{"Line":1}},{"line":556,"address":[18373483],"length":1,"stats":{"Line":1}},{"line":558,"address":[18373619,18373685,18374153],"length":1,"stats":{"Line":1}},{"line":559,"address":[18373510],"length":1,"stats":{"Line":1}},{"line":560,"address":[18376892,18373653,18376880,18373596],"length":1,"stats":{"Line":1}},{"line":561,"address":[18373822],"length":1,"stats":{"Line":1}},{"line":564,"address":[18373461],"length":1,"stats":{"Line":1}},{"line":567,"address":[18375456,18374056,18374027,18374250,18374180,18373902,18376098,18376174,18375917,18375691,18375639],"length":1,"stats":{"Line":6}},{"line":593,"address":[18374006],"length":1,"stats":{"Line":1}},{"line":594,"address":[18374035],"length":1,"stats":{"Line":1}},{"line":599,"address":[18375527],"length":1,"stats":{"Line":1}},{"line":600,"address":[18376045,18371497,18375753,18375672,18375624],"length":1,"stats":{"Line":4}},{"line":601,"address":[18376142,18376956,18376944,18376075],"length":1,"stats":{"Line":1}},{"line":603,"address":[18376343],"length":1,"stats":{"Line":1}},{"line":637,"address":[18382432],"length":1,"stats":{"Line":1}},{"line":642,"address":[18382773,18382877,18383288],"length":1,"stats":{"Line":2}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[18383251],"length":1,"stats":{"Line":1}},{"line":647,"address":[18384467],"length":1,"stats":{"Line":1}},{"line":666,"address":[17610075,17610100,17609104],"length":1,"stats":{"Line":1}},{"line":667,"address":[17609111,17609292,17609426,17609694,17609369,17609763,17609503,17609560,17609800,17609877,17609934,17610004,17609238,17609637],"length":1,"stats":{"Line":14}},{"line":668,"address":[17609297,17609251,17609197,17609190,17610171],"length":1,"stats":{"Line":3}},{"line":669,"address":[17609431,17609382,17609321,17610159,17609328],"length":1,"stats":{"Line":3}},{"line":670,"address":[17609462,17610147,17609455,17609516,17609565],"length":1,"stats":{"Line":3}},{"line":673,"address":[17609589],"length":1,"stats":{"Line":5}},{"line":675,"address":[17609715,17609722,17609776,17609805,17610123],"length":1,"stats":{"Line":3}},{"line":678,"address":[17609829],"length":1,"stats":{"Line":5}},{"line":682,"address":[17609963],"length":1,"stats":{"Line":5}}],"covered":95,"coverable":118},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","chat.rs"],"content":"use axum::{\n\tExtension, Json,\n\textract::Path,\n\trouting::{delete, get, post},\n};\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\nuse utoipa::OpenApi;\n\nuse crate::{\n\tcontrollers::{AxumRouter, itinerary::insert_event_list},\n\terror::{ApiResult, AppError},\n\tglobal::MESSAGE_PAGE_LEN,\n\thttp_models::{\n\t\tchat_session::{ChatsResponse, NewChatResponse},\n\t\tevent::Event,\n\t\titinerary::{EventDay, Itinerary},\n\t\tmessage::{\n\t\t\tMessage, MessagePageRequest, MessagePageResponse, SendMessageRequest,\n\t\t\tSendMessageResponse, UpdateMessageRequest,\n\t\t},\n\t},\n\tmiddleware::{AuthUser, middleware_auth},\n\tsql_models::message::{ChatSessionRow, MessageRow},\n\tswagger::SecurityAddon,\n};\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_chats,\n\t\tapi_new_chat,\n\t\tapi_message_page,\n\t\tapi_send_message,\n\t\tapi_update_message,\n\t\tapi_delete_chat\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity((\"set-cookie\"=[])),\n    info(\n    \ttitle=\"Chat Routes\",\n    \tdescription = \"API endpoints dealing with chatting and the home page.\"\n    ),\n    tags((name=\"Chat\"))\n)]\npub struct ChatApiDoc;\n\n/// Sends message and latest itinerary in chat session to llm, and waits for response.\n///\n/// When the bot replies, it's message and itinerary are inserted into the db.\n/// # Warning!\n/// Assumes the user's message has already been inserted into the db.\nasync fn send_message_to_llm(\n\ttext: \u0026str,\n\taccount_id: i32,\n\tchat_session_id: i32,\n\titinerary_id: Option\u003ci32\u003e,\n\tpool: \u0026PgPool,\n) -\u003e ApiResult\u003cMessage\u003e {\n\t// Give the LLM an itinerary for context\n\tlet itinerary_id = match itinerary_id {\n\t\tSome(id) =\u003e Some(id), //use the provided itinerary\n\t\tNone =\u003e {\n\t\t\t//use the latest itinerary from the chat session\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tSELECT m.itinerary_id\n\t\t\t\tFROM messages m\n\t\t\t\tINNER JOIN chat_sessions c\n\t\t\t\tON m.chat_session_id=c.id\n\t\t\t\tWHERE\n\t\t\t\t\tc.account_id=$1 AND\n\t\t\t\t\tc.id=$2 AND\n\t\t\t\t\tm.itinerary_id IS NOT NULL\n\t\t\t\tORDER BY m.timestamp DESC\n\t\t\t\tLIMIT 1;\n\t\t\t\t\"#,\n\t\t\t\taccount_id,\n\t\t\t\tchat_session_id\n\t\t\t)\n\t\t\t.fetch_optional(pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.map(|record| record.itinerary_id.unwrap())\n\t\t}\n\t};\n\tlet context_itinerary = match itinerary_id {\n\t\tSome(id) =\u003e Some(\n\t\t\tcrate::controllers::itinerary::api_get_itinerary(\n\t\t\t\tExtension(AuthUser { id: account_id }),\n\t\t\t\taxum::extract::Path(id),\n\t\t\t\tExtension(pool.clone()),\n\t\t\t)\n\t\t\t.await?,\n\t\t),\n\t\tNone =\u003e None,\n\t};\n\n\t// TODO: this is where the LLM call will be.\n\t// It should generate an itinerary, insert it into the db, and give some text.\n\t// Fow now we just make a temporary message.\n\tlet ai_text = \"Bot reply\";\n\tlet mut ai_itinerary = Itinerary {\n\t\tid: 0,\n\t\tstart_date: NaiveDate::parse_from_str(\"2025-11-05\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2025-11-06\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![\n\t\t\tEventDay {\n\t\t\t\tmorning_events: vec![Event {\n\t\t\t\t\tid: 1,\n\t\t\t\t\tstreet_address: String::from(\"1114 Shannon Ln\"),\n\t\t\t\t\tpostal_code: 17013,\n\t\t\t\t\tcity: String::from(\"Carlisle\"),\n\t\t\t\t\tevent_type: String::from(\"Hike\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"A beautiful stroll along a river in this cute small town.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Family Walking Path\"),\n\t\t\t\t}],\n\t\t\t\tnoon_events: vec![Event {\n\t\t\t\t\tid: 2,\n\t\t\t\t\tstreet_address: String::from(\"35 Campus Court\"),\n\t\t\t\t\tpostal_code: 12601,\n\t\t\t\t\tcity: String::from(\"Poughkeepsie\"),\n\t\t\t\t\tevent_type: String::from(\"Restaurant\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Local Italian restaurant known for its authentic pasta and upscale dining.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Cosimos\"),\n\t\t\t\t}],\n\t\t\t\tafternoon_events: vec![Event {\n\t\t\t\t\tid: 3,\n\t\t\t\t\tstreet_address: String::from(\"200 E 42nd St\"),\n\t\t\t\t\tpostal_code: 10017,\n\t\t\t\t\tcity: String::from(\"New York\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"World famous art museum with a focus on modern works, including Starry Starry Night by VanGough.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Museum of Modern Art- MoMA\"),\n\t\t\t\t}],\n\t\t\t\tevening_events: vec![Event {\n\t\t\t\t\tid: 4,\n\t\t\t\t\tstreet_address: String::from(\"1 S Broad St\"),\n\t\t\t\t\tpostal_code: 19107,\n\t\t\t\t\tcity: String::from(\"Philadelphia\"),\n\t\t\t\t\tevent_type: String::from(\"Concert\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Music center which hosts local and national bands.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Jazz night at Broad Street\"),\n\t\t\t\t}],\n\t\t\t\tdate: NaiveDate::parse_from_str(\"2025-11-05\", \"%Y-%m-%d\").unwrap(),\n\t\t\t},\n\t\t\tEventDay {\n\t\t\t\tmorning_events: vec![Event {\n\t\t\t\t\tid: 5,\n\t\t\t\t\tstreet_address: String::from(\"1 Citizens Bank Way\"),\n\t\t\t\t\tpostal_code: 19148,\n\t\t\t\t\tcity: String::from(\"Philadelphia\"),\n\t\t\t\t\tevent_type: String::from(\"Sports\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"A Phillies baseball game is a must-do for locals and visitors alike.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Phillies Baseball Game\"),\n\t\t\t\t}],\n\t\t\t\tnoon_events: vec![Event {\n\t\t\t\t\tid: 6,\n\t\t\t\t\tstreet_address: String::from(\"5250 S Park Dr\"),\n\t\t\t\t\tpostal_code: 60615,\n\t\t\t\t\tcity: String::from(\"Chicago\"),\n\t\t\t\t\tevent_type: String::from(\"Festival\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Annual music festival with the biggest names in pop and indie scenes.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"LollaPalooza\"),\n\t\t\t\t}],\n\t\t\t\tafternoon_events: vec![Event {\n\t\t\t\t\tid: 7,\n\t\t\t\t\tstreet_address: String::from(\"1 Rue de la Seine\"),\n\t\t\t\t\tpostal_code: 0,\n\t\t\t\t\tcity: String::from(\"Paris\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\"Explore the beautiful landmark of Paris.\"),\n\t\t\t\t\tevent_name: String::from(\"Eiffel Tower\"),\n\t\t\t\t}],\n\t\t\t\tevening_events: vec![Event {\n\t\t\t\t\tid: 8,\n\t\t\t\t\tstreet_address: String::from(\"3 Rue de la Museu\"),\n\t\t\t\t\tpostal_code: 0,\n\t\t\t\t\tcity: String::from(\"Paris\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Wander the halls of the world famous art museum.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"le Louvre\"),\n\t\t\t\t}],\n\t\t\t\tdate: NaiveDate::parse_from_str(\"2025-11-06\", \"%Y-%m-%d\").unwrap(),\n\t\t\t},\n\t\t],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"World Tour 11/5-15 2025\"),\n\t};\n\n\t// insert generated itinerary into db\n\tlet itinerary_id = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO itineraries (account_id, is_public, start_date, end_date, chat_session_id, saved, title)\n\t\tVALUES ($1, FALSE, $2, $3, $4, TRUE, $5)\n\t\tRETURNING id;\n\t\t\"#,\n\t\taccount_id,\n\t\tai_itinerary.start_date,\n\t\tai_itinerary.end_date,\n\t\tchat_session_id,\n\t\tai_itinerary.title\n\t)\n\t.fetch_one(pool)\n\t.await\n\t.map_err(|e| {\n\t\tAppError::from(e)\n\t})?\n\t.id;\n\n\tai_itinerary.id = itinerary_id;\n\n\t// insert itinerary events\n\tinsert_event_list(ai_itinerary, pool).await?;\n\n\t// insert bot message into db\n\tlet record = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO messages (chat_session_id, itinerary_id, is_user, timestamp, text)\n\t\tVALUES ($1, $2, FALSE, NOW(), $3)\n\t\tRETURNING id, timestamp;\n\t\t\"#,\n\t\tchat_session_id,\n\t\titinerary_id,\n\t\tai_text\n\t)\n\t.fetch_one(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet (bot_message_id, timestamp) = (record.id, record.timestamp);\n\n\tOk(Message {\n\t\tid: bot_message_id,\n\t\tis_user: false,\n\t\ttimestamp,\n\t\ttext: String::from(ai_text),\n\t\titinerary_id: Some(itinerary_id),\n\t})\n}\n\n/// Fetch all the chat session ids belonging to the user to made the request\n///\n/// # Method\n/// `GET /api/chat/chats`\n///\n/// # Responses\n/// - `200 OK` - [ChatsResponse] - list of chat session ids\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/chat/chats\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/chats\",\n\tsummary=\"Fetch user's chat session IDs\",\n\tdescription=\"Fetches a list of all chat session IDs belonging to the user.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Successfully retrieved chat sessions\",\n\t\t\tbody=ChatsResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"chat_sessions\": [3, 15, 16, 84]\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_chats(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cChatsResponse\u003e\u003e {\n\tOk(Json(ChatsResponse {\n\t\tchat_sessions: sqlx::query!(\n\t\t\tr#\"\n\t\t\tSELECT id from chat_sessions\n\t\t\tWHERE account_id=$1;\n\t\t\t\"#,\n\t\t\tuser.id\n\t\t)\n\t\t.fetch_all(\u0026pool)\n\t\t.await\n\t\t.map_err(|e| AppError::from(e))?\n\t\t.into_iter()\n\t\t.map(|record| ChatSessionRow {\n\t\t\tid: record.id,\n\t\t\ttitle: String::from(\"TODO: get chat title from db\"),\n\t\t})\n\t\t.collect(),\n\t}))\n}\n\n/// Get a page of messages from this chat session belonging to the user who made the request\n///\n/// # Method\n/// `POST /api/chat/messagePage`\n///\n/// # Request Body\n/// - [MessagePageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [MessagePageResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// Fetch latest massages\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/messagePage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 3\n///       }'\n/// ```\n/// Fetch messages ending with specific message\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/messagePage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 3,\n///         \"message_id\": 6\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/messagePage\",\n\tsummary=\"Fetch a page of messages from a chat session\",\n\tdescription=\"If no message id is provided, this fetches the latest messages from the chat session. If a message id is provided, that message and messages preceeding it will be fetched.\",\n\trequest_body(\n\t\tcontent=MessagePageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Message id may be omitted to get the latest messages\",\n\t\texamples(\n\t\t\t(\"Latest Messages\"=(\n\t\t\t\tsummary=\"Fetch the latest messages from a chat session\",\n\t\t\t\tvalue=json!({\n\t\t\t\t\t\"chat_session_id\": 4\n\t\t\t\t})\n\t\t\t)),\n\t\t\t(\"Specific Messages\"=(\n\t\t\t\tsummary=\"Fetch a specific page of messages from a chat session\",\n\t\t\t\tvalue=json!({\n\t\t\t\t\t\"chat_session_id\": 4,\n\t\t\t\t\t\"message_id\": 4\n\t\t\t\t})\n\t\t\t))\n\t\t)\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Messages retrieved successfully\",\n\t\t\tbody=MessagePageResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texamples(\n\t\t\t\t(\"Latest Messages\"=(\n\t\t\t\t\tsummary=\"The latest messages from a chat session\",\n\t\t\t\t\tvalue=json!({\n\t\t\t\t\t\t\"message_page\": [\n\t\t\t\t\t\t\t{\"id\": 6, \"is_user\": true, \"timestamp\": \"2025-10-14 11-34-19\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 10, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-24\", \"text\": \"Bot reply\", \"itinerary_id\": 2},\n\t\t\t\t\t\t\t{\"id\": 12, \"is_user\": true, \"timestamp\": \"2025-10-14 11-34-42\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 22, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-56\", \"text\": \"Bot reply\", \"itinerary_id\": 5},\n\t\t\t\t\t\t\t{\"id\": 26, \"is_user\": true, \"timestamp\": \"2025-10-14 11-35-10\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 33, \"is_user\": false, \"timestamp\": \"2025-10-14 11-35-19\", \"text\": \"Bot reply\", \"itinerary_id\": 9},\n\t\t\t\t\t\t\t{\"id\": 39, \"is_user\": true, \"timestamp\": \"2025-10-14 11-35-31\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 44, \"is_user\": false, \"timestamp\": \"2025-10-14 11-35-54\", \"text\": \"Bot reply\", \"itinerary_id\": 14},\n\t\t\t\t\t\t\t{\"id\": 61, \"is_user\": true, \"timestamp\": \"2025-10-14 11-36-24\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 72, \"is_user\": false, \"timestamp\": \"2025-10-14 11-36-29\", \"text\": \"Bot reply\", \"itinerary_id\": 27}\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"prev_message_id\": 4\n\t\t\t\t\t})\n\t\t\t\t)),\n\t\t\t\t(\"Specific Messages\"=(\n\t\t\t\t\tsummary=\"A specific page of messages from a chat session\",\n\t\t\t\t\tvalue=json!({\n\t\t\t\t\t\t\"message_page\": [\n\t\t\t\t\t\t\t{\"id\": 1, \"is_user\": true, \"timestamp\": \"2025-10-14 11-33-21\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 2, \"is_user\": false, \"timestamp\": \"2025-10-14 11-33-35\", \"text\": \"Bot reply\", \"itinerary_id\": 1},\n\t\t\t\t\t\t\t{\"id\": 3, \"is_user\": true, \"timestamp\": \"2025-10-14 11-33-45\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 4, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-01\", \"text\": \"Bot reply\", \"itinerary_id\": 1},\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"prev_message_id\": null\n\t\t\t\t\t})\n\t\t\t\t))\n\t\t\t)\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_message_page(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(MessagePageRequest {\n\t\tchat_session_id,\n\t\tmessage_id,\n\t}): Json\u003cMessagePageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cMessagePageResponse\u003e\u003e {\n\tlet mut message_page: Vec\u003cMessage\u003e = sqlx::query_as!(\n\t\tMessageRow,\n\t\tr#\"\n\t\tSELECT\n\t\t\tm.id,\n\t\t\tm.chat_session_id,\n\t\t\tm.itinerary_id,\n\t\t\tm.is_user,\n\t\t\tm.timestamp,\n\t\t\tm.text\n\t\tFROM messages m\n\t\tINNER JOIN chat_sessions c\n\t\tON m.chat_session_id=c.id\n\t\tWHERE\n\t\t\tc.id=$1 AND\n\t\t\tc.account_id=$2 AND\n\t\t\t(\n\t\t\t\t$3::int IS NULL OR\n\t\t\t\tm.timestamp \u003c= (SELECT timestamp FROM messages WHERE id=$3)\n\t\t\t)\n\t\tORDER BY m.timestamp DESC\n\t\tLIMIT $4 + 1;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id,\n\t\tmessage_id,\n\t\tMESSAGE_PAGE_LEN\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.into_iter()\n\t.rev()\n\t.map(|msg_row| Message {\n\t\tid: msg_row.id,\n\t\tis_user: msg_row.is_user,\n\t\ttimestamp: msg_row.timestamp,\n\t\ttext: msg_row.text,\n\t\titinerary_id: msg_row.itinerary_id,\n\t})\n\t.collect();\n\n\tlet prev_message_id = if message_page.len() == MESSAGE_PAGE_LEN as usize + 1 {\n\t\t// there might be a better way to do this, but it should work, and it's only O(MESSAGE_PAGE_LEN) time complexity\n\t\tSome(message_page.remove(0).id)\n\t} else {\n\t\tNone\n\t};\n\n\tOk(Json(MessagePageResponse {\n\t\tmessage_page,\n\t\tprev_message_id,\n\t}))\n}\n\n/// Update an existing message with new text, and get a message back from the LLM\n///\n/// # Method\n/// `POST /api/chat/updateMessage`\n///\n/// # Request Body\n/// - [UpdateMessageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [Message] - message from LLM\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided message id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/updateMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"message_id\": 3,\n///         \"new_text\": \"Updated message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/updateMessage\",\n\tsummary=\"Update the text of a message and wait for a reply from the LLM\",\n\tdescription=\"Updating a message deletes all proceeding messages, updates the text of the given message, and returns a response from the LLM.\",\n\trequest_body(\n\t\tcontent=UpdateMessageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Itinerary id is optional and is used to give context to the LLM.\",\n\t\texample=json!({\n\t\t\t\"message_id\": 41,\n\t\t\t\"new_text\": \"Updated message content\",\n\t\t\t\"itinerary_id\": 17\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Message updated, and LLM replied successfully\",\n\t\t\tbody=Message,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"id\": 43,\n\t\t\t\t\"is_user\": false,\n\t\t\t\t\"timestamp\": \"2025-10-14 11-38-52\",\n\t\t\t\t\"text\": \"Bot reply\",\n\t\t\t\t\"itinerary_id\": 19\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Message not found in this chat session for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_update_message(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(UpdateMessageRequest {\n\t\tmessage_id,\n\t\tnew_text,\n\t\titinerary_id,\n\t}): Json\u003cUpdateMessageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cMessage\u003e\u003e {\n\tif new_text.is_empty() {\n\t\treturn Err(AppError::BadRequest(String::from(\"Text cannot be empty\")));\n\t}\n\n\t// verify the message id belongs to this user\n\tsqlx::query!(\n\t\tr#\"\n\t\tSELECT m.id\n\t\tFROM messages m\n\t\tINNER JOIN chat_sessions c\n\t\tON m.chat_session_id=c.id\n\t\tWHERE m.id=$1 AND c.account_id=$2 AND m.is_user=TRUE;\n\t\t\"#,\n\t\tmessage_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\t// delete future messages\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM messages\n\t\tWHERE timestamp \u003e (\n\t\t\tSELECT timestamp\n\t\t\tFROM messages\n\t\t\tWHERE id=$1\n\t\t);\n\t\t\"#,\n\t\tmessage_id\n\t)\n\t.execute(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\t// update user message\n\tlet chat_session_id = sqlx::query!(\n\t\tr#\"\n\t\tUPDATE messages\n\t\tSET text=$1, timestamp=NOW()\n\t\tWHERE is_user=TRUE AND id=$2\n\t\tRETURNING chat_session_id;\n\t\t\"#,\n\t\tnew_text,\n\t\tmessage_id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.chat_session_id;\n\n\t// call llm and insert bot response into db\n\tlet bot_message = send_message_to_llm(\n\t\tnew_text.as_str(),\n\t\tuser.id,\n\t\tchat_session_id,\n\t\titinerary_id,\n\t\t\u0026pool,\n\t)\n\t.await?;\n\n\tOk(Json(bot_message))\n}\n\n/// Send a new message, and get a message back from the LLM\n///\n/// # Method\n/// `POST /api/chat/sendMessage`\n///\n/// # Request Body\n/// - [SendMessageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [SendMessageResponse] - contains message from LLM\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided chat session id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/sendMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 6,\n///         \"text\": \"New message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/sendMessage\",\n\tsummary=\"Send a message and wait for a reply from the LLM\",\n\tdescription=\"Ask the LLM to generate an itinerary and it should respond with one.\",\n\trequest_body(\n\t\tcontent=SendMessageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Itinerary id is optional and is used to give context to the LLM.\",\n\t\texample=json!({\n\t\t\t\"chat_session_id\": 12,\n\t\t\t\"text\": \"Make an itinerary\",\n\t\t\t\"itinerary_id\": 13\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Message sent, and LLM replied successfully\",\n\t\t\tbody=SendMessageResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"user_message_id\": 52,\n\t\t\t\t\"bot_message\": {\n\t\t\t\t\t\"id\": 53,\n\t\t\t\t\t\"is_user\": false,\n\t\t\t\t\t\"timestamp\": \"2025-10-14 11-39-10\",\n\t\t\t\t\t\"text\": \"Bot reply\",\n\t\t\t\t\t\"itinerary_id\": 14\n\t\t\t\t}\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Chat session not found for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_send_message(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(SendMessageRequest {\n\t\tchat_session_id,\n\t\ttext,\n\t\titinerary_id,\n\t}): Json\u003cSendMessageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cSendMessageResponse\u003e\u003e {\n\tif text.is_empty() {\n\t\treturn Err(AppError::BadRequest(String::from(\"Text cannot be empty\")));\n\t}\n\n\t// verify the given chat session belongs to this user\n\tsqlx::query!(\n\t\tr#\"\n\t\tSELECT id FROM chat_sessions\n\t\tWHERE id=$1 AND account_id=$2;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\t// insert user message into db\n\tlet user_message_id = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO messages (chat_session_id, itinerary_id, is_user, timestamp, text)\n\t\tVALUES ($1, NULL, TRUE, NOW(), $2)\n\t\tRETURNING id;\n\t\t\"#,\n\t\tchat_session_id,\n\t\ttext\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.id;\n\n\t// call llm and insert bot response into db\n\tlet bot_message =\n\t\tsend_message_to_llm(text.as_str(), user.id, chat_session_id, itinerary_id, \u0026pool).await?;\n\n\tOk(Json(SendMessageResponse {\n\t\tuser_message_id,\n\t\tbot_message,\n\t}))\n}\n\n/// Get an empty chat session id belonging to this user, or create one if one doesn't exist\n///\n/// # Method\n/// `GET /api/chat/newChat`\n///\n/// # Responses\n/// - `200 OK` - with body: [NewChatResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/sendMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 6,\n///         \"text\": \"New message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/newChat\",\n\tsummary=\"Get the chat session id for an empty chat\",\n\tdescription=\"Creates a new empty chat session for this user if one doesn't already exist, and returns its chat session id.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"New chat session retrieved successfully\",\n\t\t\tbody=NewChatResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"chat_session_id\": 13\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_new_chat(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cNewChatResponse\u003e\u003e {\n\t// check to see if there's already an empty chat session before making a new one\n\tlet chat_sessions = sqlx::query!(\n\t\tr#\"\n\t\tSELECT c.id\n\t\tFROM chat_sessions c\n\t\tWHERE\n\t\t\tc.account_id=$1\n\t\t\tAND NOT EXISTS (\n\t\t\t\tSELECT 1\n\t\t\t\tFROM messages m\n\t\t\t\tWHERE m.chat_session_id=c.id\n\t\t\t);\n\t\t\"#,\n\t\tuser.id\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet chat_session_id = match chat_sessions.first() {\n\t\tSome(record) =\u003e record.id,\n\t\tNone =\u003e {\n\t\t\t// make a new chat session\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tINSERT INTO chat_sessions (account_id)\n\t\t\t\tVALUES ($1)\n\t\t\t\tRETURNING id\n\t\t\t\t\"#,\n\t\t\t\tuser.id\n\t\t\t)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.id\n\t\t}\n\t};\n\n\tOk(Json(NewChatResponse { chat_session_id }))\n}\n\n/// Delete the chat session with the given ID\n///\n/// # Method\n/// `DELETE /api/chat/:id`\n///\n/// # Responses\n/// - `200 OK` - chat session and associated messages and unsaved itineraries successfully deleted\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided chat session id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X DELETE http://localhost:3001/api/chat/7\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tdelete,\n\tpath=\"/{id}\",\n\tsummary=\"Delete the given chat session\",\n\tdescription=\"Deletes a chat session and its associated messages and unsaved, private itineraries if it belongs to the user making the request.\",\n\tresponses(\n\t\t(status=200, description=\"Chat session and associated messages and unsaved, private itineraries deleted successfully\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Chat session not found for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be DELETE\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_delete_chat(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tPath(chat_session_id): Path\u003ci32\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\t// itineraries do not cascade, so we delete manually\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM itineraries\n\t\tWHERE\n\t\t\tchat_session_id=$1 AND\n\t\t\taccount_id=$2 AND\n\t\t\tis_public=FALSE AND\n\t\t\tsaved=FALSE;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\t// messages will cascade\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM chat_sessions\n\t\tWHERE id=$1 AND account_id=$2\n\t\tRETURNING id;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\tOk(())\n}\n\n/// Create the chat routes with authentication middleware.\n///\n/// # Routes\n/// - `GET /chats` - Get metadata for all the user's chat sessions (protected)\n/// - `POST /messagePage` - Gets a page of messages in the session, ending with message_id or the latest message (protected)\n/// - `POST /updateMessage` - Updates a user's message and waits for a bot reply (protected)\n/// - `POST /sendMessage` - Sends a user's message and waits for a bot reply (protected)\n/// - `GET /newChat` - Gets a chat session id for an empty chat (protected)\n/// - `DELETE /:id` - Delete a chat session and associated messages (protected)\n///\n/// # Middleware\n/// All routes are protected by `middleware_auth` which validates the `auth-token` cookie.\npub fn chat_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/chats\", get(api_chats))\n\t\t.route(\"/messagePage\", post(api_message_page))\n\t\t.route(\"/updateMessage\", post(api_update_message))\n\t\t.route(\"/sendMessage\", post(api_send_message))\n\t\t.route(\"/newChat\", get(api_new_chat))\n\t\t.route(\"/{id}\", delete(api_delete_chat))\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n}\n","traces":[{"line":53,"address":[17662624],"length":1,"stats":{"Line":1}},{"line":61,"address":[18810992],"length":1,"stats":{"Line":1}},{"line":62,"address":[18811143],"length":1,"stats":{"Line":0}},{"line":65,"address":[18812430,18812895,18811842,18812021,18812329,18812593,18812076,18811188,18811251,18812497,18811321],"length":1,"stats":{"Line":5}},{"line":81,"address":[18811913],"length":1,"stats":{"Line":1}},{"line":82,"address":[17444820],"length":1,"stats":{"Line":4}},{"line":83,"address":[18812407,18826364,18812465,18826352],"length":1,"stats":{"Line":1}},{"line":84,"address":[18826384,18826396,18812558],"length":1,"stats":{"Line":3}},{"line":87,"address":[18812104],"length":1,"stats":{"Line":1}},{"line":89,"address":[18813315,18823614,18813239,18813129,18812802,18812840],"length":1,"stats":{"Line":4}},{"line":90,"address":[18812641],"length":1,"stats":{"Line":1}},{"line":92,"address":[18812654],"length":1,"stats":{"Line":1}},{"line":94,"address":[18812825,18812873,18813283,18813209,18812962,18811067],"length":1,"stats":{"Line":4}},{"line":96,"address":[18812685],"length":1,"stats":{"Line":1}},{"line":102,"address":[18812707],"length":1,"stats":{"Line":1}},{"line":105,"address":[18813468,18812726],"length":1,"stats":{"Line":2}},{"line":106,"address":[18813537],"length":1,"stats":{"Line":1}},{"line":107,"address":[18813731,18823609,18817657,18823477,18823532,18821614,18813667,18823584],"length":1,"stats":{"Line":2}},{"line":202,"address":[18821925],"length":1,"stats":{"Line":1}},{"line":206,"address":[18822166,18823170,18823402,18823347,18823791,18823892,18824224,18822254,18822324,18823959],"length":1,"stats":{"Line":4}},{"line":218,"address":[18823241],"length":1,"stats":{"Line":1}},{"line":219,"address":[18823380,18823627,18823839,18811088,18823332],"length":1,"stats":{"Line":4}},{"line":220,"address":[18823869,18826416],"length":1,"stats":{"Line":1}},{"line":221,"address":[18826428],"length":1,"stats":{"Line":0}},{"line":225,"address":[18824020],"length":1,"stats":{"Line":1}},{"line":228,"address":[17444883],"length":1,"stats":{"Line":2}},{"line":231,"address":[18824585,18824663,18824727,18825799,18825499,18825866,18826266,18825315,18825698,18825447],"length":1,"stats":{"Line":4}},{"line":241,"address":[18825389],"length":1,"stats":{"Line":1}},{"line":242,"address":[17444905],"length":1,"stats":{"Line":4}},{"line":243,"address":[18825776,18826460,18825834,18826448],"length":1,"stats":{"Line":1}},{"line":245,"address":[18825923],"length":1,"stats":{"Line":1}},{"line":247,"address":[18826086],"length":1,"stats":{"Line":1}},{"line":251,"address":[18826045],"length":1,"stats":{"Line":1}},{"line":252,"address":[18826080],"length":1,"stats":{"Line":1}},{"line":295,"address":[17673344],"length":1,"stats":{"Line":1}},{"line":299,"address":[18832309],"length":1,"stats":{"Line":1}},{"line":300,"address":[18831127,18832005,18831803,18831191,18831592,18831760,18832170,18832103,18831064],"length":1,"stats":{"Line":4}},{"line":307,"address":[18831660],"length":1,"stats":{"Line":1}},{"line":308,"address":[18831114,18831862,18832053,18831748,18831787],"length":1,"stats":{"Line":4}},{"line":309,"address":[18832560,18832080,18832572,18832138],"length":1,"stats":{"Line":1}},{"line":310,"address":[18832251],"length":1,"stats":{"Line":1}},{"line":311,"address":[18832655,18832592,18832274],"length":1,"stats":{"Line":3}},{"line":313,"address":[18832619],"length":1,"stats":{"Line":1}},{"line":315,"address":[18832297],"length":1,"stats":{"Line":1}},{"line":424,"address":[17699184],"length":1,"stats":{"Line":1}},{"line":432,"address":[18834974,18834876,18833766,18833608,18833702,18835041,18834444,18834659,18834613],"length":1,"stats":{"Line":4}},{"line":460,"address":[18834531],"length":1,"stats":{"Line":1}},{"line":461,"address":[18833689,18834924,18834721,18834643,18834598],"length":1,"stats":{"Line":4}},{"line":462,"address":[18834951,18835728,18835740,18835009],"length":1,"stats":{"Line":1}},{"line":465,"address":[18835168,18835760,18835827],"length":1,"stats":{"Line":3}},{"line":466,"address":[18835771],"length":1,"stats":{"Line":1}},{"line":467,"address":[18835775],"length":1,"stats":{"Line":1}},{"line":468,"address":[18835779],"length":1,"stats":{"Line":1}},{"line":469,"address":[18835795],"length":1,"stats":{"Line":1}},{"line":470,"address":[18835821],"length":1,"stats":{"Line":1}},{"line":474,"address":[18835258,18835206,18835326],"length":1,"stats":{"Line":3}},{"line":476,"address":[18835328,18835552],"length":1,"stats":{"Line":2}},{"line":478,"address":[18835315],"length":1,"stats":{"Line":1}},{"line":481,"address":[18835419],"length":1,"stats":{"Line":1}},{"line":482,"address":[18835373],"length":1,"stats":{"Line":1}},{"line":483,"address":[18835405],"length":1,"stats":{"Line":1}},{"line":551,"address":[17706672],"length":1,"stats":{"Line":1}},{"line":560,"address":[18839049,18839227],"length":1,"stats":{"Line":2}},{"line":561,"address":[18839299,18840132],"length":1,"stats":{"Line":2}},{"line":565,"address":[18839920,18840593,18840495,18840772,18840839,18841578,18840052,18840660,18839399,18839241,18839329,18840104],"length":1,"stats":{"Line":7}},{"line":576,"address":[18839994],"length":1,"stats":{"Line":1}},{"line":577,"address":[17443737],"length":1,"stats":{"Line":4}},{"line":578,"address":[18840570,18844144,18844156,18840628],"length":1,"stats":{"Line":1}},{"line":579,"address":[17443908,17443880],"length":1,"stats":{"Line":2}},{"line":582,"address":[18840894,18841852,18842787,18841556,18841401,18840996,18841919,18841754,18841510,18840929],"length":1,"stats":{"Line":4}},{"line":593,"address":[18841452],"length":1,"stats":{"Line":1}},{"line":594,"address":[17443755],"length":1,"stats":{"Line":4}},{"line":595,"address":[18841887,18841829,18844188,18844176],"length":1,"stats":{"Line":1}},{"line":598,"address":[18842587,18841976,18842092,18842719,18842028,18843350,18843123,18842958,18843056,18842765],"length":1,"stats":{"Line":4}},{"line":608,"address":[18842661],"length":1,"stats":{"Line":1}},{"line":609,"address":[17443773],"length":1,"stats":{"Line":4}},{"line":610,"address":[18843091,18843033,18844220,18844208],"length":1,"stats":{"Line":1}},{"line":615,"address":[18843189],"length":1,"stats":{"Line":1}},{"line":616,"address":[18843233],"length":1,"stats":{"Line":1}},{"line":618,"address":[18843237],"length":1,"stats":{"Line":1}},{"line":619,"address":[18843245],"length":1,"stats":{"Line":1}},{"line":621,"address":[18843656,18843289,18839159,18843334,18843363,18843585],"length":1,"stats":{"Line":4}},{"line":623,"address":[18843793],"length":1,"stats":{"Line":1}},{"line":693,"address":[17714928],"length":1,"stats":{"Line":1}},{"line":702,"address":[18846705,18846862],"length":1,"stats":{"Line":2}},{"line":703,"address":[18846934,18847752],"length":1,"stats":{"Line":2}},{"line":707,"address":[18846964,18848210,18848277,18848389,18848112,18847675,18846876,18847543,18847034,18849322,18847724,18848456],"length":1,"stats":{"Line":7}},{"line":715,"address":[18847617],"length":1,"stats":{"Line":1}},{"line":716,"address":[18848160,18846752,18847660,18847705,18847954],"length":1,"stats":{"Line":4}},{"line":717,"address":[18850752,18848245,18850764,18848187],"length":1,"stats":{"Line":1}},{"line":718,"address":[17552118,17552146],"length":1,"stats":{"Line":2}},{"line":721,"address":[18849596,18849881,18849498,18849254,18848511,18849663,18849300,18848627,18848563,18849122],"length":1,"stats":{"Line":4}},{"line":730,"address":[18849196],"length":1,"stats":{"Line":1}},{"line":731,"address":[18849340,18846773,18849239,18849284,18849546],"length":1,"stats":{"Line":4}},{"line":732,"address":[18850784,18849631,18850796,18849573],"length":1,"stats":{"Line":1}},{"line":736,"address":[17552029],"length":1,"stats":{"Line":2}},{"line":739,"address":[18850327],"length":1,"stats":{"Line":1}},{"line":740,"address":[18850324],"length":1,"stats":{"Line":1}},{"line":790,"address":[17719024],"length":1,"stats":{"Line":1}},{"line":795,"address":[18853610,18853907,18854970,18852853,18853567,18853809,18853974,18852934,18852998,18853399],"length":1,"stats":{"Line":4}},{"line":809,"address":[18853467],"length":1,"stats":{"Line":1}},{"line":810,"address":[17547224],"length":1,"stats":{"Line":4}},{"line":811,"address":[18855532,18853942,18853884,18855520],"length":1,"stats":{"Line":1}},{"line":813,"address":[18854075,18854143],"length":1,"stats":{"Line":2}},{"line":814,"address":[18854199],"length":1,"stats":{"Line":1}},{"line":817,"address":[18854330,18854858,18854903,18854266,18854234,18855139,18855304,18854732,18855237],"length":1,"stats":{"Line":4}},{"line":825,"address":[18854803],"length":1,"stats":{"Line":1}},{"line":826,"address":[17547240],"length":1,"stats":{"Line":4}},{"line":827,"address":[18855272,18855564,18855552,18855214],"length":1,"stats":{"Line":1}},{"line":828,"address":[18855358],"length":1,"stats":{"Line":1}},{"line":832,"address":[18854930],"length":1,"stats":{"Line":1}},{"line":869,"address":[17722288],"length":1,"stats":{"Line":1}},{"line":875,"address":[18858320,18858244,18859351,18857056,18857209,18857145,18857700,18857854,18857900,18858114],"length":1,"stats":{"Line":4}},{"line":887,"address":[18857748],"length":1,"stats":{"Line":1}},{"line":888,"address":[17550952],"length":1,"stats":{"Line":4}},{"line":889,"address":[17551041,17551013],"length":1,"stats":{"Line":2}},{"line":892,"address":[18859816,18859151,18858592,18858656,18859704,18859539,18859883,18859329,18858540,18859283,18859637,18860095],"length":1,"stats":{"Line":5}},{"line":901,"address":[18859225],"length":1,"stats":{"Line":1}},{"line":902,"address":[17550968],"length":1,"stats":{"Line":4}},{"line":903,"address":[18860144,18859672,18859614,18860156],"length":1,"stats":{"Line":1}},{"line":904,"address":[17551119,17551091],"length":1,"stats":{"Line":1}},{"line":906,"address":[18859938],"length":1,"stats":{"Line":1}},{"line":921,"address":[17663691,17663716,17662720],"length":1,"stats":{"Line":1}},{"line":922,"address":[17663578,17663119,17663176,17663387,17662854,17663253,17662727,17662985,17663444,17663521,17662908,17663310,17663042,17663640],"length":1,"stats":{"Line":14}},{"line":923,"address":[17662806,17662813,17662913,17663787,17662867],"length":1,"stats":{"Line":3}},{"line":924,"address":[17662937,17663775,17662944,17663047,17662998],"length":1,"stats":{"Line":3}},{"line":925,"address":[17663132,17663071,17663078,17663181,17663763],"length":1,"stats":{"Line":3}},{"line":926,"address":[17663751,17663315,17663266,17663205,17663212],"length":1,"stats":{"Line":3}},{"line":927,"address":[17663449,17663400,17663346,17663739,17663339],"length":1,"stats":{"Line":3}},{"line":928,"address":[17663473,17663480,17663534,17663727,17663583],"length":1,"stats":{"Line":3}},{"line":929,"address":[17663599,17663606,17663653,17663709],"length":1,"stats":{"Line":2}}],"covered":129,"coverable":131},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","itinerary.rs"],"content":"/*\n * src/controllers/itinerary.rs\n *\n * File for Itinerary Controller API Endpoints\n *\n * Purpose:\n *   Serve Itinerary Related API Requests\n */\n\nuse axum::routing::post;\nuse axum::{Extension, Json, extract::Path, routing::get};\nuse sqlx::PgPool;\nuse tracing::debug;\nuse utoipa::OpenApi;\n\nuse crate::controllers::AxumRouter;\nuse crate::error::{ApiResult, AppError};\nuse crate::http_models::itinerary::*;\nuse crate::middleware::{AuthUser, middleware_auth};\nuse crate::sql_models::TimeOfDay;\nuse crate::sql_models::event_list::EventListJoinRow;\nuse crate::sql_models::itinerary::ItineraryRow;\nuse crate::swagger::SecurityAddon;\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_get_itinerary,\n\t\tapi_saved_itineraries,\n\t\tapi_save\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity((\"set-cookie\"=[])),\n    info(\n    \ttitle=\"Itinerary Routes\",\n    \tdescription = \"API endpoints dealing with managing and viewing itineraries.\"\n    ),\n    tags((name=\"Itinerary\"))\n)]\npub struct ItineraryApiDoc;\n\n/// Returns the [EventDay]s associated with this itinerary\nasync fn itinerary_events(itinerary_id: i32, pool: \u0026PgPool) -\u003e ApiResult\u003cVec\u003cEventDay\u003e\u003e {\n\tlet event_list: Vec\u003cEventListJoinRow\u003e = sqlx::query_as!(\n\t\tEventListJoinRow,\n\t\tr#\"\n\t\tSELECT\n\t\t\te.id,\n\t\t\tel.time_of_day as \"time_of_day: TimeOfDay\",\n\t\t\tel.date,\n\t\t\te.street_address,\n\t\t\te.postal_code,\n\t\t\te.city,\n\t\t\te.event_type,\n\t\t\te.event_description,\n\t\t\te.event_name\n\t\tFROM event_list el\n\t\tJOIN events e ON e.id = el.event_id\n\t\tWHERE el.itinerary_id = $1\n\t\t\"#,\n\t\titinerary_id\n\t)\n\t.fetch_all(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet mut event_days = Vec::with_capacity(event_list.len());\n\tfor event_day in event_list.chunk_by(|a, b| a.date == b.date) {\n\t\tlet mut morning_events = Vec::with_capacity(event_list.len());\n\t\tlet mut noon_events = Vec::with_capacity(event_list.len());\n\t\tlet mut afternoon_events = Vec::with_capacity(event_list.len());\n\t\tlet mut evening_events = Vec::with_capacity(event_list.len());\n\n\t\tfor event in event_day.into_iter() {\n\t\t\tmatch event.time_of_day {\n\t\t\t\tTimeOfDay::Morning =\u003e morning_events.push(event.into()),\n\t\t\t\tTimeOfDay::Noon =\u003e noon_events.push(event.into()),\n\t\t\t\tTimeOfDay::Afternoon =\u003e afternoon_events.push(event.into()),\n\t\t\t\tTimeOfDay::Evening =\u003e evening_events.push(event.into()),\n\t\t\t}\n\t\t}\n\n\t\tif let Some(event) = event_day.first() {\n\t\t\tevent_days.push(EventDay {\n\t\t\t\tmorning_events,\n\t\t\t\tnoon_events,\n\t\t\t\tafternoon_events,\n\t\t\t\tevening_events,\n\t\t\t\tdate: event.date,\n\t\t\t});\n\t\t}\n\t}\n\tevent_days.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n\tOk(event_days)\n}\n\n/// Inserts the events associated with this itinerary into the `event_list` table.\n/// Assumes the itinerary was already inserted into `itineraries` table.\npub async fn insert_event_list(itinerary: Itinerary, pool: \u0026PgPool) -\u003e ApiResult\u003c()\u003e {\n\tlet mut cap = 0;\n\tfor day in itinerary.event_days.iter() {\n\t\tcap += day.morning_events.len();\n\t\tcap += day.noon_events.len();\n\t\tcap += day.afternoon_events.len();\n\t\tcap += day.evening_events.len();\n\t}\n\n\tlet mut times = Vec::with_capacity(cap);\n\tlet mut dates = Vec::with_capacity(cap);\n\tlet mut events = Vec::with_capacity(cap);\n\tfor day in itinerary.event_days.into_iter() {\n\t\tlet morning_len = day.morning_events.len();\n\t\tlet noon_len = day.noon_events.len();\n\t\tlet afternoon_len = day.afternoon_events.len();\n\t\tlet evening_len = day.evening_events.len();\n\t\tlet len = morning_len + noon_len + afternoon_len + evening_len;\n\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Morning, morning_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Noon, noon_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Afternoon, afternoon_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Evening, evening_len));\n\n\t\tdates.extend(std::iter::repeat_n(day.date, len));\n\n\t\tevents.extend(day.morning_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.noon_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.afternoon_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.evening_events.into_iter().map(|event| event.id));\n\t}\n\n\tsqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO event_list (itinerary_id, event_id, time_of_day, date)\n\t\tSELECT $1, events, times, dates\n\t\tFROM UNNEST($2::int4[], $3::time_of_day[], $4::date[]) as u(events, times, dates);\n\t\t\"#,\n\t\titinerary.id,\n\t\tevents.as_slice(),\n\t\ttimes.as_slice() as \u0026[TimeOfDay],\n\t\tdates.as_slice()\n\t)\n\t.execute(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(())\n}\n\n/// Get all saved itineraries for the authenticated user.\n///\n/// # Method\n/// `GET /api/itinerary/saved`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - JSON body `{ \"itineraries\": [Itinerary] }` containing user's saved itineraries with eventlist\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/itinerary/saved\n///   -H \"Cookie: auth-token=...\"\n/// ```\n///\n#[utoipa::path(\n\tget,\n\tpath=\"/saved\",\n\tsummary=\"Fetch all the saved itineraries from this user\",\n\tdescription=\"Fetches all the itineraries from this user that are marked as saved.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"An array of itineraries\",\n\t\t\tbody=SavedResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_saved_itineraries(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cSavedResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/itinerary/saved 'api_saved_itineraries' - User ID: {}\",\n\t\tuser.id\n\t);\n\n\t// Fetch all itineraries for the user\n\tlet itineraries: Vec\u003cItineraryRow\u003e = sqlx::query_as!(\n\t\tItineraryRow,\n\t\tr#\"SELECT\n        \tid,\n         \taccount_id,\n          \tstart_date,\n           \tend_date,\n            chat_session_id,\n            title\n        FROM itineraries WHERE account_id=$1 AND saved=TRUE\"#,\n\t\tuser.id\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet mut res = Vec::with_capacity(itineraries.len());\n\tfor itinerary in itineraries.into_iter() {\n\t\tres.push(Itinerary {\n\t\t\tid: itinerary.id,\n\t\t\tstart_date: itinerary.start_date,\n\t\t\tend_date: itinerary.end_date,\n\t\t\tevent_days: itinerary_events(itinerary.id, \u0026pool).await?,\n\t\t\tchat_session_id: itinerary.chat_session_id,\n\t\t\ttitle: itinerary.title,\n\t\t});\n\t}\n\n\tOk(Json(SavedResponse { itineraries: res }))\n}\n\n/// Get a single saved itinerary either from the user or a public one\n///\n/// # Method\n/// `GET /api/itinerary/{id}`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - JSON body `{ \"itinerary\": Itinerary }` containing itinerary metadata\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - When itinerary doesn't exist or doesn't belong to user\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/itinerary/123\n///   -H \"Cookie: auth-token=...\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/saved/{id}\",\n\tsummary=\"Fetch a specific itinerary\",\n\tdescription=\"Fetches the specified itinerary if it belongs to this user or is public.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"The desired itinerary\",\n\t\t\tbody=Itinerary,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Itinerary not found\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_get_itinerary(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tPath(itinerary_id): Path\u003ci32\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cItinerary\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/itinerary/{} 'api_get_itinerary' - User ID: {}\",\n\t\titinerary_id, user.id\n\t);\n\n\t// Fetch the itinerary - from user or public\n\tlet itinerary: ItineraryRow = sqlx::query_as!(\n\t\tItineraryRow,\n\t\tr#\"SELECT\n        \tid,\n         \taccount_id,\n          \tstart_date,\n           \tend_date,\n            chat_session_id,\n            title\n        FROM itineraries WHERE id = $1 AND (account_id = $2 OR is_public=TRUE)\"#,\n\t\titinerary_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\tOk(Json(Itinerary {\n\t\tid: itinerary.id,\n\t\tstart_date: itinerary.start_date,\n\t\tend_date: itinerary.end_date,\n\t\tevent_days: itinerary_events(itinerary_id, \u0026pool).await?,\n\t\tchat_session_id: itinerary.chat_session_id,\n\t\ttitle: itinerary.title,\n\t}))\n}\n\n/// Update an existing or save a new itinerary for the user\n///\n/// # Method\n/// `POST /api/itinerary/save`\n///\n/// # Request Body\n/// - [Itinerary]\n///\n/// # Responses\n/// - `200 OK` - with body: [SaveResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/itinerary/save\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"id\": 3,\n///         \"start_date\": \"2025-07-15\",\n///         \"end_date\": \"2025-07-21\",\n///         \"event_days\": [\n///           {\n///             \"morning_events\": [],\n///             \"noon_events\": [\n///               {\n///                 \"id\": 4,\n///                 \"street_address\": \"3399 North Rd\",\n///                 \"postal_code\": 12601,\n///                 \"city\": \"Poughkeepsie\",\n///                 \"event_type\": \"Park\",\n///                 \"event_description\": \"Take a tour of Marist University\",\n///                 \"event_name\": \"Marist University\"\n///               }\n///             ],\n///             \"afternoon_events\": [],\n///             \"evening_events\": [],\n///             \"date\": \"2025-07-21\"\n///           }\n///         ],\n///         \"chat_session_id\": 4,\n///         \"title\": \"Poughkeepsie 7/15-21 2025\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/save\",\n\tsummary=\"Save a new or update an existing itinerary\",\n\tdescription=\"If the itinerary id is already saved for this user, it's updated with the provided values. Otherwise a new one is created.\",\n\trequest_body(\n\t\tcontent=Itinerary,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"The itinerary to save for the user.\",\n\t\t//TODO example\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"The id of the itinerary that was just saved. It may be the same as the id passed in the request.\",\n\t\t\tbody=SaveResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_save(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(itinerary): Json\u003cItinerary\u003e,\n) -\u003e ApiResult\u003cJson\u003cSaveResponse\u003e\u003e {\n\t// check if itinerary id already exists for this user\n\tlet id_opt = sqlx::query!(\n\t\tr#\"SELECT id FROM itineraries WHERE id=$1 AND account_id=$2\"#,\n\t\titinerary.id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.map(|record| record.id);\n\n\t// if it doesn't exist, insert a new one\n\tlet id = match id_opt {\n\t\tSome(id) =\u003e id,\n\t\tNone =\u003e {\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tINSERT INTO itineraries (account_id, is_public, start_date, end_date, chat_session_id, saved, title)\n\t\t\t\tVALUES ($1, FALSE, $2, $3, $4, TRUE, $5)\n\t\t\t\tRETURNING id;\n\t\t\t\t\"#,\n\t\t\t\tuser.id,\n\t\t\t\titinerary.start_date,\n\t\t\t\titinerary.end_date,\n\t\t\t\titinerary.chat_session_id,\n\t\t\t\titinerary.title\n\t\t\t)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.id\n\t\t}\n\t};\n\n\t// delete event_list for this itinerary and make a new one\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM event_list\n\t\tWHERE itinerary_id=$1;\n\t\t\"#,\n\t\tid\n\t)\n\t.execute(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tinsert_event_list(itinerary, \u0026pool).await?;\n\n\tOk(Json(SaveResponse { id }))\n}\n\n/// Create the itinerary routes with authentication middleware.\n///\n/// # Routes\n/// - `GET /saved` - Get user's saved itineraries (protected)\n/// - `POST /save` - Inserts into or updates the user's itinerary in the db (protected)\n/// - `GET /{id}` - Get single itinerary metadata (protected)\n///\n/// # Middleware\n/// All routes are protected by `middleware_auth` which validates the `auth-token` cookie.\npub fn itinerary_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/saved\", get(api_saved_itineraries))\n\t\t.route(\"/save\", post(api_save))\n\t\t.route(\"/{id}\", get(api_get_itinerary))\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n}\n","traces":[{"line":43,"address":[16959687,16960315,16959456,16960459,16959511],"length":1,"stats":{"Line":4}},{"line":44,"address":[16959730,16960213,16960822,16963064,16959664,16960388,16960437,16960755,16960657,16959800],"length":1,"stats":{"Line":4}},{"line":63,"address":[16960300],"length":1,"stats":{"Line":1}},{"line":64,"address":[16960418,16960705,16960499,16959717,16960373],"length":1,"stats":{"Line":4}},{"line":65,"address":[16960732,16963072,16960790,16963084],"length":1,"stats":{"Line":1}},{"line":67,"address":[16960927,16960990],"length":1,"stats":{"Line":2}},{"line":68,"address":[16962724,16961020,16963104,16961096,16963147],"length":1,"stats":{"Line":5}},{"line":69,"address":[16961334,16961614],"length":1,"stats":{"Line":2}},{"line":70,"address":[16961652,16961715],"length":1,"stats":{"Line":2}},{"line":71,"address":[16961816,16961753],"length":1,"stats":{"Line":2}},{"line":72,"address":[16961917,16961854],"length":1,"stats":{"Line":2}},{"line":74,"address":[16962022,16961957],"length":1,"stats":{"Line":2}},{"line":75,"address":[16962150],"length":1,"stats":{"Line":1}},{"line":76,"address":[16962749,16962852],"length":1,"stats":{"Line":2}},{"line":77,"address":[16962776,16962887],"length":1,"stats":{"Line":2}},{"line":78,"address":[16962922,16962803],"length":1,"stats":{"Line":2}},{"line":79,"address":[16962830,16962957],"length":1,"stats":{"Line":2}},{"line":83,"address":[16962193],"length":1,"stats":{"Line":1}},{"line":84,"address":[16962432,16962609],"length":1,"stats":{"Line":2}},{"line":85,"address":[16962269],"length":1,"stats":{"Line":1}},{"line":86,"address":[16962309],"length":1,"stats":{"Line":1}},{"line":87,"address":[16962349],"length":1,"stats":{"Line":1}},{"line":88,"address":[16962389],"length":1,"stats":{"Line":1}},{"line":89,"address":[16962429],"length":1,"stats":{"Line":1}},{"line":93,"address":[16963168,16961360,16963211],"length":1,"stats":{"Line":3}},{"line":95,"address":[16961394],"length":1,"stats":{"Line":1}},{"line":100,"address":[16963513,16963232,16963287,16967627,16965813,16968163],"length":1,"stats":{"Line":4}},{"line":101,"address":[16963478],"length":1,"stats":{"Line":1}},{"line":102,"address":[16967601,16963490,16963620],"length":1,"stats":{"Line":3}},{"line":103,"address":[16967329,16967384,16963808],"length":1,"stats":{"Line":2}},{"line":104,"address":[16967410,16967465,16967368],"length":1,"stats":{"Line":2}},{"line":105,"address":[16967449,16967491,16967546],"length":1,"stats":{"Line":2}},{"line":106,"address":[16967606,16967530,16967572],"length":1,"stats":{"Line":2}},{"line":109,"address":[16963834],"length":1,"stats":{"Line":1}},{"line":110,"address":[16963871],"length":1,"stats":{"Line":1}},{"line":111,"address":[16963959],"length":1,"stats":{"Line":1}},{"line":112,"address":[16964169,16964303,16964048,16967183],"length":1,"stats":{"Line":4}},{"line":113,"address":[16964496,16965868],"length":1,"stats":{"Line":2}},{"line":114,"address":[16965876],"length":1,"stats":{"Line":1}},{"line":115,"address":[16965915],"length":1,"stats":{"Line":1}},{"line":116,"address":[16965954],"length":1,"stats":{"Line":1}},{"line":117,"address":[16966009,16966205],"length":1,"stats":{"Line":1}},{"line":119,"address":[16966249,16966167],"length":1,"stats":{"Line":2}},{"line":120,"address":[16966282],"length":1,"stats":{"Line":1}},{"line":121,"address":[16966379],"length":1,"stats":{"Line":1}},{"line":122,"address":[16966476],"length":1,"stats":{"Line":1}},{"line":124,"address":[16966561],"length":1,"stats":{"Line":1}},{"line":126,"address":[16968500,16966631,16968480],"length":1,"stats":{"Line":3}},{"line":127,"address":[16966763,16968528,16968548],"length":1,"stats":{"Line":3}},{"line":128,"address":[16966895,16968576,16968596],"length":1,"stats":{"Line":3}},{"line":129,"address":[16967027,16968624,16968644],"length":1,"stats":{"Line":3}},{"line":132,"address":[16964804,16965733,16965791,16967822,16967990,16964537,16967923,16965628,16964726,16964897,16964640,16964827],"length":1,"stats":{"Line":7}},{"line":139,"address":[16964562],"length":1,"stats":{"Line":1}},{"line":140,"address":[16964648],"length":1,"stats":{"Line":1}},{"line":141,"address":[16964734],"length":1,"stats":{"Line":1}},{"line":143,"address":[16965695],"length":1,"stats":{"Line":1}},{"line":144,"address":[17448032],"length":1,"stats":{"Line":4}},{"line":145,"address":[16967958,16967900,16968684,16968672],"length":1,"stats":{"Line":1}},{"line":147,"address":[16968047],"length":1,"stats":{"Line":1}},{"line":192,"address":[17181088],"length":1,"stats":{"Line":1}},{"line":196,"address":[16973313,16973456,16973875],"length":1,"stats":{"Line":3}},{"line":202,"address":[16975062,16976055,16975743,16975957,16975533,16973830,16976122,16976544,16975129,16975697],"length":1,"stats":{"Line":4}},{"line":214,"address":[16975620],"length":1,"stats":{"Line":1}},{"line":215,"address":[16975805,16976005,16975682,16973371,16975727],"length":1,"stats":{"Line":4}},{"line":216,"address":[16976032,16977952,16977964,16976090],"length":1,"stats":{"Line":1}},{"line":218,"address":[16976300,16976230],"length":1,"stats":{"Line":2}},{"line":219,"address":[16976437,16977193,16977253,16976326],"length":1,"stats":{"Line":3}},{"line":220,"address":[16977348,16977044],"length":1,"stats":{"Line":0}},{"line":221,"address":[16977362],"length":1,"stats":{"Line":0}},{"line":222,"address":[16977371],"length":1,"stats":{"Line":0}},{"line":223,"address":[16977380],"length":1,"stats":{"Line":0}},{"line":224,"address":[16973392,16976606,16976858,16976580,16977736,16977389],"length":1,"stats":{"Line":0}},{"line":225,"address":[16976998],"length":1,"stats":{"Line":0}},{"line":226,"address":[16977010],"length":1,"stats":{"Line":0}},{"line":230,"address":[16977443],"length":1,"stats":{"Line":1}},{"line":276,"address":[17185328],"length":1,"stats":{"Line":1}},{"line":281,"address":[16980410,16980553,16980995],"length":1,"stats":{"Line":3}},{"line":287,"address":[16982403,16984069,16984097,16983679,16980927,16983755,16983067,16982336,16983523,16983333,16982903,16983113,16983447],"length":1,"stats":{"Line":7}},{"line":300,"address":[16982990],"length":1,"stats":{"Line":1}},{"line":301,"address":[17447724],"length":1,"stats":{"Line":4}},{"line":302,"address":[16983424,16984940,16984928,16983491],"length":1,"stats":{"Line":1}},{"line":303,"address":[16983723,16983620],"length":1,"stats":{"Line":2}},{"line":305,"address":[16984488],"length":1,"stats":{"Line":1}},{"line":306,"address":[16983912],"length":1,"stats":{"Line":1}},{"line":307,"address":[16983918],"length":1,"stats":{"Line":1}},{"line":308,"address":[16983924],"length":1,"stats":{"Line":1}},{"line":309,"address":[16984009,16980489,16984107,16983930],"length":1,"stats":{"Line":3}},{"line":310,"address":[16984454],"length":1,"stats":{"Line":1}},{"line":311,"address":[16984460],"length":1,"stats":{"Line":1}},{"line":388,"address":[17190160],"length":1,"stats":{"Line":1}},{"line":394,"address":[16989071,16987885,16988025,16988616,16989172,16989239,16988793,16988848,16990666,16988095,16989335],"length":1,"stats":{"Line":5}},{"line":399,"address":[16988687],"length":1,"stats":{"Line":1}},{"line":400,"address":[16988910,16989119,16987949,16988778,16988826],"length":1,"stats":{"Line":4}},{"line":401,"address":[16989149,16989207,16992976,16992988],"length":1,"stats":{"Line":1}},{"line":402,"address":[16993014,16993008,16989300],"length":1,"stats":{"Line":3}},{"line":405,"address":[16989349],"length":1,"stats":{"Line":1}},{"line":406,"address":[16989372],"length":1,"stats":{"Line":1}},{"line":408,"address":[16990412,16990599,16990544,16989405,16990860,16989544,16990961,16991028,16991743,16989611],"length":1,"stats":{"Line":4}},{"line":420,"address":[16990486],"length":1,"stats":{"Line":1}},{"line":421,"address":[16987970,16990577,16990702,16990908,16990529],"length":1,"stats":{"Line":4}},{"line":422,"address":[16993024,16990996,16990938,16993036],"length":1,"stats":{"Line":1}},{"line":423,"address":[16991089],"length":1,"stats":{"Line":1}},{"line":428,"address":[16991560,16992321,16991669,16990629,16991721,16992015,16991094,16992082,16991914,16991158],"length":1,"stats":{"Line":4}},{"line":435,"address":[16991611],"length":1,"stats":{"Line":1}},{"line":436,"address":[16987991,16991756,16991702,16991962,16991654],"length":1,"stats":{"Line":4}},{"line":437,"address":[16991992,16993056,16992050,16993068],"length":1,"stats":{"Line":1}},{"line":439,"address":[16992835,16992139,16988012,16992334],"length":1,"stats":{"Line":2}},{"line":441,"address":[16992652],"length":1,"stats":{"Line":1}},{"line":453,"address":[17174476,17174451,17173904],"length":1,"stats":{"Line":1}},{"line":454,"address":[17174014,17174279,17174398,17173911,17174336,17174202,17174068,17174145],"length":1,"stats":{"Line":8}},{"line":455,"address":[17174027,17173966,17173973,17174073,17174511],"length":1,"stats":{"Line":3}},{"line":456,"address":[17174499,17174097,17174158,17174207,17174104],"length":1,"stats":{"Line":3}},{"line":457,"address":[17174487,17174292,17174238,17174341,17174231],"length":1,"stats":{"Line":3}},{"line":458,"address":[17174357,17174411,17174364,17174469],"length":1,"stats":{"Line":2}}],"covered":107,"coverable":114},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","mod.rs"],"content":"pub mod account;\npub mod chat;\npub mod itinerary;\n\n/// A regular [axum::Router] in test and release builds, or [utoipa_axum::router::OpenApiRouter] in non-test or dev builds\n#[cfg(any(test, not(debug_assertions)))]\npub type AxumRouter = axum::Router;\n/// A regular [axum::Router] in test and release builds, or [utoipa_axum::router::OpenApiRouter] in non-test or dev builds\n#[cfg(all(not(test), debug_assertions))]\npub type AxumRouter = utoipa_axum::router::OpenApiRouter;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","db.rs"],"content":"// src/db/pool.rs\nuse sqlx::{PgPool, postgres::PgPoolOptions};\nuse std::env;\n// Pgpool- A pool of PostgreSQL connections\n// PgPoolOptions - The \"configuration options\" for creating a pool (the max number of connections).\n\npub async fn create_pool() -\u003e PgPool {\n\t// Retrieve the database URL from an environment variable\n\tlet database_url = env::var(\"DATABASE_URL\")\n\t\t//\"Panic\" if no url is found\n\t\t.expect(\"DATABASE_URL must be set in .env or environment\");\n\n\t// Creates a connection pool with up to 5 connections\n\tPgPoolOptions::new()\n\t\t.max_connections(5)\n\t\t.connect(\u0026database_url)\n\t\t.await\n\t\t.expect(\"Failed to create database pool\")\n}\n","traces":[{"line":7,"address":[17653361,17653316,17653792,17653184,17653232],"length":1,"stats":{"Line":5}},{"line":9,"address":[17653280],"length":1,"stats":{"Line":1}},{"line":14,"address":[17653606,17653439,17653977,17653719],"length":1,"stats":{"Line":4}},{"line":16,"address":[17653555,17653763,17653614,17653458,17653538],"length":1,"stats":{"Line":2}},{"line":17,"address":[17536487],"length":1,"stats":{"Line":4}}],"covered":5,"coverable":5},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","error.rs"],"content":"use axum::http::StatusCode;\nuse axum::response::{IntoResponse, Response};\nuse std::fmt;\nuse tracing::error;\n\n// Unified API result type\n#[cfg(not(tarpaulin_include))]\npub type ApiResult\u003cT\u003e = std::result::Result\u003cT, AppError\u003e;\n\n// Single unified error for the API\n#[derive(Debug)]\n#[cfg(not(tarpaulin_include))]\npub enum AppError {\n\tValidation(String),\n\tBadRequest(String),\n\tUnauthorized,\n\tNotFound,\n\tConflict(String),\n\tInternal(String),\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl AppError {\n\tpub fn status_code(\u0026self) -\u003e StatusCode {\n\t\tmatch self {\n\t\t\tAppError::Validation(_) =\u003e StatusCode::BAD_REQUEST,\n\t\t\tAppError::BadRequest(_) =\u003e StatusCode::BAD_REQUEST,\n\t\t\tAppError::Unauthorized =\u003e StatusCode::UNAUTHORIZED,\n\t\t\tAppError::NotFound =\u003e StatusCode::NOT_FOUND,\n\t\t\tAppError::Conflict(_) =\u003e StatusCode::CONFLICT,\n\t\t\tAppError::Internal(_) =\u003e StatusCode::INTERNAL_SERVER_ERROR,\n\t\t}\n\t}\n\n\tpub fn log(\u0026self) {\n\t\tmatch self {\n\t\t\tAppError::Validation(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"validation\", message = %m)\n\t\t\t}\n\t\t\tAppError::BadRequest(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"bad_request\", message = %m)\n\t\t\t}\n\t\t\tAppError::Unauthorized =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"unauthorized\")\n\t\t\t}\n\t\t\tAppError::NotFound =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"not_found\")\n\t\t\t}\n\t\t\tAppError::Conflict(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"conflict\", message = %m)\n\t\t\t}\n\t\t\tAppError::Internal(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"internal\", message = %m)\n\t\t\t}\n\t\t}\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl fmt::Display for AppError {\n\tfn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n\t\tmatch self {\n\t\t\tAppError::Validation(m) =\u003e write!(f, \"validation error: {m}\"),\n\t\t\tAppError::BadRequest(m) =\u003e write!(f, \"bad request: {m}\"),\n\t\t\tAppError::Unauthorized =\u003e write!(f, \"unauthorized\"),\n\t\t\tAppError::NotFound =\u003e write!(f, \"not found\"),\n\t\t\tAppError::Conflict(m) =\u003e write!(f, \"conflict: {m}\"),\n\t\t\tAppError::Internal(m) =\u003e write!(f, \"internal error: {m}\"),\n\t\t}\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl std::error::Error for AppError {}\n\n// Convert common error types into unified Internal errors\n#[cfg(not(tarpaulin_include))]\nimpl From\u003csqlx::Error\u003e for AppError {\n\tfn from(e: sqlx::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"db error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cargon2::password_hash::Error\u003e for AppError {\n\tfn from(e: argon2::password_hash::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"password hash error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cserde_json::Error\u003e for AppError {\n\tfn from(e: serde_json::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"json error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cstd::env::VarError\u003e for AppError {\n\tfn from(e: std::env::VarError) -\u003e Self {\n\t\tAppError::Internal(format!(\"env error: {e:?}\"))\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl IntoResponse for AppError {\n\tfn into_response(self) -\u003e Response {\n\t\t// Always log; return only status code\n\t\tself.log();\n\t\tself.status_code().into_response()\n\t}\n}\n","traces":[{"line":7,"address":[24165427,24165200,24165553,24165143,24165319,24165120,24165251,24165296],"length":1,"stats":{"Line":0}},{"line":8,"address":[19629621],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","global.rs"],"content":"pub const LOG_DIR: \u0026str = concat!(env!(\"CARGO_MANIFEST_DIR\"), \"/logs\");\npub const CRASH_LOG: \u0026str = \"crash.log\";\npub const LATEST_LOG: \u0026str = \"latest.log\";\npub const DIST_DIR: \u0026str = \"frontend/dist\";\npub const MESSAGE_PAGE_LEN: i32 = 10;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","account.rs"],"content":"/*\n * src/models/account.rs\n *\n * File for Account table models and related payload/response types\n *\n * Purpose:\n *   Strongly-typed models for the `accounts` table\n */\n\nuse crate::sql_models::{BudgetBucket, RiskTolerence};\nuse regex::Regex;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\n/// Request payload for POST `/api/account/login`.\n#[derive(Debug, Deserialize, ToSchema)]\npub struct LoginRequest {\n\t/// Account email\n\tpub email: String,\n\t/// Plaintext password submitted by the user\n\tpub password: String,\n}\n\n/// Request payload for POST `/api/account/signup`.\n/// Validated server-side before insert.\n#[derive(Debug, Deserialize, Clone, ToSchema)]\npub struct SignupRequest {\n\t/// Account email\n\tpub email: String,\n\tpub first_name: String,\n\tpub last_name: String,\n\t/// Plaintext password submitted by the user\n\tpub password: String,\n}\n\n/// Request payload for POST `/api/account/update`.\n/// - Only `Some` fields are updated.\n#[derive(Debug, Deserialize, ToSchema)]\npub struct UpdateRequest {\n\t/// Optional new email\n\tpub email: Option\u003cString\u003e,\n\t/// Optional new first name\n\tpub first_name: Option\u003cString\u003e,\n\t/// Optional new last name\n\tpub last_name: Option\u003cString\u003e,\n\t/// Optional new plaintext password\n\tpub password: Option\u003cString\u003e,\n\t/// Optional new budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional new risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional new food and allergies preferences\n\t/// * String is a comma-separated list of preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional new disabilites\n\t/// * String is a comma-separated list of preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\n/// API route response for POST `/api/account/update`.\n/// - Contains full updated account profile for convenience.\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct UpdateResponse {\n\t/// Current email\n\tpub email: String,\n\t/// Current first name\n\tpub first_name: String,\n\t/// Current last name\n\tpub last_name: String,\n\t/// Optional budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional food and allergies preferences\n\t/// * String is a comma-separated list of preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional disabilites\n\t/// * String is a comma-separated list of preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\n/// API route response for GET `/api/account/current`.\n/// - Safe-to-return account profile for current user\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct CurrentResponse {\n\t/// Email\n\tpub email: String,\n\t/// First name\n\tpub first_name: String,\n\t/// Last name\n\tpub last_name: String,\n\t/// Optional budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional food and allergies preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional food and allergies preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\nimpl SignupRequest {\n\t/// Validate email format using regex.\n\t/// Validate email format using regex\n\tpub fn validate_email(email: \u0026str) -\u003e bool {\n\t\tlet email_regex = Regex::new(r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\").unwrap();\n\t\temail_regex.is_match(email)\n\t}\n\n\t/// Validate password strength\n\t/// - Minimum 8 characters\n\t/// - Maximum 128 characters\n\t/// - At least one uppercase letter\n\t/// - At least one lowercase letter\n\t/// - At least one number\n\t/// - Only ASCII characters allowed (for security and compatibility)\n\tpub fn validate_password(password: \u0026str) -\u003e Result\u003c(), String\u003e {\n\t\tif password.len() \u003c 8 {\n\t\t\treturn Err(\"Password must be at least 8 characters long\".to_string());\n\t\t}\n\n\t\tif password.len() \u003e 128 {\n\t\t\treturn Err(\"Password must be 128 characters or less\".to_string());\n\t\t}\n\n\t\t// Only allow ASCII characters (prevents potential encoding issues)\n\t\tif !password.is_ascii() {\n\t\t\treturn Err(\"Password must contain only ASCII characters\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_uppercase()) {\n\t\t\treturn Err(\"Password must contain at least one uppercase letter\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_lowercase()) {\n\t\t\treturn Err(\"Password must contain at least one lowercase letter\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_numeric()) {\n\t\t\treturn Err(\"Password must contain at least one number\".to_string());\n\t\t}\n\n\t\tOk(())\n\t}\n\n\t/// Validate the entire signup payload\n\tpub fn validate(\u0026self) -\u003e Result\u003c(), String\u003e {\n\t\t// Validate email (trim before checking)\n\t\tlet email_trimmed = self.email.trim();\n\t\tif email_trimmed.is_empty() {\n\t\t\treturn Err(\"Email is required\".to_string());\n\t\t}\n\n\t\tif !Self::validate_email(email_trimmed) {\n\t\t\treturn Err(\"Invalid email format\".to_string());\n\t\t}\n\n\t\t// Validate first name (trim before checking)\n\t\tlet first_name_trimmed = self.first_name.trim();\n\t\tif first_name_trimmed.is_empty() {\n\t\t\treturn Err(\"First name is required\".to_string());\n\t\t}\n\n\t\tif first_name_trimmed.len() \u003e 50 {\n\t\t\treturn Err(\"First name must be 50 characters or less\".to_string());\n\t\t}\n\n\t\t// Validate last name (trim before checking)\n\t\tlet last_name_trimmed = self.last_name.trim();\n\t\tif last_name_trimmed.is_empty() {\n\t\t\treturn Err(\"Last name is required\".to_string());\n\t\t}\n\n\t\tif last_name_trimmed.len() \u003e 50 {\n\t\t\treturn Err(\"Last name must be 50 characters or less\".to_string());\n\t\t}\n\n\t\t// Validate password\n\t\tSelf::validate_password(\u0026self.password)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[{"line":105,"address":[18154544,18154713,18154719],"length":1,"stats":{"Line":1}},{"line":106,"address":[18154571],"length":1,"stats":{"Line":1}},{"line":107,"address":[18154642],"length":1,"stats":{"Line":1}},{"line":117,"address":[18154736],"length":1,"stats":{"Line":1}},{"line":118,"address":[18154795],"length":1,"stats":{"Line":1}},{"line":119,"address":[18154831],"length":1,"stats":{"Line":1}},{"line":122,"address":[18154816],"length":1,"stats":{"Line":1}},{"line":123,"address":[18154911],"length":1,"stats":{"Line":1}},{"line":127,"address":[18154900],"length":1,"stats":{"Line":1}},{"line":128,"address":[18154967],"length":1,"stats":{"Line":1}},{"line":131,"address":[17243232,17243256],"length":1,"stats":{"Line":3}},{"line":132,"address":[18155077],"length":1,"stats":{"Line":1}},{"line":135,"address":[17243280,17243304],"length":1,"stats":{"Line":3}},{"line":136,"address":[18155193],"length":1,"stats":{"Line":1}},{"line":139,"address":[17243328,17243352],"length":1,"stats":{"Line":3}},{"line":140,"address":[18155312],"length":1,"stats":{"Line":1}},{"line":143,"address":[18155388],"length":1,"stats":{"Line":1}},{"line":147,"address":[18155408],"length":1,"stats":{"Line":1}},{"line":149,"address":[18155446],"length":1,"stats":{"Line":1}},{"line":150,"address":[18155494],"length":1,"stats":{"Line":1}},{"line":151,"address":[18155524],"length":1,"stats":{"Line":1}},{"line":154,"address":[18155513],"length":1,"stats":{"Line":1}},{"line":155,"address":[18155580],"length":1,"stats":{"Line":1}},{"line":159,"address":[18155641],"length":1,"stats":{"Line":1}},{"line":160,"address":[18155693],"length":1,"stats":{"Line":1}},{"line":161,"address":[18155744],"length":1,"stats":{"Line":1}},{"line":164,"address":[18155727],"length":1,"stats":{"Line":1}},{"line":165,"address":[18155880],"length":1,"stats":{"Line":1}},{"line":169,"address":[18155817],"length":1,"stats":{"Line":1}},{"line":170,"address":[18155869],"length":1,"stats":{"Line":1}},{"line":171,"address":[18155978],"length":1,"stats":{"Line":1}},{"line":174,"address":[18155961],"length":1,"stats":{"Line":1}},{"line":175,"address":[18156143],"length":1,"stats":{"Line":1}},{"line":179,"address":[18156219,18156054],"length":1,"stats":{"Line":2}},{"line":181,"address":[18156298],"length":1,"stats":{"Line":1}}],"covered":35,"coverable":35},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","chat_session.rs"],"content":"use serde::Serialize;\nuse utoipa::{ToResponse, ToSchema};\n\nuse crate::sql_models::message::ChatSessionRow;\n\n/// Response model from the `/api/chat/chats` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct ChatsResponse {\n\t/// chat session ids belonging to the user who made the request\n\tpub chat_sessions: Vec\u003cChatSessionRow\u003e,\n}\n\n/// Response model from the `/api/chat/newChat` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct NewChatResponse {\n\t/// this chat session is guaranteed to not have any messages in it\n\tpub chat_session_id: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","event.rs"],"content":"use serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\nuse crate::sql_models::event_list::EventListJoinRow;\n\n/// A single event without context from an itinerary\n#[derive(Debug, Serialize, Deserialize, FromRow, ToSchema)]\npub struct Event {\n\t/// Primary key\n\tpub id: i32,\n\tpub street_address: String,\n\tpub postal_code: i32,\n\tpub city: String,\n\tpub event_type: String,\n\tpub event_description: String,\n\tpub event_name: String,\n}\n\nimpl From\u003c\u0026EventListJoinRow\u003e for Event {\n\t#[cfg(not(tarpaulin_include))]\n\tfn from(value: \u0026EventListJoinRow) -\u003e Self {\n\t\tSelf {\n\t\t\tid: value.id,\n\t\t\tstreet_address: value.street_address.clone(),\n\t\t\tpostal_code: value.postal_code,\n\t\t\tcity: value.city.clone(),\n\t\t\tevent_type: value.event_type.clone(),\n\t\t\tevent_description: value.event_description.clone(),\n\t\t\tevent_name: value.event_name.clone(),\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","itinerary.rs"],"content":"/*\n * src/models/itinerary.rs\n *\n * File for Itinerary table models and related responses\n *\n * Purpose:\n *   Strongly-typed models for the `itineraries` response DTOs\n *   used by itinerary routes.\n */\n\nuse chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\nuse crate::http_models::event::Event;\n\n/// A complete itinerary with event details\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct Itinerary {\n\t/// Primary key\n\tpub id: i32,\n\t/// UTC date that the first event may take place (%Y-%m-%d)\n\tpub start_date: NaiveDate,\n\t/// UTC date that the last event may take place (%Y-%m-%d)\n\tpub end_date: NaiveDate,\n\t/// List of days containing events for that day\n\t/// * Days are guaranteed to be sorted in chronological order\n\tpub event_days: Vec\u003cEventDay\u003e,\n\t/// Possible associated chat session for easy editing on frontend\n\tpub chat_session_id: Option\u003ci32\u003e,\n\t/// Title of itinerary, defaults to include location and date range\n\tpub title: String,\n}\n\n/// A single day of events in an itinerary\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct EventDay {\n\t/// All the events taking place in the morning\n\tpub morning_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place around noon\n\tpub noon_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place in the afternoon\n\tpub afternoon_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place in the evening\n\tpub evening_events: Vec\u003cEvent\u003e,\n\t/// The UTC date of this day within the range of itinerary start and end dates (%Y-%m-%d)\n\tpub date: NaiveDate,\n}\n\n/// API route response for GET `/api/itinerary/saved`\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct SavedResponse {\n\t/// List of saved itineraries for the user.\n\tpub itineraries: Vec\u003cItinerary\u003e,\n}\n\n/// Response model from `/api/itinerary/save` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct SaveResponse {\n\t/// id of the itinerary that was just saved\n\t/// * May be the same as the itinerary id passed in the request\n\tpub id: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","message.rs"],"content":"use chrono::NaiveDateTime;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\n/// A message in a chat session\n#[derive(Debug, Serialize, ToSchema, ToResponse)]\npub struct Message {\n\t/// Primary key\n\tpub id: i32,\n\t/// Whether the message was sent by a user or generated by the LLM\n\tpub is_user: bool,\n\t/// UTC timestamp this message was sent (%Y-%m-%d %H:%M:%S)\n\tpub timestamp: NaiveDateTime,\n\t/// Content of this message\n\tpub text: String,\n\t/// Possible itinerary associated with this message\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/messagePage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct MessagePageRequest {\n\t/// chat session to fetch page from\n\tpub chat_session_id: i32,\n\t/// Possible message id to represent the end of the page\n\t/// * If Some, it will fetch this message and consecutive previous messages in chronological order\n\t/// * If None, it will fetch the latest consecutive messages from the chat session in chronological order\n\tpub message_id: Option\u003ci32\u003e,\n}\n\n/// Response model for `/api/chat/messagePage` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct MessagePageResponse {\n\t/// A page of messages guaranteed to be sorted in chronological order\n\tpub message_page: Vec\u003cMessage\u003e,\n\t/// The id of the message that comes chronologically before the first message in message_page, if it exists\n\tpub prev_message_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/updateMessage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct UpdateMessageRequest {\n\t/// ID of the message to update. This message must belong to a chat session which belongs to the user who made the request\n\tpub message_id: i32,\n\t/// The text to replace the old content with\n\tpub new_text: String,\n\t/// A possible itinerary to give context to the LLM\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/sendMessage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct SendMessageRequest {\n\t/// The chat session to send this message in. It must belong to the user making the request.\n\tpub chat_session_id: i32,\n\t/// The content of the message\n\tpub text: String,\n\t/// A possible itinerary to give context to the LLM\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Response model for `/api/chat/sendMessage` endpoint\n#[derive(Debug, Serialize, ToSchema, ToResponse)]\npub struct SendMessageResponse {\n\t/// The newly-created id of the message you just sent\n\tpub user_message_id: i32,\n\t/// The response message from the LLM\n\tpub bot_message: Message,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","mod.rs"],"content":"pub mod account;\npub mod chat_session;\npub mod event;\npub mod itinerary;\npub mod message;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","log.rs"],"content":"use {\n\tcrate::global::*,\n\tstd::{\n\t\tfs::{self, File},\n\t\tio::{BufWriter, Write},\n\t\tpath::Path,\n\t\tsync::{Once, OnceLock},\n\t},\n\ttracing::error,\n\ttracing_appender::{non_blocking::NonBlocking, rolling},\n\ttracing_subscriber::{\n\t\tEnvFilter, Layer, fmt::time::SystemTime, layer::SubscriberExt, util::SubscriberInitExt,\n\t},\n};\n\nstatic INIT_LOG: Once = Once::new();\nstatic mut LOG_WRITER: OnceLock\u003cNonBlocking\u003e = OnceLock::new();\n\n/// When the program panics, the backtrace is outputted to `logs/crash.log`.\npub fn init_panic_handler() {\n\tunsafe {\n\t\t// Safety\n\t\t//\n\t\t// Always safe on Windows.\n\t\t//\n\t\t// Other platforms: risk of race condition in multi-threaded environment.\n\t\t// We are not reading/writing this environment variable from multiple threads, so we're good.\n\t\tstd::env::set_var(\"RUST_BACKTRACE\", \"full\");\n\t}\n\tstd::panic::set_hook(Box::new(move |panic_info| {\n\t\tconst WRITE_ERR: \u0026str = \"Could not write to crash log\";\n\t\terror!(\"{}\", panic_info);\n\t\tprintln!(\"{}\", panic_info);\n\n\t\tfs::create_dir_all(LOG_DIR).expect(\"Could create crash log\");\n\t\tlet file = File::create(Path::new(LOG_DIR).join(CRASH_LOG))\n\t\t\t.expect(\"Could not create crash log file\");\n\t\tlet backtrace = std::backtrace::Backtrace::capture();\n\t\tlet mut writer = BufWriter::new(file);\n\n\t\twriteln!(writer, \"Time: {}\", chrono::Local::now()).expect(WRITE_ERR);\n\t\twriteln!(writer, \"{panic_info}\").expect(WRITE_ERR);\n\t\twriteln!(writer, \"stack backtrace:\\n{backtrace}\").expect(WRITE_ERR);\n\t\twriteln!(writer, \"Process finished with exit code 101\").expect(WRITE_ERR);\n\t\twriter.flush().expect(WRITE_ERR);\n\t}));\n}\n\n/// Creates a tracing registry and adds a layer to it. Layer outputs to `logs/latest.log`.\n///\n/// See `.env` variable `RUST_LOG` for layer filter. These variables should be loaded into the environment for the filter to work.\n/// See [dotenvy].\npub fn init_logger() {\n\tINIT_LOG.call_once(|| {\n\t\t_ = fs::remove_file(Path::new(LOG_DIR).join(LATEST_LOG));\n\t\tlet (log_writer, log_guard) =\n\t\t\ttracing_appender::non_blocking(rolling::never(LOG_DIR, LATEST_LOG));\n\t\tlet latest_log_layer = tracing_subscriber::fmt::layer()\n\t\t\t.with_timer(SystemTime)\n\t\t\t.with_ansi(false)\n\t\t\t.log_internal_errors(true)\n\t\t\t.with_target(true)\n\t\t\t.with_file(true)\n\t\t\t.with_line_number(true)\n\t\t\t.with_level(true)\n\t\t\t.with_thread_names(true)\n\t\t\t.with_thread_ids(true)\n\t\t\t.pretty()\n\t\t\t.with_writer(log_writer.clone())\n\t\t\t.with_filter(EnvFilter::from_default_env());\n\t\ttracing_subscriber::registry().with(latest_log_layer).init();\n\n\t\t#[allow(static_mut_refs)]\n\t\tunsafe {\n\t\t\t_ = LOG_WRITER.set(log_writer);\n\t\t}\n\n\t\t// log_guard has to have a static lifetime.\n\t\t// We can just let the OS clean it up for us when the process is killed.\n\t\t// We can make as many loggers as we want.\n\t\tBox::leak(Box::new(log_guard));\n\t})\n}\n\n#[allow(unused)]\npub fn log_writer() -\u003e \u0026'static mut NonBlocking {\n\t#[allow(static_mut_refs)]\n\tunsafe {\n\t\tLOG_WRITER.get_mut().expect(\"Logger not initialized\")\n\t}\n}\n","traces":[{"line":20,"address":[16636000],"length":1,"stats":{"Line":1}},{"line":28,"address":[16636001],"length":1,"stats":{"Line":1}},{"line":30,"address":[16636030],"length":1,"stats":{"Line":2}},{"line":32,"address":[16903399,16904312],"length":1,"stats":{"Line":1}},{"line":33,"address":[16904036],"length":1,"stats":{"Line":1}},{"line":35,"address":[16904108],"length":1,"stats":{"Line":1}},{"line":36,"address":[16904176],"length":1,"stats":{"Line":1}},{"line":37,"address":[16904251],"length":1,"stats":{"Line":1}},{"line":38,"address":[16904290],"length":1,"stats":{"Line":1}},{"line":39,"address":[16904952],"length":1,"stats":{"Line":1}},{"line":41,"address":[16905019,16905091],"length":1,"stats":{"Line":2}},{"line":42,"address":[16905227],"length":1,"stats":{"Line":1}},{"line":43,"address":[16905363],"length":1,"stats":{"Line":1}},{"line":44,"address":[16905483],"length":1,"stats":{"Line":1}},{"line":45,"address":[16905580],"length":1,"stats":{"Line":1}},{"line":53,"address":[16636064],"length":1,"stats":{"Line":1}},{"line":54,"address":[16636065],"length":1,"stats":{"Line":2}},{"line":55,"address":[16905749],"length":1,"stats":{"Line":1}},{"line":56,"address":[16905946],"length":1,"stats":{"Line":1}},{"line":57,"address":[16905923],"length":1,"stats":{"Line":1}},{"line":58,"address":[16906060,16906498],"length":1,"stats":{"Line":2}},{"line":59,"address":[16906124],"length":1,"stats":{"Line":1}},{"line":60,"address":[16906149],"length":1,"stats":{"Line":1}},{"line":61,"address":[16906156],"length":1,"stats":{"Line":1}},{"line":62,"address":[16906209],"length":1,"stats":{"Line":1}},{"line":63,"address":[16906237],"length":1,"stats":{"Line":1}},{"line":64,"address":[16906265],"length":1,"stats":{"Line":1}},{"line":65,"address":[16906293],"length":1,"stats":{"Line":1}},{"line":66,"address":[16906321],"length":1,"stats":{"Line":1}},{"line":67,"address":[16906349],"length":1,"stats":{"Line":1}},{"line":68,"address":[16906372],"length":1,"stats":{"Line":1}},{"line":69,"address":[16906392],"length":1,"stats":{"Line":1}},{"line":70,"address":[16906438,16906457,16906981,16906530],"length":1,"stats":{"Line":2}},{"line":71,"address":[16906553,16906613],"length":1,"stats":{"Line":2}},{"line":75,"address":[16906699],"length":1,"stats":{"Line":1}},{"line":81,"address":[16906815],"length":1,"stats":{"Line":1}},{"line":86,"address":[16636096],"length":1,"stats":{"Line":1}},{"line":89,"address":[16636162,16636097],"length":1,"stats":{"Line":1}}],"covered":38,"coverable":38},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","main.rs"],"content":"#![allow(unexpected_cfgs)]\n\nmod controllers;\nmod db;\nmod error;\nmod global;\nmod http_models;\nmod log;\nmod middleware;\nmod sql_models;\n\n#[cfg(not(tarpaulin_include))]\nmod swagger;\n\n#[cfg(test)]\nmod tests;\n\nuse crate::controllers::AxumRouter;\nuse crate::global::*;\nuse axum::{Extension, routing::get_service};\nuse http::{Method, header::HeaderValue};\nuse std::env;\nuse std::net::SocketAddr;\nuse std::path::Path;\nuse std::str::FromStr;\nuse tower_cookies::CookieManagerLayer;\nuse tower_cookies::cookie::Key;\nuse tower_http::{\n\tcors::CorsLayer,\n\tservices::{ServeDir, ServeFile},\n};\n\n#[cfg(not(tarpaulin_include))]\n#[tokio::main]\nasync fn main() -\u003e std::result::Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n\t// Load our evironment variables\n\tdotenvy::dotenv().ok();\n\tlog::init_panic_handler();\n\tlog::init_logger();\n\n\t// Read and store loaded environment variables\n\tlet api_base_url = env::var(\"API_BASE_URL\").expect(\"API_BASE_URL must be set\");\n\tlet front_end_url = env::var(\"FRONTEND_URL\").expect(\"FRONTEND_URL must be set\");\n\tlet bind_address = env::var(\"BIND_ADDRESS\").expect(\"BIND_ADDRESS must be set\");\n\n\t// Initialize the database pool connection\n\tlet pool = db::create_pool().await;\n\n\t/*\n\t/ Configure CORS\n\t/ CORS is needed when a frontend (running on one domain or port)\n\t/ wants to send HTTP requests to a backend running on another domain or port.\n\t/ This is needed for the frontend to send requests to the backend.\n\t/ We allow all origins, methods, and headers currently, but this should be changed later for security.\n\t/ TODO: Ensure we have all the right values below, may need to constrict the requests we accept\n\t*/\n\tlet cors = CorsLayer::new()\n\t\t.allow_origin(\n\t\t\tfront_end_url\n\t\t\t\t.parse::\u003cHeaderValue\u003e()\n\t\t\t\t.expect(\"Invalid frontend_url format\"),\n\t\t)\n\t\t.allow_credentials(true)\n\t\t.allow_methods([Method::GET, Method::POST, Method::DELETE])\n\t\t.allow_headers([\n\t\t\thttp::header::CONTENT_TYPE,\n\t\t\thttp::header::ACCEPT,\n\t\t\thttp::header::AUTHORIZATION,\n\t\t\thttp::header::HeaderName::from_static(\"x-requested-with\"),\n\t\t]);\n\n\t// Use an encryption/signing key for private cookies\n\tlet cookie_key = Key::generate();\n\n\t// API routes with CORS middleware\n\tlet api_routes = AxumRouter::new()\n\t\t.nest(\"/account\", controllers::account::account_routes())\n\t\t.nest(\"/itinerary\", controllers::itinerary::itinerary_routes())\n\t\t.nest(\"/chat\", controllers::chat::chat_routes());\n\t// TODO: nest other routes...\n\n\tlet api_routes = AxumRouter::new().nest(\"/api\", api_routes);\n\n\t#[cfg(all(not(test), debug_assertions))]\n\tlet api_routes = crate::swagger::merge_swagger(api_routes);\n\n\t// Build the main router\n\tlet app = axum::Router::new()\n\t\t.merge(api_routes)\n\t\t// Static files served from /dist.\n\t\t// Fallback must be index.html since react handles routing on front end\n\t\t.fallback_service(get_service(\n\t\t\tServeDir::new(DIST_DIR)\n\t\t\t\t.fallback(ServeFile::new(Path::new(DIST_DIR).join(\"index.html\"))),\n\t\t))\n\t\t.layer(Extension(pool.clone()))\n\t\t.layer(Extension(cookie_key.clone()))\n\t\t.layer(CookieManagerLayer::new())\n\t\t.layer(cors);\n\n\t/*\n\t/ Bind the router to a specific port\n\t/ We use the SocketAddr struct to bind the router to the port\n\t/ We use the 0.0.0.0 address to bind the router to localhost\n\t/ We will bind to port 3001 for now\n\t*/\n\tlet addr = SocketAddr::from_str(\u0026bind_address).expect(\"Invalid BIND_ADDRESS format\");\n\tprintln!(\"Server starting on {}\", api_base_url);\n\n\t/*\n\t/ Serve the router ie: Start the server\n\t/ We will start the server with the configured router and address\n\t*/\n\tlet listener = tokio::net::TcpListener::bind(addr).await.unwrap();\n\taxum::serve(listener, app.into_make_service()).await?;\n\n\tOk(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","middleware.rs"],"content":"use crate::error::AppError;\nuse axum::{extract::Request, http::header, middleware::Next, response::IntoResponse};\nuse chrono::Utc;\nuse sqlx::PgPool;\nuse tower_cookies::cookie::{Cookie, CookieJar, Key};\n\n/// Inserted into request extensions on authenticated requests\n#[derive(Clone, Copy, Debug)]\npub struct AuthUser {\n\tpub id: i32,\n}\n\n/// Auth middleware for account routes\n/// - Decrypts `auth-token` private cookie using `Key` from extensions\n/// - Validates embedded expiration and that the user exists in DB\n/// - Inserts `AuthUser` into request extensions on success; otherwise 401\npub async fn middleware_auth(mut req: Request, next: Next) -\u003e impl IntoResponse {\n\tlet key = match req.extensions().get::\u003cKey\u003e() {\n\t\tSome(k) =\u003e k.clone(),\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet pool = match req.extensions().get::\u003cPgPool\u003e() {\n\t\tSome(p) =\u003e p.clone(),\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\t// Read Cookie header\n\tlet cookie_header = match req.headers().get(header::COOKIE) {\n\t\tSome(v) =\u003e v,\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet cookie_str = match cookie_header.to_str() {\n\t\tOk(s) =\u003e s,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\t// Build a jar from incoming cookies\n\tlet mut jar = CookieJar::new();\n\tfor pair in cookie_str.split(';') {\n\t\tlet s = pair.trim();\n\t\tif s.is_empty() {\n\t\t\tcontinue;\n\t\t}\n\t\tif let Ok(parsed) = Cookie::parse(s.to_string()) {\n\t\t\tjar.add(parsed);\n\t\t}\n\t}\n\n\t// Decrypt private cookie and extract token\n\tlet decrypted = match jar.private(\u0026key).get(\"auth-token\") {\n\t\tSome(c) =\u003e c,\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet token = decrypted.value().to_string();\n\n\t// Expect format: user-\u003cid\u003e.\u003cexp\u003e.sign\n\tlet parts: Vec\u003c\u0026str\u003e = token.split('.').collect();\n\n\tif parts.len() != 3 || parts[2] != \"sign\" || !parts[0].starts_with(\"user-\") {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\tlet user_id: i32 = match parts[0][5..].parse() {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\tlet exp: i64 = match parts[1].parse() {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\tif Utc::now().timestamp() \u003e exp {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\t// Ensure user exists\n\tlet exists_row =\n\t\tsqlx::query_as::\u003c_, (bool,)\u003e(\"SELECT EXISTS(SELECT 1 FROM accounts WHERE id = $1)\")\n\t\t\t.bind(user_id)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.unwrap_or((false,));\n\n\tif !exists_row.0 {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\t// Attach user to request\n\treq.extensions_mut().insert(AuthUser { id: user_id });\n\n\tnext.run(req).await\n}\n","traces":[{"line":17,"address":[17812576,17815981,17812643,17812831,17816501,17816837],"length":1,"stats":{"Line":4}},{"line":18,"address":[17812951,17812812],"length":1,"stats":{"Line":2}},{"line":19,"address":[17813021],"length":1,"stats":{"Line":1}},{"line":20,"address":[17813051],"length":1,"stats":{"Line":0}},{"line":22,"address":[17813125],"length":1,"stats":{"Line":1}},{"line":23,"address":[17813229,17813342],"length":1,"stats":{"Line":2}},{"line":24,"address":[17813278],"length":1,"stats":{"Line":0}},{"line":28,"address":[17813426,17813345],"length":1,"stats":{"Line":2}},{"line":29,"address":[17813530],"length":1,"stats":{"Line":1}},{"line":30,"address":[17813573],"length":1,"stats":{"Line":1}},{"line":32,"address":[17813546,17813655],"length":1,"stats":{"Line":2}},{"line":33,"address":[17813748],"length":1,"stats":{"Line":1}},{"line":34,"address":[17813702,17815976],"length":1,"stats":{"Line":0}},{"line":38,"address":[17813796],"length":1,"stats":{"Line":1}},{"line":39,"address":[17813905,17813830],"length":1,"stats":{"Line":2}},{"line":40,"address":[17814088,17815755],"length":1,"stats":{"Line":2}},{"line":41,"address":[17815787],"length":1,"stats":{"Line":1}},{"line":44,"address":[17815822],"length":1,"stats":{"Line":1}},{"line":45,"address":[17815953],"length":1,"stats":{"Line":1}},{"line":50,"address":[17814122],"length":1,"stats":{"Line":1}},{"line":51,"address":[17814290],"length":1,"stats":{"Line":1}},{"line":52,"address":[17814372],"length":1,"stats":{"Line":0}},{"line":54,"address":[17814349,17814513],"length":1,"stats":{"Line":2}},{"line":57,"address":[17814539,17814636],"length":1,"stats":{"Line":2}},{"line":59,"address":[17814885,17814702,17814787],"length":1,"stats":{"Line":3}},{"line":60,"address":[17814839,17815737],"length":1,"stats":{"Line":0}},{"line":63,"address":[17815037],"length":1,"stats":{"Line":1}},{"line":64,"address":[17815249],"length":1,"stats":{"Line":1}},{"line":65,"address":[17815735,17815203],"length":1,"stats":{"Line":0}},{"line":68,"address":[17815269],"length":1,"stats":{"Line":1}},{"line":69,"address":[17815393],"length":1,"stats":{"Line":1}},{"line":70,"address":[17815355,17815733],"length":1,"stats":{"Line":0}},{"line":73,"address":[17815414],"length":1,"stats":{"Line":1}},{"line":74,"address":[17815503,17815702],"length":1,"stats":{"Line":0}},{"line":78,"address":[17815472,17815647,17816173,17816260],"length":1,"stats":{"Line":4}},{"line":80,"address":[17815549],"length":1,"stats":{"Line":1}},{"line":81,"address":[17815586],"length":1,"stats":{"Line":1}},{"line":82,"address":[17543804],"length":1,"stats":{"Line":4}},{"line":83,"address":[17816245],"length":1,"stats":{"Line":1}},{"line":85,"address":[17816272],"length":1,"stats":{"Line":1}},{"line":86,"address":[17816341,17816276],"length":1,"stats":{"Line":0}},{"line":90,"address":[17816319,17816628],"length":1,"stats":{"Line":2}},{"line":92,"address":[17543825],"length":1,"stats":{"Line":1}}],"covered":34,"coverable":43},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","account.rs"],"content":"/// Row model for the `accounts` table.\n/// - Represents a persisted user.\npub struct AccountRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Unique email address\n\t#[allow(dead_code)] // email required for login route\n\tpub email: String,\n\t/// Argon2 hashed password\n\tpub password: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","event_list.rs"],"content":"use chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\n\nuse crate::sql_models::TimeOfDay;\n\n/// Row model for an inner join of `event_list` and `events` tables on chat session id.\n/// - Represents one event for an itinerary.\n#[derive(Debug, Serialize, Deserialize)]\npub struct EventListJoinRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Morning/Noon/Afternoon/Evening\n\tpub time_of_day: TimeOfDay,\n\t/// UTC date within itinerary date range (%Y-%m-%d)\n\tpub date: NaiveDate,\n\t/// Event address\n\tpub street_address: String,\n\t/// Event post code\n\tpub postal_code: i32,\n\t/// Event City\n\tpub city: String,\n\t/// Event type\n\tpub event_type: String,\n\t/// Event description\n\tpub event_description: String,\n\t/// Event name\n\tpub event_name: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","itinerary.rs"],"content":"use chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\n\n/// Row model for the `itineraries` table.\n#[derive(Debug, Serialize, Deserialize)]\npub struct ItineraryRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Owner account id (FK)\n\tpub account_id: Option\u003ci32\u003e,\n\t/// Start date for itinerary (UTC naive %Y-%m-%d)\n\tpub start_date: NaiveDate,\n\t/// End date for itinerary (UTC naive %Y-%m-%d)\n\tpub end_date: NaiveDate,\n\t/// Possible chat session to link to if this itinerary is edited\n\tpub chat_session_id: Option\u003ci32\u003e,\n\t/// Title of itinerary, defaults to include location and date range\n\tpub title: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","message.rs"],"content":"use chrono::NaiveDateTime;\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n/// Row model for `chat_sessions` table\n#[derive(Serialize, Deserialize, FromRow, ToSchema)]\npub struct ChatSessionRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Name of chat for user context\n\tpub title: String,\n}\n\n/// Row model for `message` table\n#[derive(Serialize, Deserialize, FromRow)]\npub struct MessageRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Chat session this message belongs to\n\tpub chat_session_id: i32,\n\t/// Possible itinerary associated with this message\n\tpub itinerary_id: Option\u003ci32\u003e,\n\t/// Whether this message was sent by the user or generated by the LLM\n\tpub is_user: bool,\n\t/// UTC timestamp this message was sent (%Y-%m-%d %H:%M:%S)\n\tpub timestamp: NaiveDateTime,\n\t/// Content of the message\n\tpub text: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","mod.rs"],"content":"use serde::{Deserialize, Serialize};\nuse sqlx::Type;\nuse utoipa::ToSchema;\n\npub mod account;\npub mod event_list;\npub mod itinerary;\npub mod message;\n\n/// Budget preference enum mapped to Postgres `budget_bucket`.\n/// Used in account preferences and returned by account APIs.\n/// - Fields:\n///   - Enum variants representing budget bands\n#[derive(Debug, Serialize, Deserialize, Clone, Type, ToSchema)]\n#[sqlx(type_name = \"budget_bucket\")]\npub enum BudgetBucket {\n\tVeryLowBudget,\n\tLowBudget,\n\tMediumBudget,\n\tHighBudget,\n\tLuxuryBudget,\n}\n\n/// Risk tolerance enum mapped to Postgres `risk_tolerence`.\n/// Used in account preferences and returned by account APIs.\n/// - Fields:\n///   - Enum variants representing risk appetite\n#[derive(Debug, Serialize, Deserialize, Clone, Type, ToSchema)]\n#[sqlx(type_name = \"risk_tolerence\")]\npub enum RiskTolerence {\n\tChillVibes,\n\tLightFun,\n\tAdventurer,\n\tRiskTaker,\n}\n\n/// The time of day the event will take place in the itinerary\n#[derive(Debug, Serialize, Deserialize, Clone, Type, PartialEq)]\n#[sqlx(type_name = \"time_of_day\")]\npub enum TimeOfDay {\n\tMorning,\n\tNoon,\n\tAfternoon,\n\tEvening,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","swagger.rs"],"content":"use axum::Router;\nuse std::fs::{self, File};\nuse std::io::Write;\nuse utoipa::{\n\tModify, OpenApi,\n\topenapi::security::{ApiKey, ApiKeyValue, SecurityScheme},\n};\nuse utoipa_axum::router::OpenApiRouter;\nuse utoipa_swagger_ui::SwaggerUi;\n\nuse crate::controllers::{account::AccountApiDoc, chat::ChatApiDoc, itinerary::ItineraryApiDoc};\n\n#[derive(OpenApi)]\n#[openapi(\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n    info(\n    \ttitle=\"Journey API\",\n    \tdescription = \"The public API documentation for the Journey web application.\"\n    ),\n    nest(\n    \t(path=\"/api/account\", api=AccountApiDoc),\n    \t(path=\"/api/chat\", api=ChatApiDoc),\n    \t(path=\"/api/itinerary\", api=ItineraryApiDoc)\n    ),\n    servers(\n    \t(url=\"http://localhost:3001\", description=\"Local host server for development\"),\n     \t//TODO add deployed production server URL\n    )\n)]\nstruct ApiDoc;\n\npub struct SecurityAddon;\n\nimpl Modify for SecurityAddon {\n\tfn modify(\u0026self, openapi: \u0026mut utoipa::openapi::OpenApi) {\n\t\tif let Some(components) = openapi.components.as_mut() {\n\t\t\tcomponents.add_security_scheme(\n                \"set-cookie\",\n                SecurityScheme::ApiKey(ApiKey::Cookie(ApiKeyValue::with_description(\n                \t\"auth-token\",\n                 \t\"An HTTP-only cookie which must encode a valid account id, expiration timestamp, and other information\"\n                ))),\n            )\n\t\t}\n\t}\n}\n\n/// Merges swagger with the current routes\npub fn merge_swagger(router: OpenApiRouter) -\u003e Router {\n\tlet doc = ApiDoc::openapi();\n\tfs::create_dir_all(\"docs\").unwrap();\n\tlet mut file = File::create(\"docs/openapi.json\").unwrap();\n\tfile.write_all(doc.to_pretty_json().unwrap().as_bytes())\n\t\t.unwrap();\n\tlet (router, api) = OpenApiRouter::with_openapi(doc)\n\t\t.merge(router)\n\t\t.split_for_parts();\n\trouter.merge(SwaggerUi::new(\"/swagger\").url(\"/docs/openapi.json\", api.clone()))\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","tests.rs"],"content":"use crate::{\n\tcontrollers, db,\n\tglobal::*,\n\thttp_models::{\n\t\taccount::{LoginRequest, SignupRequest, UpdateRequest},\n\t\titinerary::Itinerary,\n\t\tmessage::{MessagePageRequest, SendMessageRequest, UpdateMessageRequest},\n\t},\n\tlog,\n\tmiddleware::AuthUser,\n\tsql_models::{BudgetBucket, RiskTolerence},\n};\nuse argon2::{\n\tArgon2,\n\tpassword_hash::{PasswordHash, PasswordHasher, PasswordVerifier, SaltString, rand_core::OsRng},\n};\nuse axum::{Extension, Json, Router};\nuse chrono::{NaiveDate, Utc};\nuse serde_json::json;\nuse serial_test::serial;\nuse sqlx::{PgPool, migrate};\nuse std::{\n\tfs,\n\tio::Write,\n\tpath::Path,\n\ttime::{Duration, SystemTime},\n};\nuse tokio::net::TcpListener;\nuse tower_cookies::{\n\tCookie, CookieManagerLayer, Key,\n\tcookie::{CookieJar, SameSite, time},\n};\nuse tracing::{error, info, trace};\n\n// UNIT TESTS\n\n/// Test password verification logic\n#[test]\nfn test_password_verification() {\n\tlet password = \"test_password123\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hash the password\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify correct password\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// Verify incorrect password fails\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"wrong_password\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test token generation format\n#[test]\nfn test_token_generation() {\n\tlet user_id = 42;\n\tlet token = format!(\"user-{}.exp.sign\", user_id);\n\tassert_eq!(token, \"user-42.exp.sign\");\n\tassert!(token.starts_with(\"user-\"));\n\tassert!(token.ends_with(\".exp.sign\"));\n}\n\n/// Test cookie security settings\n#[test]\nfn test_cookie_security_development() {\n\tlet token_value = \"test-token-123\";\n\tlet on_production = false;\n\tlet domain = \"localhost\";\n\n\tlet cookie = Cookie::build((\"auth-token\", token_value))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.max_age(time::Duration::days(3))\n\t\t.build();\n\n\tassert_eq!(cookie.name(), \"auth-token\");\n\tassert_eq!(cookie.value(), token_value);\n\tassert_eq!(cookie.path(), Some(\"/\"));\n\tassert_eq!(cookie.http_only(), Some(true));\n\tassert_eq!(cookie.same_site(), Some(SameSite::Lax));\n\tassert!(!cookie.secure().unwrap_or(false));\n}\n\n/// Test cookie security settings for production\n#[test]\nfn test_cookie_security_production() {\n\tlet token_value = \"test-token-456\";\n\tlet on_production = true;\n\tlet domain = \"example.com\";\n\n\tlet cookie = Cookie::build((\"auth-token\", token_value))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.max_age(time::Duration::days(3))\n\t\t.build();\n\n\tassert_eq!(cookie.name(), \"auth-token\");\n\tassert_eq!(cookie.value(), token_value);\n\tassert_eq!(cookie.http_only(), Some(true));\n\tassert_eq!(cookie.same_site(), Some(SameSite::Strict));\n\tassert!(cookie.secure().unwrap_or(false));\n}\n\n/// Test password hashing for signup\n#[test]\nfn test_signup_password_hashing() {\n\tlet password = \"secure_password_123\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hash the password (as done in signup)\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify the hash is not the same as the plain password\n\tassert_ne!(password_hash, password);\n\n\t// Verify the hash starts with expected format\n\tassert!(password_hash.starts_with(\"$argon2\"));\n\n\t// Verify we can verify the password later (as in login)\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n}\n\n/// Test that different salts produce different hashes\n#[test]\nfn test_signup_different_salts() {\n\tlet password = \"same_password\";\n\tlet argon2 = Argon2::default();\n\n\t// Generate two hashes with different salts\n\tlet salt1 = SaltString::generate(\u0026mut OsRng);\n\tlet hash1 = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt1)\n\t\t.unwrap()\n\t\t.to_string();\n\n\tlet salt2 = SaltString::generate(\u0026mut OsRng);\n\tlet hash2 = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt2)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Hashes should be different due to different salts\n\tassert_ne!(hash1, hash2);\n\n\t// But both should verify the same password\n\tlet parsed_hash1 = PasswordHash::new(\u0026hash1).unwrap();\n\tlet parsed_hash2 = PasswordHash::new(\u0026hash2).unwrap();\n\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash1)\n\t\t\t.is_ok()\n\t);\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash2)\n\t\t\t.is_ok()\n\t);\n}\n\n/// Test that password hash cannot be reversed to plain text\n#[test]\nfn test_signup_hash_irreversibility() {\n\tlet password = \"my_secret_password_456\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Hash should not contain the plain password\n\tassert!(!password_hash.contains(password));\n\n\t// Hash should be significantly longer than input\n\tassert!(password_hash.len() \u003e password.len() * 2);\n}\n\n/// Test that any password can be hashed (even if it wouldn't pass validation)\n#[test]\nfn test_password_hashing_mechanism() {\n\t// Test that the hashing algorithm works with any input\n\tlet test_password = \"abc\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hashing mechanism should work regardless of validation rules\n\tlet result = argon2.hash_password(test_password.as_bytes(), \u0026salt);\n\tassert!(result.is_ok());\n\n\tlet password_hash = result.unwrap().to_string();\n\n\t// Verify the hash works\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(test_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// But wrong password should fail\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"wrong\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test password with special ASCII characters\n#[test]\nfn test_signup_special_characters_password() {\n\t// Only ASCII special characters are allowed\n\tlet special_password = \"Passw0rd!@#$%\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(special_password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify special characters are handled correctly\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(special_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// Wrong password should fail\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"Passw0rd!@#$\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test maximum allowed password length (128 chars)\n#[test]\nfn test_signup_max_password_length() {\n\t// 128 characters with required complexity\n\tlet max_password = \"A\".to_string() + \u0026\"a\".repeat(126) + \"1\";\n\tassert_eq!(max_password.len(), 128);\n\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(max_password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify max length password works\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(max_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n}\n\n#[test]\nfn test_validate_email() {\n\t// valid\n\tassert!(SignupRequest::validate_email(\"user@example.com\"));\n\tassert!(SignupRequest::validate_email(\"test.user@domain.co.uk\"));\n\tassert!(SignupRequest::validate_email(\"name+tag@company.org\"));\n\tassert!(SignupRequest::validate_email(\"user123@test-domain.com\"));\n\n\t// invalid\n\tassert!(!SignupRequest::validate_email(\"\"));\n\tassert!(!SignupRequest::validate_email(\"notanemail\"));\n\tassert!(!SignupRequest::validate_email(\"@example.com\"));\n\tassert!(!SignupRequest::validate_email(\"user@\"));\n\tassert!(!SignupRequest::validate_email(\"user@.com\"));\n\tassert!(!SignupRequest::validate_email(\"user @example.com\"));\n\tassert!(!SignupRequest::validate_email(\"user@exam ple.com\"));\n}\n\n#[test]\nfn test_validate_password() {\n\t// valid\n\tassert!(SignupRequest::validate_password(\"Password1\").is_ok());\n\tassert!(SignupRequest::validate_password(\"MySecure123\").is_ok());\n\tassert!(SignupRequest::validate_password(\"Passw0rd!@#\").is_ok());\n\tassert!(SignupRequest::validate_password(\"LongerPassword123\").is_ok());\n\n\t// too short\n\tlet result = SignupRequest::validate_password(\"Pass1\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must be at least 8 characters long\"\n\t);\n\n\t// no uppercase\n\tlet result = SignupRequest::validate_password(\"password123\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one uppercase letter\"\n\t);\n\n\t// no lowercase\n\tlet result = SignupRequest::validate_password(\"PASSWORD123\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one lowercase letter\"\n\t);\n\n\t// no number\n\tlet result = SignupRequest::validate_password(\"PasswordOnly\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one number\"\n\t);\n\n\t// too long\n\tlet password = \"A\".repeat(129) + \"1a\";\n\tlet result = SignupRequest::validate_password(\u0026password);\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must be 128 characters or less\"\n\t);\n\n\t// non ascii\n\tlet result = SignupRequest::validate_password(\"Password1パスワード\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain only ASCII characters\"\n\t);\n\n\t// emoji\n\tlet result = SignupRequest::validate_password(\"Password1🔒\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain only ASCII characters\"\n\t);\n\n\t// max length allowed\n\t// Test that exactly 128 characters is okay (with required chars)\n\tlet password = \"A\".to_string() + \u0026\"a\".repeat(126) + \"1\";\n\tassert_eq!(password.len(), 128);\n\tassert!(SignupRequest::validate_password(\u0026password).is_ok());\n}\n\n#[test]\nfn test_validate_signup_payload() {\n\t// valid\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tassert!(payload.validate().is_ok());\n\n\t// empty email\n\tlet payload = SignupRequest {\n\t\temail: \"\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Email is required\");\n\n\t// invalid email\n\tlet payload = SignupRequest {\n\t\temail: \"not-an-email\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Invalid email format\");\n\n\t// empty first name\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"First name is required\");\n\n\t// empty last name\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Last name is required\");\n\n\t// first name too long\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"a\".repeat(51),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"First name must be 50 characters or less\"\n\t);\n\n\t// last name too long\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"a\".repeat(51),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Last name must be 50 characters or less\"\n\t);\n\n\t// weak password\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"weak\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert!(result.unwrap_err().contains(\"Password\"));\n\n\t// whitespace trimming\n\tlet payload = SignupRequest {\n\t\temail: \"  test@example.com  \".to_string(),\n\t\tfirst_name: \"  John  \".to_string(),\n\t\tlast_name: \"  Doe  \".to_string(),\n\t\tpassword: \"Password123\".to_string(), // Valid ASCII password\n\t};\n\t// Email and names should be validated after trimming whitespace\n\tassert!(payload.validate().is_ok());\n}\n\n/// Verifies that `db::create_pool` panics when `DATABASE_URL` is not set.\n#[test]\n#[serial(db)]\nfn test_db_pool_panics_without_env() {\n\t// Save and clear DATABASE_URL\n\tlet prev = std::env::var(\"DATABASE_URL\").ok();\n\tunsafe {\n\t\tstd::env::remove_var(\"DATABASE_URL\");\n\t}\n\n\tlet result = std::panic::catch_unwind(|| {\n\t\tlet rt = tokio::runtime::Runtime::new().unwrap();\n\t\trt.block_on(async {\n\t\t\t// Should panic due to missing env var\n\t\t\tlet _ = db::create_pool().await;\n\t\t});\n\t});\n\n\t// Restore DATABASE_URL\n\tmatch prev {\n\t\tSome(val) =\u003e unsafe { std::env::set_var(\"DATABASE_URL\", val) },\n\t\tNone =\u003e unsafe { std::env::remove_var(\"DATABASE_URL\") },\n\t}\n\n\tassert!(result.is_err());\n}\n\n/// Optional integration test requiring a real database in `DATABASE_URL`.\n/// Run with: `cargo test -- --ignored`\n#[tokio::test]\n#[ignore]\n#[serial(db)]\nasync fn test_db_pool_connects_and_selects() {\n\tlet database_url = match std::env::var(\"DATABASE_URL\") {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e {\n\t\t\t// Not set in most environments; mark as success skip\n\t\t\tinfo!(\"DATABASE_URL not set; skipping real DB test\");\n\t\t\treturn;\n\t\t}\n\t};\n\n\t// Ensure env var is present for this test\n\tunsafe {\n\t\tstd::env::set_var(\"DATABASE_URL\", database_url);\n\t}\n\n\tlet pool = db::create_pool().await;\n\n\t// Simple liveness query\n\tlet row: (i32,) = sqlx::query_as(\"SELECT 1\")\n\t\t.fetch_one(\u0026pool)\n\t\t.await\n\t\t.expect(\"SELECT 1 should succeed\");\n\tassert_eq!(row.0, 1);\n}\n\n/// Verifies that `logs/latest.log` is created and written to from log events.\n#[test]\n#[serial(log)]\nfn test_logger() {\n\t//dotenv doesn't work in github actions bc .env is ignored\n\tunsafe {\n\t\t// Safety\n\t\t//\n\t\t// Always safe on Windows.\n\t\t//\n\t\t// Other platforms: risk of race condition in multi-threaded environment.\n\t\t// We are not reading/writing this environment variable from multiple threads, so we're good.\n\t\tstd::env::set_var(\"RUST_LOG\", \"warn,Capping2025=debug\");\n\t}\n\tlet latest_log_path = Path::new(LOG_DIR).join(LATEST_LOG);\n\tlog::init_logger();\n\ttrace!(\"Test trace\");\n\terror!(\"Test error\");\n\tlog::log_writer().flush().unwrap();\n\t//wait for IO to finish because flushing doesn't work?\n\tstd::thread::sleep(Duration::from_millis(10));\n\tlet logs = fs::read_to_string(latest_log_path).unwrap();\n\tinfo!(\"{logs}\");\n\tassert!(logs.len() \u003e 0);\n}\n\n/// Verifies that `logs/crash.log` is created and written to on a panic.\n#[test]\n#[serial(panic_log)]\nfn test_panic_handler() {\n\tlog::init_panic_handler();\n\tstd::panic::catch_unwind(|| {\n\t\tpanic!(\"Test panic\");\n\t})\n\t.unwrap_err();\n\tlet content = fs::read_to_string(Path::new(LOG_DIR).join(CRASH_LOG)).unwrap();\n\tassert!(content.len() \u003e 0);\n}\n\n/// It's easier to have all these in 1 test to share a db pool, and we don't have to spin up a server\n#[tokio::test]\n#[serial(db)]\nasync fn test_controllers() {\n\t_ = dotenvy::dotenv();\n\tlet cookies = CookieJar::new();\n\tlet key = Extension(Key::derive_from(\u0026[0u8; 32]));\n\tlet pool = Extension(db::create_pool().await);\n\n\t_ = tokio::join!(\n\t\ttest_signup_conflict_on_duplicate_email(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_http_login_invalid_credentials(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_current_endpoint_returns_account(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_returns_account(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_partial_fields(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_with_preferences(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_get_itinerary_id_not_found(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_invalid_signup_email(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_saved_itineraries_endpoint(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_save_itineraries(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_chat_flow(cookies.clone(), key.clone(), pool.clone()),\n\t);\n}\n\nasync fn test_signup_conflict_on_duplicate_email(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"dupe+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Bob\"),\n\t\tlast_name: String::from(\"Dupe\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// First signup should succeed\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json.clone())\n\t\t.await\n\t\t.unwrap();\n\t// Second signup with same email should 409\n\tassert_eq!(\n\t\tcontrollers::account::api_signup(\u0026mut cookies, key, pool, json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t409\n\t);\n}\n\nasync fn test_http_login_invalid_credentials(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"badEmail+{}@example.com\", unique);\n\tlet json = Json(LoginRequest {\n\t\temail,\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// attempt to login with nonexistant email\n\tassert_eq!(\n\t\tcontrollers::account::api_login(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\tlet email = format!(\"goodEmail+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail: email.clone(),\n\t\tfirst_name: String::from(\"Alice\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// signup\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\tlet json = Json(LoginRequest {\n\t\temail,\n\t\tpassword: String::from(\"ChickenNugget1234\"),\n\t});\n\t// attempt to login with a correct email, but the wrong password\n\tassert_eq!(\n\t\tcontrollers::account::api_login(\u0026mut cookies, key, pool, json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n}\n\nasync fn test_current_endpoint_returns_account(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"current+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Current\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\t// Test /current endpoint returns Account struct\n\t_ = controllers::account::api_current(pool.clone(), user)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_returns_account(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"update+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Update\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with all fields\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: Some(format!(\"updated+{}@example.com\", unique)),\n\t\tfirst_name: Some(String::from(\"Updated\")),\n\t\tlast_name: Some(String::from(\"User\")),\n\t\tpassword: Some(String::from(\"NewPassword123\")),\n\t\tbudget_preference: Some(BudgetBucket::HighBudget),\n\t\trisk_preference: Some(RiskTolerence::Adventurer),\n\t\tfood_allergies: Some(String::from(\"Peanuts, shellfish\")),\n\t\tdisabilities: Some(String::from(\"Wheelchair accessible\")),\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_partial_fields(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"partial+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Partial\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with only some fields\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: None,\n\t\tfirst_name: Some(String::from(\"PartiallyUpdated\")),\n\t\tlast_name: None,\n\t\tpassword: None,\n\t\tbudget_preference: None,\n\t\trisk_preference: None,\n\t\tfood_allergies: Some(String::from(\"Gluten\")),\n\t\tdisabilities: None,\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_with_preferences(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"prefs+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Prefs\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with enum preferences\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: None,\n\t\tfirst_name: None,\n\t\tlast_name: None,\n\t\tpassword: None,\n\t\tbudget_preference: Some(BudgetBucket::LuxuryBudget),\n\t\trisk_preference: Some(RiskTolerence::RiskTaker),\n\t\tfood_allergies: None,\n\t\tdisabilities: None,\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_get_itinerary_id_not_found(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"get_itinerary+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Get\"),\n\t\tlast_name: String::from(\"Itinerary\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /{id} endpoint with non-existent itinerary (should return 404)\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tassert_eq!(\n\t\tcontrollers::itinerary::api_get_itinerary(user, axum::extract::Path(999999), pool.clone())\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n}\n\nasync fn test_invalid_signup_email(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"invalid_email_{}\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Get\"),\n\t\tlast_name: String::from(\"Event\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tassert_eq!(\n\t\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n}\n\nasync fn test_saved_itineraries_endpoint(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"saved_itineraries+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /saved endpoint returns user's itineraries\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\t_ = controllers::itinerary::api_saved_itineraries(user, pool)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_save_itineraries(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"test_save_itinerary_new+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// save itinerary with id not in db\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(Itinerary {\n\t\tid: 0,\n\t\tstart_date: NaiveDate::parse_from_str(\"2025-01-01\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2025-12-31\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"Updated Title\"),\n\t});\n\tlet itinerary_id = controllers::itinerary::api_save(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap()\n\t\t.id;\n\tassert_ne!(itinerary_id, 0);\n\n\t// save itinerary with a matching id already in db\n\tlet json = Json(Itinerary {\n\t\tid: itinerary_id,\n\t\tstart_date: NaiveDate::parse_from_str(\"2026-01-01\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2026-12-31\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"2nd Updated Title\"),\n\t});\n\tassert_eq!(\n\t\tcontrollers::itinerary::api_save(user, pool, json)\n\t\t\t.await\n\t\t\t.unwrap()\n\t\t\t.id,\n\t\titinerary_id\n\t);\n}\n\nasync fn test_chat_flow(mut cookies: CookieJar, key: Extension\u003cKey\u003e, pool: Extension\u003cPgPool\u003e) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"test_latest_message_page+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// create new chat\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet first_chat_session_id = controllers::chat::api_new_chat(user, pool.clone())\n\t\t.await\n\t\t.unwrap()\n\t\t.chat_session_id;\n\tassert_ne!(first_chat_session_id, 0);\n\n\t// create chat session - reusing first one because it's empty\n\tlet chat_session_id = controllers::chat::api_new_chat(user, pool.clone())\n\t\t.await\n\t\t.unwrap()\n\t\t.chat_session_id;\n\tassert_eq!(first_chat_session_id, chat_session_id);\n\n\t// send a bunch of messages\n\tlet mut message_ids = [0; MESSAGE_PAGE_LEN as usize + 5];\n\tfor i in 0..MESSAGE_PAGE_LEN as usize + 5 {\n\t\tlet json = Json(SendMessageRequest {\n\t\t\tchat_session_id,\n\t\t\ttext: format!(\"Test msg {}\", i),\n\t\t\titinerary_id: None,\n\t\t});\n\t\tmessage_ids[i] = controllers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap()\n\t\t\t.user_message_id;\n\t\tassert_ne!(message_ids[i], 0);\n\t}\n\n\t// send empty message\n\tlet json = Json(SendMessageRequest {\n\t\tchat_session_id,\n\t\ttext: String::new(),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\t// send message invalid chat session\n\tlet json = Json(SendMessageRequest {\n\t\tchat_session_id: 0,\n\t\ttext: String::from(\"Test msg invalid chat session id\"),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n\n\t// get latest messages and make sure messages are in chronological order\n\tlet chat_session = controllers::chat::api_chats(user, pool.clone())\n\t\t.await\n\t\t.unwrap();\n\tlet chat_session = chat_session.0.chat_sessions.first().unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tlatest_page\n\t\t\t.0\n\t\t\t.message_page\n\t\t\t.is_sorted_by(|a, b| a.timestamp \u003c b.timestamp)\n\t);\n\n\t// get specific messages and make sure messages are in chronological order\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: Some(latest_page.message_page[0].id),\n\t});\n\tlet next_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tnext_page\n\t\t\t.0\n\t\t\t.message_page\n\t\t\t.is_sorted_by(|a, b| a.timestamp \u003c b.timestamp)\n\t);\n\tassert_eq!(\n\t\tlatest_page.message_page[0].id,\n\t\tnext_page.message_page.last().unwrap().id\n\t);\n\n\t// get page with invalid message id\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: Some(0),\n\t});\n\tlet empty_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(empty_page.message_page.len(), 0);\n\tassert_eq!(empty_page.prev_message_id, None);\n\n\t// get page with invalid chat session id\n\n\t// update message with empty text\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: message_ids[0],\n\t\tnew_text: String::new(),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_update_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\t// update message with invalid message id\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: 0,\n\t\tnew_text: String::from(\"Updated message\"),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_update_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n\n\t// update message\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: message_ids[0],\n\t\tnew_text: String::from(\"Updated message\"),\n\t\titinerary_id: None,\n\t});\n\t_ = controllers::chat::api_update_message(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(latest_page.prev_message_id, None);\n\tassert_eq!(latest_page.message_page.len(), 2);\n\n\t//delete chat session\n\tcontrollers::chat::api_delete_chat(user, pool.clone(), axum::extract::Path(chat_session_id))\n\t\t.await\n\t\t.unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool, json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(latest_page.prev_message_id, None);\n\tassert_eq!(latest_page.message_page.len(), 0);\n}\n\n// INTEGRATION TESTS\n\nstatic mut PORT: u16 = 0;\n\n#[tokio::test]\n#[serial(db, log, panic_log)]\nasync fn test_endpoints() {\n\t// Only use dotenvy for local testing\n\t// CI testing should use GitHub environment variables\n\t_ = dotenvy::dotenv();\n\n\t// Initialize project logger once so test logs are written to logs/latest.log\n\t// Set a default log level for tests if not provided\n\tif std::env::var(\"RUST_LOG\").is_err() {\n\t\tunsafe { std::env::set_var(\"RUST_LOG\", \"debug\") };\n\t}\n\tlog::init_panic_handler();\n\tlog::init_logger();\n\n\tlet pool = db::create_pool().await;\n\tmatch migrate!().run(\u0026pool).await {\n\t\tOk(_) =\u003e (),\n\t\tErr(sqlx::migrate::MigrateError::VersionMismatch(_)) =\u003e {\n\t\t\teprintln!(\"migrations version mismatch; assuming DB already prepared. Skipping.\");\n\t\t}\n\t\tErr(e) =\u003e panic!(\"migrations run: {e}\"),\n\t}\n\n\t// Build app\n\t// Use an encryption/signing key for private cookies\n\tlet cookie_key = Key::generate();\n\tlet account_routes = controllers::account::account_routes();\n\tlet itinerary_routes = controllers::itinerary::itinerary_routes();\n\tlet chat_routes = controllers::chat::chat_routes();\n\tlet api_routes = Router::new()\n\t\t.nest(\"/account\", account_routes)\n\t\t.nest(\"/itinerary\", itinerary_routes)\n\t\t.nest(\"/chat\", chat_routes);\n\tlet app = Router::new()\n\t\t.nest(\"/api\", api_routes)\n\t\t.layer(Extension(pool.clone()))\n\t\t.layer(Extension(cookie_key.clone()))\n\t\t.layer(CookieManagerLayer::new());\n\n\t// Bind to ephemeral port and spawn server\n\tlet listener = TcpListener::bind(\"127.0.0.1:0\")\n\t\t.await\n\t\t.expect(\"bind test server\");\n\tunsafe { PORT = listener.local_addr().unwrap().port() };\n\tlet server = axum::serve(listener, app.into_make_service()).into_future();\n\ttokio::spawn(server);\n\n\t// Any unit tests that test cookies or middleware, or any integration tests should go here.\n\t// Any other unit test should not go here. Instead, run it as a separate unit test and just invoke the controller directly.\n\ttokio::join!(\n\t\ttest_signup_and_login_happy_path(\u0026cookie_key),\n\t\ttest_auth_for_all_required(),\n\t\ttest_http_signup_and_login_flow(),\n\t\ttest_validate_with_bad_and_good_cookie(),\n\t\ttest_get_itinerary_invalid_format(),\n\t\ttest_signup_logout(),\n\t\t// just throw all the tests in here\n\t);\n}\n\nasync fn test_signup_and_login_happy_path(key: \u0026Key) {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"user+{}@example.com\", unique);\n\n\t// Signup\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Alice\",\n\t\t\t\t\"last_name\": \"Tester\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(resp.status().as_u16(), 200);\n\n\t// Login\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"user+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(resp.status().as_u16(), 200);\n\t// Extract cookie and decrypt via private jar\n\tlet set_cookie = resp.header(\"set-cookie\").unwrap();\n\t// Parse full Set-Cookie line (handles '=' inside value)\n\tlet parsed = Cookie::parse(set_cookie.to_string()).unwrap();\n\tlet mut jar = CookieJar::new();\n\tjar.add(parsed.clone());\n\tlet decrypted = jar.private(\u0026key).get(parsed.name()).unwrap();\n\t// token: user-\u003cid\u003e.\u003cexp\u003e.sign\n\tlet parts: Vec\u003c\u0026str\u003e = decrypted.value().split('.').collect();\n\tassert_eq!(parts.len(), 3);\n\tassert!(parts[0].starts_with(\"user-\"));\n\tassert_eq!(parts[2], \"sign\");\n\tlet exp: i64 = parts[1].parse().unwrap();\n\tlet now = chrono::Utc::now().timestamp();\n\tassert!(exp \u003e now);\n}\n\nasync fn test_auth_for_all_required() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\n\tlet account_update_payload = json!({});\n\tlet chat_message_page_payload = json!({\n\t\t\"chat_session_id\": 1,\n\t\t\"message_id\": 1\n\t});\n\tlet chat_update_message_payload = json!({\n\t\t\"message_id\": 1,\n\t\t\"new_text\": \"test\"\n\t});\n\tlet chat_send_message_payload = json!({\n\t\t\"chat_session_id\": 1,\n\t\t\"text\": \"test\"\n\t});\n\tlet itinerary_save_payload = json!({\n\t\t\"id\": 1,\n\t\t\"start_date\": \"2025-11-05 00:00:00\",\n\t\t\"end_date\": \"2025-11-10 00:00:00\",\n\t\t\"morning_events\": [],\n\t\t\"noon_events\": [],\n\t\t\"afternoon_events\": [],\n\t\t\"evening_events\": []\n\t});\n\n\tfor res in futures::future::join_all([\n\t\thc.do_get(\"/api/account/current\"),\n\t\thc.do_get(\"/api/account/validate\"),\n\t\thc.do_get(\"/api/account/logout\"),\n\t\thc.do_get(\"/api/chat/chats\"),\n\t\thc.do_get(\"/api/chat/newChat\"),\n\t\thc.do_get(\"/api/itinerary/saved\"),\n\t\thc.do_get(\"/api/itinerary/:id\"),\n\t])\n\t.await\n\t.iter()\n\t{\n\t\tassert_eq!(\n\t\t\tres.as_ref().unwrap().status().as_u16(),\n\t\t\t401,\n\t\t\t\"Protected route should require authentication\"\n\t\t);\n\t}\n\n\tfor res in futures::future::join_all([\n\t\thc.do_post(\"/api/account/update\", account_update_payload),\n\t\thc.do_post(\"/api/chat/messagePage\", chat_message_page_payload),\n\t\thc.do_post(\"/api/chat/updateMessage\", chat_update_message_payload),\n\t\thc.do_post(\"/api/chat/sendMessage\", chat_send_message_payload),\n\t\thc.do_post(\"/api/itinerary/save\", itinerary_save_payload),\n\t])\n\t.await\n\t.iter()\n\t{\n\t\tassert_eq!(\n\t\t\tres.as_ref().unwrap().status().as_u16(),\n\t\t\t401,\n\t\t\t\"Protected route should require authentication\"\n\t\t);\n\t}\n}\n\nasync fn test_http_signup_and_login_flow() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"user+{}@example.com\", unique);\n\n\t// Signup\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Alice\",\n\t\t\t\t\"last_name\": \"Tester\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tresp.status().is_success(),\n\t\t\"signup failed: {}\",\n\t\tresp.status()\n\t);\n\n\t// Login\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"user+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tresp.status().is_success(),\n\t\t\"login failed: {}\",\n\t\tresp.status()\n\t);\n}\n\nasync fn test_validate_with_bad_and_good_cookie() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\t// No cookie (treated similarly to bad/invalid cookie): expect unauthorized\n\tlet resp = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tresp.status().as_u16(),\n\t\t401,\n\t\t\"Missing/invalid cookie should return 401\"\n\t);\n\n\t// Good cookie: create user and login to receive a valid private cookie, then validate\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"cookie+{}@example.com\", unique);\n\n\tlet signup = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Cook\",\n\t\t\t\t\"last_name\": \"Ie\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup.status().as_u16(), 200);\n\n\tlet login = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"cookie+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(login.status().as_u16(), 200);\n\n\t// Client should now hold the private cookie; call validate and expect 200\n\tlet resp = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tresp.status().as_u16(),\n\t\t200,\n\t\t\"/validate with good cookie should return 200\"\n\t);\n}\n\nasync fn test_get_itinerary_invalid_format() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"get_itinerary+{}@example.com\", unique);\n\n\t// Signup user\n\tlet signup_resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Get\",\n\t\t\t\t\"last_name\": \"Itinerary\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup_resp.status().as_u16(), 200);\n\n\t// Test with invalid ID format (should return 400)\n\tlet invalid_resp = hc.do_get(\"/api/itinerary/invalid\").await.unwrap();\n\tassert_eq!(invalid_resp.status().as_u16(), 400);\n}\n\nasync fn test_signup_logout() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"login_then_logout+{}@example.com\", unique);\n\n\t// Signup user\n\tlet signup_resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Get\",\n\t\t\t\t\"last_name\": \"Event\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup_resp.status().as_u16(), 200);\n\n\tlet cookie = signup_resp.res_cookie(\"auth-token\").unwrap();\n\tassert!(cookie.expires.unwrap() \u003e SystemTime::now());\n\n\t// Logout\n\tlet logout_resp = hc.do_get(\"/api/account/logout\").await.unwrap();\n\tassert_eq!(logout_resp.status().as_u16(), 200);\n\n\tlet cookie = logout_resp.res_cookie(\"auth-token\").unwrap();\n\tassert!(cookie.expires.unwrap() \u003c SystemTime::now());\n\n\t// Hit any protected route\n\tlet validate_res = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tvalidate_res.status().as_u16(),\n\t\t401,\n\t\t\"Missing/invalid cookie should return 401\"\n\t);\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","account.rs"],"content":"/*\n * src/controllers/account.rs\n *\n * File for Account Controller API Endpoints\n *\n * Purpose:\n *   Serve Account Related API Requests\n */\n\nuse argon2::{\n\tArgon2,\n\tpassword_hash::{PasswordHash, PasswordHasher, PasswordVerifier, SaltString, rand_core::OsRng},\n};\nuse axum::{\n\tExtension, Json,\n\trouting::{get, post},\n};\n#[cfg(test)]\nuse tower_cookies::cookie::CookieJar;\nuse tower_cookies::{\n\tCookie, Cookies,\n\tcookie::{\n\t\tKey, SameSite,\n\t\ttime::{Duration, OffsetDateTime},\n\t},\n};\n\nuse sqlx::PgPool;\nuse tracing::debug;\nuse utoipa::OpenApi;\n\nuse crate::http_models::account::*;\nuse crate::middleware::{AuthUser, middleware_auth};\nuse crate::{\n\tcontrollers::AxumRouter,\n\terror::{ApiResult, AppError},\n\tsql_models::{BudgetBucket, RiskTolerence, account::AccountRow},\n\tswagger::SecurityAddon,\n};\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_signup,\n\t\tapi_login,\n\t\tapi_logout,\n\t\tapi_validate,\n\t\tapi_update,\n\t\tapi_current\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n    info(\n    \ttitle=\"Account Routes\",\n    \tdescription = \"API endpoints dealing with authentication and account info.\"\n    ),\n    tags((name=\"Account\"))\n)]\npub struct AccountApiDoc;\n\npub trait CookieStore {\n\tfn private_add(\u0026mut self, key: \u0026Key, cookie: Cookie\u003c'static\u003e);\n}\nimpl CookieStore for Cookies {\n\t#[inline(always)]\n\tfn private_add(\u0026mut self, key: \u0026Key, cookie: Cookie\u003c'static\u003e) {\n\t\tself.private(key).add(cookie)\n\t}\n}\n#[cfg(test)]\nimpl CookieStore for CookieJar {\n\t#[inline(always)]\n\tfn private_add(\u0026mut self, _key: \u0026Key, cookie: Cookie\u003c'static\u003e) {\n\t\tself.add(cookie)\n\t}\n}\n\n/// Creates and sets the cookie containing the hashed account id, expiration time, and other data.\n///\n/// Notes:\n/// - Token format is `user-\u003cid\u003e.\u003cexp\u003e.sign`, where `\u003cexp\u003e` is epoch seconds (UTC) ~3 days out.\n/// - Cookie name is `auth-token`; in development it uses `SameSite=Lax`, not `Secure`.\nfn set_cookie(account_id: i32, expired: bool, cookies: \u0026mut impl CookieStore, key: \u0026Key) {\n\t// Create token and set cookie as before\n\tlet domain = option_env!(\"DOMAIN\").unwrap_or(\"localhost\");\n\tlet app_env = option_env!(\"APP_ENV\").unwrap_or(\"development\");\n\tlet on_production = app_env == \"production\";\n\n\t// Create a token value (in a real app, this would be a JWT or similar)\n\t// Embed expiration epoch seconds inside the token for server-side validation\n\tlet (expires, max_age) = if expired {\n\t\t(OffsetDateTime::UNIX_EPOCH, Duration::days(0))\n\t} else {\n\t\tlet age = Duration::days(3);\n\t\t(OffsetDateTime::now_utc() + age, age)\n\t};\n\tlet token_value = format!(\"user-{}.{}.sign\", account_id, expires.unix_timestamp());\n\n\tdebug!(\n\t\t\"INFO -\u003e\u003e Generated token: {}. Production is: {}\",\n\t\ttoken_value, on_production\n\t);\n\n\t// Build the cookie with enhanced security\n\t// Store encrypted (private) cookie so value is confidential and authenticated\n\tlet cookie = Cookie::build((\"auth-token\", token_value.clone()))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.expires(Some(expires))\n\t\t.max_age(max_age)\n\t\t.build();\n\n\t// encrypt/sign cookie (private cookie via CookieManagerLayer key)\n\tcookies.private_add(key, cookie);\n}\n\n/// Create a new user.\n///\n/// # Method\n/// `POST /api/account/signup`\n///\n/// # Request Body\n/// - `email`: A valid email address (string, required).\n/// - `first_name`: The user's first name (string, required).\n/// - 'last_name': The user's last name (string, required).\n/// - 'password': The user's password (string, required).\n///\n/// # Responses\n/// - `200 OK` - Signup successful\n/// - `400 BAD_REQUEST` - Validation failure (public error)\n/// - `409 CONFLICT` - Email already exists (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/signup\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///        \"email\": \"alice@example.com\",\n///        \"first_name\": \"alice\",\n///        \"last_name\": \"grace\",\n///        \"password\": \"password123.\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/signup\",\n\tsummary=\"Create a new account\",\n\tdescription=\"Inserts account details into db (if email isn't already taken), and returns with a cookie.\",\n\trequest_body(\n\t\tcontent=SignupRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Email must not already be taken. Password must be in plaintext.\",\n\t\texample=json!({\n\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\"first_name\": \"First\",\n\t\t\t\"last_name\": \"Last\",\n\t\t\t\"password\": \"Password_123\"\n\t\t})\n\t),\n\tresponses(\n\t\t(status=200, description=\"Account successfully created\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=409, description=\"Email already in use\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n\ttag=\"Account\"\n)]\npub async fn api_signup\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(payload): Json\u003cSignupRequest\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/signup 'api_signup' - Payload: {:?}\",\n\t\tpayload\n\t);\n\n\t// Validate input\n\tif let Err(validation_error) = payload.validate() {\n\t\treturn Err(AppError::Validation(validation_error));\n\t}\n\n\t// Check if user already exists\n\tlet existing_user_result =\n\t\tsqlx::query!(\"SELECT id FROM accounts WHERE email = $1\", payload.email)\n\t\t\t.fetch_optional(\u0026pool)\n\t\t\t.await;\n\n\tmatch existing_user_result {\n\t\tOk(Some(_)) =\u003e {\n\t\t\treturn Err(AppError::Conflict(\"email already exists\".to_string()));\n\t\t}\n\t\tErr(e) =\u003e {\n\t\t\treturn Err(AppError::from(e));\n\t\t}\n\t\tOk(None) =\u003e {\n\t\t\t// User doesn't exist, proceed with signup\n\t\t}\n\t}\n\n\t// Hash the password\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\tlet password_hash = argon2\n\t\t.hash_password(payload.password.as_bytes(), \u0026salt)\n\t\t.map_err(|e| AppError::from(e))?\n\t\t.to_string();\n\n\t// Insert new user into database\n\tlet insert_result = sqlx::query!(\n\t\t\"INSERT INTO accounts (email, first_name, last_name, password)\n         VALUES ($1, $2, $3, $4)\n         RETURNING id\",\n\t\tpayload.email,\n\t\tpayload.first_name,\n\t\tpayload.last_name,\n\t\tpassword_hash\n\t)\n\t.fetch_one(\u0026pool)\n\t.await;\n\n\tmatch insert_result {\n\t\tOk(record) =\u003e {\n\t\t\tdebug!(\n\t\t\t\t\"INFO -\u003e\u003e /api/account/signup 'api_signup' - Created user with id: {}\",\n\t\t\t\trecord.id\n\t\t\t);\n\n\t\t\tset_cookie(record.id, false, cookies, \u0026key);\n\n\t\t\tOk(())\n\t\t}\n\t\tErr(e) =\u003e Err(AppError::from(e)),\n\t}\n}\n\n/// Attempt user login\n///\n/// # Method\n/// `POST /api/account/login`\n///\n/// # Request Body\n/// - `email`: A valid email address (string, required).\n/// - 'password': The user's password (string, required).\n///\n/// # Responses\n/// - `200 OK` - Login successful with private cookie set\n/// - `400 BAD_REQUEST` - Invalid credentials (public error)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/login\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///        \"email\": \"alice@example.com\",\n///        \"password\": \"password123.\"\n///       }'\n/// ```\n///\n/// Notes:\n/// - Token format is `user-\u003cid\u003e.\u003cexp\u003e.sign`, where `\u003cexp\u003e` is epoch seconds (UTC) ~3 days out.\n/// - Cookie name is `auth-token`; in development it uses `SameSite=Lax`, not `Secure`.\n#[utoipa::path(\n\tpost,\n\tpath=\"/login\",\n\tsummary=\"Attempt user login\",\n\tdescription=\"Attempts to login and return with a cookie.\",\n\trequest_body(\n\t\tcontent=LoginRequest,\n\t\tcontent_type=\"application/json\",\n\t\texample=json!({\n\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\"password\": \"Password_123\"\n\t\t})\n\t),\n\tresponses(\n\t\t(status=200, description=\"Login succeeded\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n\ttag=\"Account\"\n)]\npub async fn api_login\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(payload): Json\u003cLoginRequest\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/login 'api_login' - Payload: {:?}\",\n\t\tpayload\n\t);\n\n\t// Get user from database as Account\n\tlet user_result = sqlx::query_as!(\n\t\tAccountRow,\n\t\tr#\"\n        SELECT\n            id,\n            email,\n            password\n        FROM accounts\n        WHERE email = $1\n        \"#,\n\t\tpayload.email\n\t)\n\t.fetch_one(\u0026pool)\n\t.await;\n\n\tmatch user_result {\n\t\tOk(result) =\u003e {\n\t\t\t// Verify password\n\t\t\tlet parsed_hash = PasswordHash::new(\u0026result.password).map_err(|e| AppError::from(e))?;\n\n\t\t\t// Attempt to match the password hashes\n\t\t\tif let Err(_) =\n\t\t\t\tArgon2::default().verify_password(payload.password.as_bytes(), \u0026parsed_hash)\n\t\t\t{\n\t\t\t\treturn Err(AppError::BadRequest(\"invalid credentials\".to_string()));\n\t\t\t}\n\n\t\t\tset_cookie(result.id, false, cookies, \u0026key);\n\n\t\t\treturn Ok(());\n\t\t}\n\t\tErr(_) =\u003e {\n\t\t\treturn Err(AppError::BadRequest(\"invalid credentials\".to_string()));\n\t\t}\n\t}\n}\n\n/// Returns whether the user has a valid auth token.\n/// Hit this route to validate the `auth-token` private cookie.\n///\n/// # Method\n/// `GET /api/account/validate`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - user has a valid auth token\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n#[utoipa::path(\n\tget,\n\tpath=\"/validate\",\n\tsummary=\"Whether the user has a valid auth-token\",\n\tdescription=\"Returns 200 if token is valid, or 401 if invalid or nonexistant.\",\n\tresponses(\n\t\t(status=200, description=\"User has a valid cookie\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_validate(Extension(user): Extension\u003cAuthUser\u003e) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/validate 'api_validate' - User ID: {}\",\n\t\tuser.id\n\t);\n\tOk(())\n}\n\n/// Get information about the user\n///\n/// # Method\n/// `GET /api/account/current`\n///\n/// # Responses\n/// - `200 OK` - with body: [CurrentResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/account/current\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/current\",\n\tsummary=\"Get account information\",\n\tdescription=\"Returns the user's non-sensitive account information.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"User's non-sensitive account information\",\n\t\t\tbody=CurrentResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\t\"first_name\": \"First\",\n\t\t\t\t\"last_name\": \"Last\",\n\t\t\t\t\"budget_preference\": \"MediumBudget\",\n\t\t\t\t\"risk_preference\": \"Adventurer\",\n\t\t\t\t\"food_allergies\": \"peanuts,vegetarian,pollen\",\n\t\t\t\t\"disabilities\": \"knee replacement\"\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_current(\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n) -\u003e ApiResult\u003cJson\u003cCurrentResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/current 'api_current' - User ID: {}\",\n\t\tuser.id\n\t);\n\t// Load current user's full account row\n\tlet account = sqlx::query_as!(\n\t\tCurrentResponse,\n\t\tr#\"\n        SELECT\n            email,\n            first_name,\n            last_name,\n            budget_preference as \"budget_preference: BudgetBucket\",\n            risk_preference as \"risk_preference: RiskTolerence\",\n            food_allergies,\n            disabilities\n        FROM accounts\n        WHERE id = $1\n        \"#,\n\t\tuser.id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(Json(account))\n}\n\n/// Update information about the user\n///\n/// # Method\n/// `POST /api/account/update`\n///\n/// # Request Body\n/// - `email`: A valid email address (string).\n/// - 'first_name': The user's first name (string).\n/// - 'last_name': The user's last name (string).\n/// - 'password': The user's password (string).\n/// - 'budget_preference': The user's budget preference (string).\n/// - 'risk_preference': The user's risk preference (string).\n/// - 'food_allergies': The user's allergies (string).\n/// - 'disabilities': The user's disabilities (string).\n///\n/// # Responses\n/// - `200 OK` - with body: [UpdateResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/account/update\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"email\": \"\",\n///         \"first_name\": \"\",\n///         \"last_name\": \"\",\n///         \"password\": \"\",\n///         \"budget_preference\": \"\",\n///         \"risk_preference\": \"\",\n///         \"food_allergies\": \"\",\n///         \"disabilities\": \"\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/update\",\n\tsummary=\"Update information about the user\",\n\tdescription=\"Update account info with provided data.\",\n\trequest_body(\n\t\tcontent=UpdateRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Non-null fields will update that field. Null fields will not update that field.\",\n\t\texample=json!({\n\t\t\t\"budget_preference\": \"LowBudget\"\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Account info updated successfully\",\n\t\t\tbody=UpdateResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"email\": \"example@gmail.com\",\n\t\t\t\t\"first_name\": \"First\",\n\t\t\t\t\"last_name\": \"last\",\n\t\t\t\t\"budget_preference\": \"LowBudget\",\n\t\t\t\t\"risk_preference\": \"Adventurer\",\n\t\t\t\t\"food_allergies\": \"peanuts,vegetarian,pollen\",\n\t\t\t\t\"disabilities\": \"knee replacement\"\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_update(\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tJson(payload): Json\u003cUpdateRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cUpdateResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/update 'api_update' - User ID: {} Payload: {:?}\",\n\t\tuser.id, payload\n\t);\n\n\t// If password provided, hash it before update\n\tlet hashed_password: Option\u003cString\u003e = if let Some(pw) = \u0026payload.password {\n\t\tlet salt = SaltString::generate(\u0026mut OsRng);\n\t\tlet argon2 = Argon2::default();\n\t\tSome(\n\t\t\targon2\n\t\t\t\t.hash_password(pw.as_bytes(), \u0026salt)\n\t\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t\t.to_string(),\n\t\t)\n\t} else {\n\t\tNone\n\t};\n\n\tlet account = sqlx::query_as!(\n\t\tUpdateResponse,\n\t\tr#\"\n        UPDATE accounts SET\n            email = COALESCE($1, email),\n            first_name = COALESCE($2, first_name),\n            last_name = COALESCE($3, last_name),\n            password = COALESCE($4, password),\n            budget_preference = COALESCE($5, budget_preference),\n            risk_preference = COALESCE($6, risk_preference),\n            food_allergies = COALESCE($7, food_allergies),\n            disabilities = COALESCE($8, disabilities)\n        WHERE id = $9\n        RETURNING\n            email,\n            first_name,\n            last_name,\n            budget_preference as \"budget_preference: BudgetBucket\",\n            risk_preference as \"risk_preference: RiskTolerence\",\n            food_allergies,\n            disabilities\n        \"#,\n\t\tpayload.email,\n\t\tpayload.first_name,\n\t\tpayload.last_name,\n\t\thashed_password,\n\t\tpayload.budget_preference as Option\u003cBudgetBucket\u003e,\n\t\tpayload.risk_preference as Option\u003cRiskTolerence\u003e,\n\t\tpayload.food_allergies,\n\t\tpayload.disabilities,\n\t\tuser.id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(Json(account))\n}\n\n/// Logout by setting cookie to expired.\n///\n/// # Method\n/// `GET /api/account/logout`\n///\n/// # Responses\n/// - `200 OK` - with body: [UpdateResponse]\n/// - `401 UNAUTHORIZED` - Invalid credentials (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/account/logout\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/logout\",\n\tsummary=\"Logout by returning with expired cookie\",\n\tdescription=\"Sets the HTTP-only cookie as expired, which deauthenticates the user.\",\n\tresponses(\n\t\t(status=200, description=\"Logged out successfully\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Account\"\n)]\npub async fn api_logout\u003cC: CookieStore\u003e(\n\tcookies: \u0026mut C,\n\tExtension(key): Extension\u003cKey\u003e,\n\tExtension(user): Extension\u003cAuthUser\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/account/logout 'api_logout' - User ID: {}\",\n\t\tuser.id\n\t);\n\tset_cookie(user.id, true, cookies, \u0026key);\n\tOk(())\n}\n\n/// Create the account routes with authentication middleware.\n///\n/// # Routes\n/// ## Protected Routes (require authentication)\n/// - `POST /update` - Update user account information\n/// - `GET /current` - Get current user's account details\n/// - `POST /validate` - Validate authentication token\n/// - `GET /logout` - Logout by making cookie expired\n///\n/// ## Public Routes (no authentication required)\n/// - `POST /signup` - Create a new user account\n/// - `POST /login` - Authenticate user and set auth cookie\n///\n/// # Middleware\n/// Protected routes are secured by `middleware_auth` which validates the `auth-token` cookie.\n/// Public routes (signup/login) are accessible without authentication.\npub fn account_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/update\", post(api_update))\n\t\t.route(\"/current\", get(api_current))\n\t\t.route(\"/validate\", get(api_validate))\n\t\t.route(\n\t\t\t\"/logout\",\n\t\t\tget(|mut c, k, u| async move { api_logout::\u003cCookies\u003e(\u0026mut c, k, u).await }),\n\t\t)\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n\t\t.route(\n\t\t\t\"/signup\",\n\t\t\tpost(|mut c, k, p, b| async move { api_signup::\u003cCookies\u003e(\u0026mut c, k, p, b).await }),\n\t\t)\n\t\t.route(\n\t\t\t\"/login\",\n\t\t\tpost(|mut c, k, p, b| async move { api_login::\u003cCookies\u003e(\u0026mut c, k, p, b).await }),\n\t\t)\n}\n","traces":[{"line":57,"address":[19189744,19189772],"length":1,"stats":{"Line":2}},{"line":70,"address":[18296608,18299694,18296584,18293504,18299688,18296590],"length":1,"stats":{"Line":2}},{"line":72,"address":[18296673,18293569],"length":1,"stats":{"Line":2}},{"line":73,"address":[18296735,18293631],"length":1,"stats":{"Line":2}},{"line":74,"address":[18293669,18296773],"length":1,"stats":{"Line":2}},{"line":78,"address":[18296813,18297079,18293709,18293887,18293975,18296991],"length":1,"stats":{"Line":6}},{"line":79,"address":[18296993,18293889],"length":1,"stats":{"Line":1}},{"line":81,"address":[18296821,18293717],"length":1,"stats":{"Line":2}},{"line":82,"address":[18296846,18293742],"length":1,"stats":{"Line":2}},{"line":84,"address":[18294007,18297111],"length":1,"stats":{"Line":2}},{"line":86,"address":[18294718,18297356,18297435,18294331,18294252,18297822],"length":1,"stats":{"Line":5}},{"line":94,"address":[18294681,18299378,18296022,18299543,18296274,18299292,18299126,18296188,18297785,18296439],"length":1,"stats":{"Line":10}},{"line":95,"address":[18296147,18296128,18299666,18296562,18299251,18299232,18299300,18296196],"length":1,"stats":{"Line":4}},{"line":97,"address":[18296298,18299402],"length":1,"stats":{"Line":2}},{"line":99,"address":[18296333,18296351,18299437,18296361,18299455,18299465],"length":1,"stats":{"Line":6}},{"line":100,"address":[18299457,18296353],"length":1,"stats":{"Line":0}},{"line":102,"address":[18296343,18299447],"length":1,"stats":{"Line":2}},{"line":104,"address":[18299496,18296392],"length":1,"stats":{"Line":2}},{"line":105,"address":[18296479,18299583],"length":1,"stats":{"Line":2}},{"line":109,"address":[18299637,18296533],"length":1,"stats":{"Line":2}},{"line":170,"address":[18302960,18303088],"length":1,"stats":{"Line":2}},{"line":176,"address":[18311579,18311725,18304227,18303821,18312131,18303675],"length":1,"stats":{"Line":5}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[18304195,18313382,18305478,18312099],"length":1,"stats":{"Line":4}},{"line":183,"address":[18313471,18305567],"length":1,"stats":{"Line":1}},{"line":187,"address":[18313737,18305701,18314150,18314563,18305763,18306659,18313605,18314340,18306436,18306246,18313667,18305833,18314285,18306381],"length":1,"stats":{"Line":6}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[18306320,18314224],"length":1,"stats":{"Line":2}},{"line":190,"address":[17494687,17495247],"length":1,"stats":{"Line":8}},{"line":192,"address":[18314801,18314678,18306774,18306897],"length":1,"stats":{"Line":4}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[18308586,18316490,18306911,18314815],"length":1,"stats":{"Line":2}},{"line":196,"address":[18306818,18314722],"length":1,"stats":{"Line":0}},{"line":197,"address":[18314783,18308715,18316619,18306879],"length":1,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[18306953,18314857],"length":1,"stats":{"Line":2}},{"line":206,"address":[18306983,18314887],"length":1,"stats":{"Line":2}},{"line":207,"address":[18307009,18307149,18315119,18315053,18308581,18314913,18316485,18307215],"length":1,"stats":{"Line":4}},{"line":208,"address":[18307026,18314930],"length":1,"stats":{"Line":2}},{"line":209,"address":[18319088,18319024,18307183,18307126,18315030,18319100,18315087,18319036],"length":1,"stats":{"Line":2}},{"line":213,"address":[18308318,18307386,18307501,18315475,18316405,18317067,18307571,18308501,18315290,18308559,18315405,18316463,18309163,18316222],"length":1,"stats":{"Line":6}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[18308389,18316293],"length":1,"stats":{"Line":2}},{"line":223,"address":[18308534,18317115,18316438,18309002,18316390,18316906,18303754,18308486,18311658,18309211],"length":1,"stats":{"Line":8}},{"line":225,"address":[18309225,18317129],"length":1,"stats":{"Line":2}},{"line":226,"address":[18309336,18317240],"length":1,"stats":{"Line":2}},{"line":227,"address":[18317703,18317254,18309350,18309799],"length":1,"stats":{"Line":3}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[18309759,18317663],"length":1,"stats":{"Line":2}},{"line":234,"address":[18318858,18310954],"length":1,"stats":{"Line":2}},{"line":236,"address":[18309262,18317166],"length":1,"stats":{"Line":0}},{"line":237,"address":[18309326,18318896,18310992,18317230],"length":1,"stats":{"Line":0}},{"line":294,"address":[18324944,18324816],"length":1,"stats":{"Line":2}},{"line":300,"address":[18329990,18329865,18325558,18325979,18325433,18330411],"length":1,"stats":{"Line":5}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[18331693,18325932,18327665,18332232,18327800,18332284,18332097,18332504,18330364,18327852,18328072,18331626,18327194,18327261],"length":1,"stats":{"Line":6}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[18327739,18332171],"length":1,"stats":{"Line":2}},{"line":319,"address":[17493972,17493652],"length":1,"stats":{"Line":8}},{"line":321,"address":[18328214,18332646],"length":1,"stats":{"Line":2}},{"line":322,"address":[18328285,18332717],"length":1,"stats":{"Line":2}},{"line":324,"address":[18332980,18332781,18328424,18328548,18328349,18332856,18328482,18333425,18332914,18328993],"length":1,"stats":{"Line":6}},{"line":325,"address":[18328516,18334012,18333936,18328459,18332891,18333948,18332948,18334000],"length":1,"stats":{"Line":2}},{"line":328,"address":[18333083,18328651],"length":1,"stats":{"Line":2}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[18328768,18333200,18333272,18328840],"length":1,"stats":{"Line":2}},{"line":334,"address":[18333239,18328807],"length":1,"stats":{"Line":1}},{"line":336,"address":[18333411,18328979],"length":1,"stats":{"Line":1}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[18329107,18333539,18328251,18332683],"length":1,"stats":{"Line":2}},{"line":373,"address":[17653088,17653092],"length":1,"stats":{"Line":4}},{"line":374,"address":[18337466,18337570,18338038],"length":1,"stats":{"Line":2}},{"line":378,"address":[18337960],"length":1,"stats":{"Line":1}},{"line":426,"address":[17658400],"length":1,"stats":{"Line":1}},{"line":430,"address":[18339840,18340261,18339714],"length":1,"stats":{"Line":3}},{"line":435,"address":[18342312,18342490,18340214,18341509,18342566,18341913,18342045,18341442,18342090],"length":1,"stats":{"Line":4}},{"line":451,"address":[18341987],"length":1,"stats":{"Line":1}},{"line":452,"address":[17583616],"length":1,"stats":{"Line":4}},{"line":453,"address":[18343148,18342534,18343136,18342467],"length":1,"stats":{"Line":1}},{"line":455,"address":[18342735],"length":1,"stats":{"Line":1}},{"line":531,"address":[17665760],"length":1,"stats":{"Line":1}},{"line":536,"address":[18347035,18346588,18346463],"length":1,"stats":{"Line":3}},{"line":542,"address":[18346962,18348446,18348502],"length":1,"stats":{"Line":3}},{"line":543,"address":[18348470],"length":1,"stats":{"Line":1}},{"line":544,"address":[18348507],"length":1,"stats":{"Line":1}},{"line":546,"address":[18349177,18348643,18348709],"length":1,"stats":{"Line":1}},{"line":547,"address":[18348534],"length":1,"stats":{"Line":1}},{"line":548,"address":[18351904,18348620,18348677,18351916],"length":1,"stats":{"Line":1}},{"line":549,"address":[18348846],"length":1,"stats":{"Line":1}},{"line":552,"address":[18348485],"length":1,"stats":{"Line":1}},{"line":555,"address":[18350941,18350663,18348926,18350480,18350715,18349051,18351122,18349204,18351198,18349274,18349080],"length":1,"stats":{"Line":6}},{"line":581,"address":[18349030],"length":1,"stats":{"Line":1}},{"line":582,"address":[18349059],"length":1,"stats":{"Line":1}},{"line":587,"address":[18350551],"length":1,"stats":{"Line":1}},{"line":588,"address":[18350777,18350648,18350696,18351069,18346521],"length":1,"stats":{"Line":4}},{"line":589,"address":[18351099,18351980,18351166,18351968],"length":1,"stats":{"Line":1}},{"line":591,"address":[18351367],"length":1,"stats":{"Line":1}},{"line":625,"address":[18357456],"length":1,"stats":{"Line":1}},{"line":630,"address":[18357901,18358312,18357797],"length":1,"stats":{"Line":2}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[18358275],"length":1,"stats":{"Line":1}},{"line":635,"address":[18359491],"length":1,"stats":{"Line":1}},{"line":654,"address":[17635520,17636516,17636491],"length":1,"stats":{"Line":1}},{"line":655,"address":[17636053,17636179,17635919,17636420,17635708,17635842,17635785,17636110,17636216,17636293,17635976,17635527,17635654,17636350],"length":1,"stats":{"Line":14}},{"line":656,"address":[17635613,17635667,17636587,17635606,17635713],"length":1,"stats":{"Line":3}},{"line":657,"address":[17635744,17635847,17635798,17636575,17635737],"length":1,"stats":{"Line":3}},{"line":658,"address":[17635871,17635981,17635878,17635932,17636563],"length":1,"stats":{"Line":3}},{"line":659,"address":[18299867,18300367,18300170,18299824,18299760,18299712],"length":1,"stats":{"Line":7}},{"line":660,"address":[17636539,17636192,17636131,17636138,17636221],"length":1,"stats":{"Line":3}},{"line":661,"address":[17636306,17636252,17636245,17636355,17636527],"length":1,"stats":{"Line":7}},{"line":662,"address":[17636433,17636379,17636509,17636386],"length":1,"stats":{"Line":6}}],"covered":95,"coverable":119},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","chat.rs"],"content":"use axum::{\n\tExtension, Json,\n\textract::Path,\n\trouting::{delete, get, post},\n};\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\nuse utoipa::OpenApi;\n\nuse crate::{\n\tcontrollers::{AxumRouter, itinerary::insert_event_list},\n\terror::{ApiResult, AppError},\n\tglobal::MESSAGE_PAGE_LEN,\n\thttp_models::{\n\t\tchat_session::{ChatsResponse, NewChatResponse},\n\t\tevent::Event,\n\t\titinerary::{EventDay, Itinerary},\n\t\tmessage::{\n\t\t\tMessage, MessagePageRequest, MessagePageResponse, SendMessageRequest,\n\t\t\tSendMessageResponse, UpdateMessageRequest,\n\t\t},\n\t},\n\tmiddleware::{AuthUser, middleware_auth},\n\tsql_models::message::{ChatSessionRow, MessageRow},\n\tswagger::SecurityAddon,\n};\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_chats,\n\t\tapi_new_chat,\n\t\tapi_message_page,\n\t\tapi_send_message,\n\t\tapi_update_message,\n\t\tapi_delete_chat\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity((\"set-cookie\"=[])),\n    info(\n    \ttitle=\"Chat Routes\",\n    \tdescription = \"API endpoints dealing with chatting and the home page.\"\n    ),\n    tags((name=\"Chat\"))\n)]\npub struct ChatApiDoc;\n\n/// Sends message and latest itinerary in chat session to llm, and waits for response.\n///\n/// When the bot replies, it's message and itinerary are inserted into the db.\n/// # Warning!\n/// Assumes the user's message has already been inserted into the db.\nasync fn send_message_to_llm(\n\ttext: \u0026str,\n\taccount_id: i32,\n\tchat_session_id: i32,\n\titinerary_id: Option\u003ci32\u003e,\n\tpool: \u0026PgPool,\n) -\u003e ApiResult\u003cMessage\u003e {\n\t// Give the LLM an itinerary for context\n\tlet itinerary_id = match itinerary_id {\n\t\tSome(id) =\u003e Some(id), //use the provided itinerary\n\t\tNone =\u003e {\n\t\t\t//use the latest itinerary from the chat session\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tSELECT m.itinerary_id\n\t\t\t\tFROM messages m\n\t\t\t\tINNER JOIN chat_sessions c\n\t\t\t\tON m.chat_session_id=c.id\n\t\t\t\tWHERE\n\t\t\t\t\tc.account_id=$1 AND\n\t\t\t\t\tc.id=$2 AND\n\t\t\t\t\tm.itinerary_id IS NOT NULL\n\t\t\t\tORDER BY m.timestamp DESC\n\t\t\t\tLIMIT 1;\n\t\t\t\t\"#,\n\t\t\t\taccount_id,\n\t\t\t\tchat_session_id\n\t\t\t)\n\t\t\t.fetch_optional(pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.map(|record| record.itinerary_id.unwrap())\n\t\t}\n\t};\n\tlet context_itinerary = match itinerary_id {\n\t\tSome(id) =\u003e Some(\n\t\t\tcrate::controllers::itinerary::api_get_itinerary(\n\t\t\t\tExtension(AuthUser { id: account_id }),\n\t\t\t\taxum::extract::Path(id),\n\t\t\t\tExtension(pool.clone()),\n\t\t\t)\n\t\t\t.await?,\n\t\t),\n\t\tNone =\u003e None,\n\t};\n\n\t// TODO: this is where the LLM call will be.\n\t// It should generate an itinerary, insert it into the db, and give some text.\n\t// Fow now we just make a temporary message.\n\tlet ai_text = \"Bot reply\";\n\tlet mut ai_itinerary = Itinerary {\n\t\tid: 0,\n\t\tstart_date: NaiveDate::parse_from_str(\"2025-11-05\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2025-11-06\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![\n\t\t\tEventDay {\n\t\t\t\tmorning_events: vec![Event {\n\t\t\t\t\tid: 1,\n\t\t\t\t\tstreet_address: String::from(\"1114 Shannon Ln\"),\n\t\t\t\t\tpostal_code: 17013,\n\t\t\t\t\tcity: String::from(\"Carlisle\"),\n\t\t\t\t\tevent_type: String::from(\"Hike\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"A beautiful stroll along a river in this cute small town.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Family Walking Path\"),\n\t\t\t\t}],\n\t\t\t\tnoon_events: vec![Event {\n\t\t\t\t\tid: 2,\n\t\t\t\t\tstreet_address: String::from(\"35 Campus Court\"),\n\t\t\t\t\tpostal_code: 12601,\n\t\t\t\t\tcity: String::from(\"Poughkeepsie\"),\n\t\t\t\t\tevent_type: String::from(\"Restaurant\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Local Italian restaurant known for its authentic pasta and upscale dining.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Cosimos\"),\n\t\t\t\t}],\n\t\t\t\tafternoon_events: vec![Event {\n\t\t\t\t\tid: 3,\n\t\t\t\t\tstreet_address: String::from(\"200 E 42nd St\"),\n\t\t\t\t\tpostal_code: 10017,\n\t\t\t\t\tcity: String::from(\"New York\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"World famous art museum with a focus on modern works, including Starry Starry Night by VanGough.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Museum of Modern Art- MoMA\"),\n\t\t\t\t}],\n\t\t\t\tevening_events: vec![Event {\n\t\t\t\t\tid: 4,\n\t\t\t\t\tstreet_address: String::from(\"1 S Broad St\"),\n\t\t\t\t\tpostal_code: 19107,\n\t\t\t\t\tcity: String::from(\"Philadelphia\"),\n\t\t\t\t\tevent_type: String::from(\"Concert\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Music center which hosts local and national bands.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Jazz night at Broad Street\"),\n\t\t\t\t}],\n\t\t\t\tdate: NaiveDate::parse_from_str(\"2025-11-05\", \"%Y-%m-%d\").unwrap(),\n\t\t\t},\n\t\t\tEventDay {\n\t\t\t\tmorning_events: vec![Event {\n\t\t\t\t\tid: 5,\n\t\t\t\t\tstreet_address: String::from(\"1 Citizens Bank Way\"),\n\t\t\t\t\tpostal_code: 19148,\n\t\t\t\t\tcity: String::from(\"Philadelphia\"),\n\t\t\t\t\tevent_type: String::from(\"Sports\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"A Phillies baseball game is a must-do for locals and visitors alike.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"Phillies Baseball Game\"),\n\t\t\t\t}],\n\t\t\t\tnoon_events: vec![Event {\n\t\t\t\t\tid: 6,\n\t\t\t\t\tstreet_address: String::from(\"5250 S Park Dr\"),\n\t\t\t\t\tpostal_code: 60615,\n\t\t\t\t\tcity: String::from(\"Chicago\"),\n\t\t\t\t\tevent_type: String::from(\"Festival\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Annual music festival with the biggest names in pop and indie scenes.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"LollaPalooza\"),\n\t\t\t\t}],\n\t\t\t\tafternoon_events: vec![Event {\n\t\t\t\t\tid: 7,\n\t\t\t\t\tstreet_address: String::from(\"1 Rue de la Seine\"),\n\t\t\t\t\tpostal_code: 0,\n\t\t\t\t\tcity: String::from(\"Paris\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\"Explore the beautiful landmark of Paris.\"),\n\t\t\t\t\tevent_name: String::from(\"Eiffel Tower\"),\n\t\t\t\t}],\n\t\t\t\tevening_events: vec![Event {\n\t\t\t\t\tid: 8,\n\t\t\t\t\tstreet_address: String::from(\"3 Rue de la Museu\"),\n\t\t\t\t\tpostal_code: 0,\n\t\t\t\t\tcity: String::from(\"Paris\"),\n\t\t\t\t\tevent_type: String::from(\"Museum\"),\n\t\t\t\t\tevent_description: String::from(\n\t\t\t\t\t\t\"Wander the halls of the world famous art museum.\",\n\t\t\t\t\t),\n\t\t\t\t\tevent_name: String::from(\"le Louvre\"),\n\t\t\t\t}],\n\t\t\t\tdate: NaiveDate::parse_from_str(\"2025-11-06\", \"%Y-%m-%d\").unwrap(),\n\t\t\t},\n\t\t],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"World Tour 11/5-15 2025\"),\n\t};\n\n\t// insert generated itinerary into db\n\tlet itinerary_id = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO itineraries (account_id, is_public, start_date, end_date, chat_session_id, saved, title)\n\t\tVALUES ($1, FALSE, $2, $3, $4, TRUE, $5)\n\t\tRETURNING id;\n\t\t\"#,\n\t\taccount_id,\n\t\tai_itinerary.start_date,\n\t\tai_itinerary.end_date,\n\t\tchat_session_id,\n\t\tai_itinerary.title\n\t)\n\t.fetch_one(pool)\n\t.await\n\t.map_err(|e| {\n\t\tAppError::from(e)\n\t})?\n\t.id;\n\n\tai_itinerary.id = itinerary_id;\n\n\t// insert itinerary events\n\tinsert_event_list(ai_itinerary, pool).await?;\n\n\t// insert bot message into db\n\tlet record = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO messages (chat_session_id, itinerary_id, is_user, timestamp, text)\n\t\tVALUES ($1, $2, FALSE, NOW(), $3)\n\t\tRETURNING id, timestamp;\n\t\t\"#,\n\t\tchat_session_id,\n\t\titinerary_id,\n\t\tai_text\n\t)\n\t.fetch_one(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet (bot_message_id, timestamp) = (record.id, record.timestamp);\n\n\tOk(Message {\n\t\tid: bot_message_id,\n\t\tis_user: false,\n\t\ttimestamp,\n\t\ttext: String::from(ai_text),\n\t\titinerary_id: Some(itinerary_id),\n\t})\n}\n\n/// Fetch all the chat session ids belonging to the user to made the request\n///\n/// # Method\n/// `GET /api/chat/chats`\n///\n/// # Responses\n/// - `200 OK` - [ChatsResponse] - list of chat session ids\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/chat/chats\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/chats\",\n\tsummary=\"Fetch user's chat session IDs\",\n\tdescription=\"Fetches a list of all chat session IDs belonging to the user.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Successfully retrieved chat sessions\",\n\t\t\tbody=ChatsResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"chat_sessions\": [3, 15, 16, 84]\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_chats(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cChatsResponse\u003e\u003e {\n\tOk(Json(ChatsResponse {\n\t\tchat_sessions: sqlx::query!(\n\t\t\tr#\"\n\t\t\tSELECT id from chat_sessions\n\t\t\tWHERE account_id=$1;\n\t\t\t\"#,\n\t\t\tuser.id\n\t\t)\n\t\t.fetch_all(\u0026pool)\n\t\t.await\n\t\t.map_err(|e| AppError::from(e))?\n\t\t.into_iter()\n\t\t.map(|record| ChatSessionRow {\n\t\t\tid: record.id,\n\t\t\ttitle: String::from(\"TODO: get chat title from db\"),\n\t\t})\n\t\t.collect(),\n\t}))\n}\n\n/// Get a page of messages from this chat session belonging to the user who made the request\n///\n/// # Method\n/// `POST /api/chat/messagePage`\n///\n/// # Request Body\n/// - [MessagePageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [MessagePageResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// Fetch latest massages\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/messagePage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 3\n///       }'\n/// ```\n/// Fetch messages ending with specific message\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/messagePage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 3,\n///         \"message_id\": 6\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/messagePage\",\n\tsummary=\"Fetch a page of messages from a chat session\",\n\tdescription=\"If no message id is provided, this fetches the latest messages from the chat session. If a message id is provided, that message and messages preceeding it will be fetched.\",\n\trequest_body(\n\t\tcontent=MessagePageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Message id may be omitted to get the latest messages\",\n\t\texamples(\n\t\t\t(\"Latest Messages\"=(\n\t\t\t\tsummary=\"Fetch the latest messages from a chat session\",\n\t\t\t\tvalue=json!({\n\t\t\t\t\t\"chat_session_id\": 4\n\t\t\t\t})\n\t\t\t)),\n\t\t\t(\"Specific Messages\"=(\n\t\t\t\tsummary=\"Fetch a specific page of messages from a chat session\",\n\t\t\t\tvalue=json!({\n\t\t\t\t\t\"chat_session_id\": 4,\n\t\t\t\t\t\"message_id\": 4\n\t\t\t\t})\n\t\t\t))\n\t\t)\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Messages retrieved successfully\",\n\t\t\tbody=MessagePageResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texamples(\n\t\t\t\t(\"Latest Messages\"=(\n\t\t\t\t\tsummary=\"The latest messages from a chat session\",\n\t\t\t\t\tvalue=json!({\n\t\t\t\t\t\t\"message_page\": [\n\t\t\t\t\t\t\t{\"id\": 6, \"is_user\": true, \"timestamp\": \"2025-10-14 11-34-19\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 10, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-24\", \"text\": \"Bot reply\", \"itinerary_id\": 2},\n\t\t\t\t\t\t\t{\"id\": 12, \"is_user\": true, \"timestamp\": \"2025-10-14 11-34-42\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 22, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-56\", \"text\": \"Bot reply\", \"itinerary_id\": 5},\n\t\t\t\t\t\t\t{\"id\": 26, \"is_user\": true, \"timestamp\": \"2025-10-14 11-35-10\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 33, \"is_user\": false, \"timestamp\": \"2025-10-14 11-35-19\", \"text\": \"Bot reply\", \"itinerary_id\": 9},\n\t\t\t\t\t\t\t{\"id\": 39, \"is_user\": true, \"timestamp\": \"2025-10-14 11-35-31\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 44, \"is_user\": false, \"timestamp\": \"2025-10-14 11-35-54\", \"text\": \"Bot reply\", \"itinerary_id\": 14},\n\t\t\t\t\t\t\t{\"id\": 61, \"is_user\": true, \"timestamp\": \"2025-10-14 11-36-24\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 72, \"is_user\": false, \"timestamp\": \"2025-10-14 11-36-29\", \"text\": \"Bot reply\", \"itinerary_id\": 27}\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"prev_message_id\": 4\n\t\t\t\t\t})\n\t\t\t\t)),\n\t\t\t\t(\"Specific Messages\"=(\n\t\t\t\t\tsummary=\"A specific page of messages from a chat session\",\n\t\t\t\t\tvalue=json!({\n\t\t\t\t\t\t\"message_page\": [\n\t\t\t\t\t\t\t{\"id\": 1, \"is_user\": true, \"timestamp\": \"2025-10-14 11-33-21\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 2, \"is_user\": false, \"timestamp\": \"2025-10-14 11-33-35\", \"text\": \"Bot reply\", \"itinerary_id\": 1},\n\t\t\t\t\t\t\t{\"id\": 3, \"is_user\": true, \"timestamp\": \"2025-10-14 11-33-45\", \"text\": \"User message\"},\n\t\t\t\t\t\t\t{\"id\": 4, \"is_user\": false, \"timestamp\": \"2025-10-14 11-34-01\", \"text\": \"Bot reply\", \"itinerary_id\": 1},\n\t\t\t\t\t\t],\n\t\t\t\t\t\t\"prev_message_id\": null\n\t\t\t\t\t})\n\t\t\t\t))\n\t\t\t)\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_message_page(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(MessagePageRequest {\n\t\tchat_session_id,\n\t\tmessage_id,\n\t}): Json\u003cMessagePageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cMessagePageResponse\u003e\u003e {\n\tlet mut message_page: Vec\u003cMessage\u003e = sqlx::query_as!(\n\t\tMessageRow,\n\t\tr#\"\n\t\tSELECT\n\t\t\tm.id,\n\t\t\tm.chat_session_id,\n\t\t\tm.itinerary_id,\n\t\t\tm.is_user,\n\t\t\tm.timestamp,\n\t\t\tm.text\n\t\tFROM messages m\n\t\tINNER JOIN chat_sessions c\n\t\tON m.chat_session_id=c.id\n\t\tWHERE\n\t\t\tc.id=$1 AND\n\t\t\tc.account_id=$2 AND\n\t\t\t(\n\t\t\t\t$3::int IS NULL OR\n\t\t\t\tm.timestamp \u003c= (SELECT timestamp FROM messages WHERE id=$3)\n\t\t\t)\n\t\tORDER BY m.timestamp DESC\n\t\tLIMIT $4 + 1;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id,\n\t\tmessage_id,\n\t\tMESSAGE_PAGE_LEN\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.into_iter()\n\t.rev()\n\t.map(|msg_row| Message {\n\t\tid: msg_row.id,\n\t\tis_user: msg_row.is_user,\n\t\ttimestamp: msg_row.timestamp,\n\t\ttext: msg_row.text,\n\t\titinerary_id: msg_row.itinerary_id,\n\t})\n\t.collect();\n\n\tlet prev_message_id = if message_page.len() == MESSAGE_PAGE_LEN as usize + 1 {\n\t\t// there might be a better way to do this, but it should work, and it's only O(MESSAGE_PAGE_LEN) time complexity\n\t\tSome(message_page.remove(0).id)\n\t} else {\n\t\tNone\n\t};\n\n\tOk(Json(MessagePageResponse {\n\t\tmessage_page,\n\t\tprev_message_id,\n\t}))\n}\n\n/// Update an existing message with new text, and get a message back from the LLM\n///\n/// # Method\n/// `POST /api/chat/updateMessage`\n///\n/// # Request Body\n/// - [UpdateMessageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [Message] - message from LLM\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided message id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/updateMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"message_id\": 3,\n///         \"new_text\": \"Updated message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/updateMessage\",\n\tsummary=\"Update the text of a message and wait for a reply from the LLM\",\n\tdescription=\"Updating a message deletes all proceeding messages, updates the text of the given message, and returns a response from the LLM.\",\n\trequest_body(\n\t\tcontent=UpdateMessageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Itinerary id is optional and is used to give context to the LLM.\",\n\t\texample=json!({\n\t\t\t\"message_id\": 41,\n\t\t\t\"new_text\": \"Updated message content\",\n\t\t\t\"itinerary_id\": 17\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Message updated, and LLM replied successfully\",\n\t\t\tbody=Message,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"id\": 43,\n\t\t\t\t\"is_user\": false,\n\t\t\t\t\"timestamp\": \"2025-10-14 11-38-52\",\n\t\t\t\t\"text\": \"Bot reply\",\n\t\t\t\t\"itinerary_id\": 19\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Message not found in this chat session for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_update_message(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(UpdateMessageRequest {\n\t\tmessage_id,\n\t\tnew_text,\n\t\titinerary_id,\n\t}): Json\u003cUpdateMessageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cMessage\u003e\u003e {\n\tif new_text.is_empty() {\n\t\treturn Err(AppError::BadRequest(String::from(\"Text cannot be empty\")));\n\t}\n\n\t// verify the message id belongs to this user\n\tsqlx::query!(\n\t\tr#\"\n\t\tSELECT m.id\n\t\tFROM messages m\n\t\tINNER JOIN chat_sessions c\n\t\tON m.chat_session_id=c.id\n\t\tWHERE m.id=$1 AND c.account_id=$2 AND m.is_user=TRUE;\n\t\t\"#,\n\t\tmessage_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\t// delete future messages\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM messages\n\t\tWHERE timestamp \u003e (\n\t\t\tSELECT timestamp\n\t\t\tFROM messages\n\t\t\tWHERE id=$1\n\t\t);\n\t\t\"#,\n\t\tmessage_id\n\t)\n\t.execute(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\t// update user message\n\tlet chat_session_id = sqlx::query!(\n\t\tr#\"\n\t\tUPDATE messages\n\t\tSET text=$1, timestamp=NOW()\n\t\tWHERE is_user=TRUE AND id=$2\n\t\tRETURNING chat_session_id;\n\t\t\"#,\n\t\tnew_text,\n\t\tmessage_id\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.chat_session_id;\n\n\t// call llm and insert bot response into db\n\tlet bot_message = send_message_to_llm(\n\t\tnew_text.as_str(),\n\t\tuser.id,\n\t\tchat_session_id,\n\t\titinerary_id,\n\t\t\u0026pool,\n\t)\n\t.await?;\n\n\tOk(Json(bot_message))\n}\n\n/// Send a new message, and get a message back from the LLM\n///\n/// # Method\n/// `POST /api/chat/sendMessage`\n///\n/// # Request Body\n/// - [SendMessageRequest]\n///\n/// # Responses\n/// - `200 OK` - with body: [SendMessageResponse] - contains message from LLM\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided chat session id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/sendMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 6,\n///         \"text\": \"New message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/sendMessage\",\n\tsummary=\"Send a message and wait for a reply from the LLM\",\n\tdescription=\"Ask the LLM to generate an itinerary and it should respond with one.\",\n\trequest_body(\n\t\tcontent=SendMessageRequest,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"Itinerary id is optional and is used to give context to the LLM.\",\n\t\texample=json!({\n\t\t\t\"chat_session_id\": 12,\n\t\t\t\"text\": \"Make an itinerary\",\n\t\t\t\"itinerary_id\": 13\n\t\t})\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"Message sent, and LLM replied successfully\",\n\t\t\tbody=SendMessageResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"user_message_id\": 52,\n\t\t\t\t\"bot_message\": {\n\t\t\t\t\t\"id\": 53,\n\t\t\t\t\t\"is_user\": false,\n\t\t\t\t\t\"timestamp\": \"2025-10-14 11-39-10\",\n\t\t\t\t\t\"text\": \"Bot reply\",\n\t\t\t\t\t\"itinerary_id\": 14\n\t\t\t\t}\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Chat session not found for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_send_message(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(SendMessageRequest {\n\t\tchat_session_id,\n\t\ttext,\n\t\titinerary_id,\n\t}): Json\u003cSendMessageRequest\u003e,\n) -\u003e ApiResult\u003cJson\u003cSendMessageResponse\u003e\u003e {\n\tif text.is_empty() {\n\t\treturn Err(AppError::BadRequest(String::from(\"Text cannot be empty\")));\n\t}\n\n\t// verify the given chat session belongs to this user\n\tsqlx::query!(\n\t\tr#\"\n\t\tSELECT id FROM chat_sessions\n\t\tWHERE id=$1 AND account_id=$2;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\t// insert user message into db\n\tlet user_message_id = sqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO messages (chat_session_id, itinerary_id, is_user, timestamp, text)\n\t\tVALUES ($1, NULL, TRUE, NOW(), $2)\n\t\tRETURNING id;\n\t\t\"#,\n\t\tchat_session_id,\n\t\ttext\n\t)\n\t.fetch_one(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.id;\n\n\t// call llm and insert bot response into db\n\tlet bot_message =\n\t\tsend_message_to_llm(text.as_str(), user.id, chat_session_id, itinerary_id, \u0026pool).await?;\n\n\tOk(Json(SendMessageResponse {\n\t\tuser_message_id,\n\t\tbot_message,\n\t}))\n}\n\n/// Get an empty chat session id belonging to this user, or create one if one doesn't exist\n///\n/// # Method\n/// `GET /api/chat/newChat`\n///\n/// # Responses\n/// - `200 OK` - with body: [NewChatResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/chat/sendMessage\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"chat_session_id\": 6,\n///         \"text\": \"New message\",\n///         \"itinerary_id\": 7\n///       }'\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/newChat\",\n\tsummary=\"Get the chat session id for an empty chat\",\n\tdescription=\"Creates a new empty chat session for this user if one doesn't already exist, and returns its chat session id.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"New chat session retrieved successfully\",\n\t\t\tbody=NewChatResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\texample=json!({\n\t\t\t\t\"chat_session_id\": 13\n\t\t\t})\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_new_chat(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cNewChatResponse\u003e\u003e {\n\t// check to see if there's already an empty chat session before making a new one\n\tlet chat_sessions = sqlx::query!(\n\t\tr#\"\n\t\tSELECT c.id\n\t\tFROM chat_sessions c\n\t\tWHERE\n\t\t\tc.account_id=$1\n\t\t\tAND NOT EXISTS (\n\t\t\t\tSELECT 1\n\t\t\t\tFROM messages m\n\t\t\t\tWHERE m.chat_session_id=c.id\n\t\t\t);\n\t\t\"#,\n\t\tuser.id\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet chat_session_id = match chat_sessions.first() {\n\t\tSome(record) =\u003e record.id,\n\t\tNone =\u003e {\n\t\t\t// make a new chat session\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tINSERT INTO chat_sessions (account_id)\n\t\t\t\tVALUES ($1)\n\t\t\t\tRETURNING id\n\t\t\t\t\"#,\n\t\t\t\tuser.id\n\t\t\t)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.id\n\t\t}\n\t};\n\n\tOk(Json(NewChatResponse { chat_session_id }))\n}\n\n/// Delete the chat session with the given ID\n///\n/// # Method\n/// `DELETE /api/chat/:id`\n///\n/// # Responses\n/// - `200 OK` - chat session and associated messages and unsaved itineraries successfully deleted\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - The provided chat session id does not belong to the user or does not exist (public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X DELETE http://localhost:3001/api/chat/7\n///   -H \"Content-Type: application/json\"\n/// ```\n#[utoipa::path(\n\tdelete,\n\tpath=\"/{id}\",\n\tsummary=\"Delete the given chat session\",\n\tdescription=\"Deletes a chat session and its associated messages and unsaved, private itineraries if it belongs to the user making the request.\",\n\tresponses(\n\t\t(status=200, description=\"Chat session and associated messages and unsaved, private itineraries deleted successfully\"),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Chat session not found for this user\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be DELETE\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Chat\"\n)]\npub async fn api_delete_chat(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tPath(chat_session_id): Path\u003ci32\u003e,\n) -\u003e ApiResult\u003c()\u003e {\n\t// itineraries do not cascade, so we delete manually\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM itineraries\n\t\tWHERE\n\t\t\tchat_session_id=$1 AND\n\t\t\taccount_id=$2 AND\n\t\t\tis_public=FALSE AND\n\t\t\tsaved=FALSE;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\t// messages will cascade\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM chat_sessions\n\t\tWHERE id=$1 AND account_id=$2\n\t\tRETURNING id;\n\t\t\"#,\n\t\tchat_session_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\tOk(())\n}\n\n/// Create the chat routes with authentication middleware.\n///\n/// # Routes\n/// - `GET /chats` - Get metadata for all the user's chat sessions (protected)\n/// - `POST /messagePage` - Gets a page of messages in the session, ending with message_id or the latest message (protected)\n/// - `POST /updateMessage` - Updates a user's message and waits for a bot reply (protected)\n/// - `POST /sendMessage` - Sends a user's message and waits for a bot reply (protected)\n/// - `GET /newChat` - Gets a chat session id for an empty chat (protected)\n/// - `DELETE /:id` - Delete a chat session and associated messages (protected)\n///\n/// # Middleware\n/// All routes are protected by `middleware_auth` which validates the `auth-token` cookie.\npub fn chat_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/chats\", get(api_chats))\n\t\t.route(\"/messagePage\", post(api_message_page))\n\t\t.route(\"/updateMessage\", post(api_update_message))\n\t\t.route(\"/sendMessage\", post(api_send_message))\n\t\t.route(\"/newChat\", get(api_new_chat))\n\t\t.route(\"/{id}\", delete(api_delete_chat))\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n}\n","traces":[{"line":33,"address":[17685120],"length":1,"stats":{"Line":1}},{"line":41,"address":[18803616],"length":1,"stats":{"Line":1}},{"line":42,"address":[18803767],"length":1,"stats":{"Line":0}},{"line":44,"address":[18805519,18804700,18803812,18805054,18804466,18803875,18805121,18803945,18805217,18804645,18804953],"length":1,"stats":{"Line":5}},{"line":60,"address":[18804537],"length":1,"stats":{"Line":1}},{"line":61,"address":[17479108],"length":1,"stats":{"Line":4}},{"line":62,"address":[18818976,18805031,18818988,18805089],"length":1,"stats":{"Line":1}},{"line":63,"address":[18819008,18805182,18819020],"length":1,"stats":{"Line":3}},{"line":66,"address":[18804728],"length":1,"stats":{"Line":1}},{"line":67,"address":[18805244,18805464,18805863,18805753,18805939,18805426,18816238],"length":1,"stats":{"Line":5}},{"line":68,"address":[18805265],"length":1,"stats":{"Line":1}},{"line":70,"address":[18805278],"length":1,"stats":{"Line":1}},{"line":71,"address":[18805586,18803691,18805449,18805833,18805907,18806028,18805497],"length":1,"stats":{"Line":5}},{"line":72,"address":[18805309],"length":1,"stats":{"Line":1}},{"line":78,"address":[18805331],"length":1,"stats":{"Line":1}},{"line":81,"address":[18805350,18806092],"length":1,"stats":{"Line":2}},{"line":82,"address":[18806161],"length":1,"stats":{"Line":1}},{"line":83,"address":[18806291,18806355,18816156,18816208,18816101,18814238,18816233,18810281],"length":1,"stats":{"Line":2}},{"line":164,"address":[18814549],"length":1,"stats":{"Line":1}},{"line":169,"address":[18816026,18814878,18816516,18816583,18814790,18816848,18815971,18814948,18816415,18815794],"length":1,"stats":{"Line":4}},{"line":181,"address":[18815865],"length":1,"stats":{"Line":1}},{"line":182,"address":[18816463,18815956,18816251,18816004,18803712],"length":1,"stats":{"Line":4}},{"line":183,"address":[18819040,18816493],"length":1,"stats":{"Line":1}},{"line":184,"address":[18819052],"length":1,"stats":{"Line":0}},{"line":188,"address":[18816644],"length":1,"stats":{"Line":1}},{"line":191,"address":[17479171],"length":1,"stats":{"Line":2}},{"line":194,"address":[18818071,18818123,18817287,18817209,18818322,18818890,18818490,18817351,18817939,18818423],"length":1,"stats":{"Line":4}},{"line":204,"address":[18818013],"length":1,"stats":{"Line":1}},{"line":205,"address":[17479193],"length":1,"stats":{"Line":4}},{"line":206,"address":[18818400,18819072],"length":1,"stats":{"Line":1}},{"line":207,"address":[18819084],"length":1,"stats":{"Line":0}},{"line":210,"address":[18818547],"length":1,"stats":{"Line":1}},{"line":212,"address":[18818710],"length":1,"stats":{"Line":1}},{"line":216,"address":[18818669],"length":1,"stats":{"Line":1}},{"line":217,"address":[18818704],"length":1,"stats":{"Line":1}},{"line":260,"address":[17695840],"length":1,"stats":{"Line":1}},{"line":264,"address":[18824933],"length":1,"stats":{"Line":1}},{"line":265,"address":[18823751,18824384,18824427,18824629,18823688,18824794,18824727,18823815,18824216],"length":1,"stats":{"Line":4}},{"line":272,"address":[18824284],"length":1,"stats":{"Line":1}},{"line":273,"address":[17578848],"length":1,"stats":{"Line":4}},{"line":274,"address":[18825184,18825196,18824704,18824762],"length":1,"stats":{"Line":1}},{"line":275,"address":[18824875],"length":1,"stats":{"Line":1}},{"line":276,"address":[18825227,18824898,18825216],"length":1,"stats":{"Line":3}},{"line":277,"address":[18824921],"length":1,"stats":{"Line":1}},{"line":386,"address":[17721680],"length":1,"stats":{"Line":1}},{"line":391,"address":[18827404,18827187,18826136,18826230,18826294,18826972,18827502,18827141,18827569],"length":1,"stats":{"Line":4}},{"line":419,"address":[18827059],"length":1,"stats":{"Line":1}},{"line":420,"address":[17585719],"length":1,"stats":{"Line":4}},{"line":421,"address":[18827537,18827479,18828268,18828256],"length":1,"stats":{"Line":1}},{"line":424,"address":[18828288,18827696,18828355],"length":1,"stats":{"Line":3}},{"line":425,"address":[18828299],"length":1,"stats":{"Line":1}},{"line":426,"address":[18828303],"length":1,"stats":{"Line":1}},{"line":427,"address":[18828307],"length":1,"stats":{"Line":1}},{"line":428,"address":[18828323],"length":1,"stats":{"Line":1}},{"line":429,"address":[18828349],"length":1,"stats":{"Line":1}},{"line":433,"address":[18827786,18827734,18827854],"length":1,"stats":{"Line":3}},{"line":435,"address":[18827856,18828080],"length":1,"stats":{"Line":2}},{"line":437,"address":[18827843],"length":1,"stats":{"Line":1}},{"line":440,"address":[18827947],"length":1,"stats":{"Line":1}},{"line":441,"address":[18827901],"length":1,"stats":{"Line":1}},{"line":442,"address":[18827933],"length":1,"stats":{"Line":1}},{"line":510,"address":[17729168],"length":1,"stats":{"Line":1}},{"line":515,"address":[18831827,18831755,18832660,18831577],"length":1,"stats":{"Line":4}},{"line":518,"address":[18831927,18832580,18831769,18833023,18833121,18833367,18831857,18833300,18832448,18832632,18834106,18833188],"length":1,"stats":{"Line":7}},{"line":529,"address":[18832522],"length":1,"stats":{"Line":1}},{"line":530,"address":[18831624,18833071,18832565,18832610,18832862],"length":1,"stats":{"Line":4}},{"line":531,"address":[18836684,18836672,18833156,18833098],"length":1,"stats":{"Line":1}},{"line":532,"address":[18833249,18833335],"length":1,"stats":{"Line":2}},{"line":535,"address":[18834380,18833457,18833524,18833929,18834084,18835315,18834038,18833422,18834282,18834447],"length":1,"stats":{"Line":4}},{"line":546,"address":[18833980],"length":1,"stats":{"Line":1}},{"line":547,"address":[18834023,18834124,18834068,18834330,18831645],"length":1,"stats":{"Line":4}},{"line":548,"address":[18836704,18834357,18836716,18834415],"length":1,"stats":{"Line":1}},{"line":551,"address":[18834556,18835584,18835247,18835486,18834504,18835878,18835651,18835115,18834620,18835293],"length":1,"stats":{"Line":4}},{"line":561,"address":[18835189],"length":1,"stats":{"Line":1}},{"line":562,"address":[17478061],"length":1,"stats":{"Line":4}},{"line":563,"address":[18835561,18835619,18836736,18836748],"length":1,"stats":{"Line":1}},{"line":567,"address":[17478079],"length":1,"stats":{"Line":2}},{"line":569,"address":[18836321],"length":1,"stats":{"Line":1}},{"line":639,"address":[17737424],"length":1,"stats":{"Line":1}},{"line":644,"address":[18839462,18839390,18839233,18840280],"length":1,"stats":{"Line":4}},{"line":647,"address":[18840805,18841850,18840984,18840738,18840203,18840917,18840640,18839562,18839492,18840071,18840252,18839404],"length":1,"stats":{"Line":7}},{"line":655,"address":[18840145],"length":1,"stats":{"Line":1}},{"line":656,"address":[17585945],"length":1,"stats":{"Line":4}},{"line":657,"address":[18840773,18843280,18843292,18840715],"length":1,"stats":{"Line":1}},{"line":658,"address":[18840952,18840866],"length":1,"stats":{"Line":2}},{"line":661,"address":[18841828,18842409,18842124,18841039,18841650,18842191,18841782,18841091,18842026,18841155],"length":1,"stats":{"Line":4}},{"line":670,"address":[18841724],"length":1,"stats":{"Line":1}},{"line":671,"address":[18839301,18841812,18841767,18842074,18841868],"length":1,"stats":{"Line":4}},{"line":672,"address":[18842101,18843312,18842159,18843324],"length":1,"stats":{"Line":1}},{"line":676,"address":[17585981],"length":1,"stats":{"Line":2}},{"line":678,"address":[18842855],"length":1,"stats":{"Line":1}},{"line":679,"address":[18842852],"length":1,"stats":{"Line":1}},{"line":729,"address":[17741520],"length":1,"stats":{"Line":1}},{"line":734,"address":[18847498,18846502,18845526,18845927,18846095,18845381,18846138,18846337,18846435,18845462],"length":1,"stats":{"Line":4}},{"line":748,"address":[18845995],"length":1,"stats":{"Line":1}},{"line":749,"address":[17581176],"length":1,"stats":{"Line":4}},{"line":750,"address":[18848048,18846412,18848060,18846470],"length":1,"stats":{"Line":1}},{"line":752,"address":[18846603,18846671],"length":1,"stats":{"Line":2}},{"line":753,"address":[18846727],"length":1,"stats":{"Line":1}},{"line":756,"address":[18847832,18846794,18847386,18847260,18847431,18847765,18847667,18846762,18846858],"length":1,"stats":{"Line":4}},{"line":764,"address":[18847331],"length":1,"stats":{"Line":1}},{"line":765,"address":[17581192],"length":1,"stats":{"Line":4}},{"line":766,"address":[18847742,18848092,18848080,18847800],"length":1,"stats":{"Line":1}},{"line":767,"address":[18847886],"length":1,"stats":{"Line":1}},{"line":771,"address":[18847458],"length":1,"stats":{"Line":1}},{"line":808,"address":[17744784],"length":1,"stats":{"Line":1}},{"line":814,"address":[18850848,18849584,18850382,18849673,18849737,18851879,18850428,18850772,18850228,18850642],"length":1,"stats":{"Line":4}},{"line":826,"address":[18850276],"length":1,"stats":{"Line":1}},{"line":827,"address":[18850367,18849642,18850722,18850490,18850412],"length":1,"stats":{"Line":4}},{"line":828,"address":[17584965,17584993],"length":1,"stats":{"Line":2}},{"line":831,"address":[18851184,18851679,18852232,18851120,18852165,18851857,18851811,18852411,18852623,18852067,18852344,18851068],"length":1,"stats":{"Line":5}},{"line":840,"address":[18851753],"length":1,"stats":{"Line":1}},{"line":841,"address":[17584920],"length":1,"stats":{"Line":4}},{"line":842,"address":[18852672,18852200,18852142,18852684],"length":1,"stats":{"Line":1}},{"line":843,"address":[17585043,17585071],"length":1,"stats":{"Line":1}},{"line":845,"address":[18852466],"length":1,"stats":{"Line":1}},{"line":860,"address":[17686187,17685216,17686212],"length":1,"stats":{"Line":1}},{"line":861,"address":[17685538,17685806,17685404,17686074,17685615,17686136,17685940,17686017,17685481,17685672,17685749,17685350,17685883,17685223],"length":1,"stats":{"Line":14}},{"line":862,"address":[17685309,17685409,17686283,17685363,17685302],"length":1,"stats":{"Line":3}},{"line":863,"address":[17685543,17685440,17685494,17685433,17686271],"length":1,"stats":{"Line":3}},{"line":864,"address":[17685677,17685574,17685628,17685567,17686259],"length":1,"stats":{"Line":3}},{"line":865,"address":[17685811,17685701,17686247,17685708,17685762],"length":1,"stats":{"Line":3}},{"line":866,"address":[17685945,17685835,17685896,17686235,17685842],"length":1,"stats":{"Line":3}},{"line":867,"address":[17685969,17686223,17686079,17686030,17685976],"length":1,"stats":{"Line":3}},{"line":868,"address":[17686102,17686095,17686149,17686205],"length":1,"stats":{"Line":2}}],"covered":122,"coverable":125},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","itinerary.rs"],"content":"/*\n * src/controllers/itinerary.rs\n *\n * File for Itinerary Controller API Endpoints\n *\n * Purpose:\n *   Serve Itinerary Related API Requests\n */\n\nuse axum::routing::post;\nuse axum::{Extension, Json, extract::Path, routing::get};\nuse sqlx::PgPool;\nuse tracing::debug;\nuse utoipa::OpenApi;\n\nuse crate::controllers::AxumRouter;\nuse crate::error::{ApiResult, AppError};\nuse crate::http_models::itinerary::*;\nuse crate::middleware::{AuthUser, middleware_auth};\nuse crate::sql_models::TimeOfDay;\nuse crate::sql_models::event_list::EventListJoinRow;\nuse crate::sql_models::itinerary::ItineraryRow;\nuse crate::swagger::SecurityAddon;\n\n#[derive(OpenApi)]\n#[openapi(\n\tpaths(\n\t\tapi_get_itinerary,\n\t\tapi_saved_itineraries,\n\t\tapi_save\n\t),\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity((\"set-cookie\"=[])),\n    info(\n    \ttitle=\"Itinerary Routes\",\n    \tdescription = \"API endpoints dealing with managing and viewing itineraries.\"\n    ),\n    tags((name=\"Itinerary\"))\n)]\npub struct ItineraryApiDoc;\n\n/// Returns the [EventDay]s associated with this itinerary\nasync fn itinerary_events(itinerary_id: i32, pool: \u0026PgPool) -\u003e ApiResult\u003cVec\u003cEventDay\u003e\u003e {\n\tlet event_list: Vec\u003cEventListJoinRow\u003e = sqlx::query_as!(\n\t\tEventListJoinRow,\n\t\tr#\"\n\t\tSELECT\n\t\t\te.id,\n\t\t\tel.time_of_day as \"time_of_day: TimeOfDay\",\n\t\t\tel.date,\n\t\t\te.street_address,\n\t\t\te.postal_code,\n\t\t\te.city,\n\t\t\te.event_type,\n\t\t\te.event_description,\n\t\t\te.event_name\n\t\tFROM event_list el\n\t\tJOIN events e ON e.id = el.event_id\n\t\tWHERE el.itinerary_id = $1\n\t\t\"#,\n\t\titinerary_id\n\t)\n\t.fetch_all(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet mut event_days = Vec::with_capacity(event_list.len());\n\tfor event_day in event_list.chunk_by(|a, b| a.date == b.date) {\n\t\tlet mut morning_events = Vec::with_capacity(event_list.len());\n\t\tlet mut noon_events = Vec::with_capacity(event_list.len());\n\t\tlet mut afternoon_events = Vec::with_capacity(event_list.len());\n\t\tlet mut evening_events = Vec::with_capacity(event_list.len());\n\n\t\tfor event in event_day.into_iter() {\n\t\t\tmatch event.time_of_day {\n\t\t\t\tTimeOfDay::Morning =\u003e morning_events.push(event.into()),\n\t\t\t\tTimeOfDay::Noon =\u003e noon_events.push(event.into()),\n\t\t\t\tTimeOfDay::Afternoon =\u003e afternoon_events.push(event.into()),\n\t\t\t\tTimeOfDay::Evening =\u003e evening_events.push(event.into()),\n\t\t\t}\n\t\t}\n\n\t\tif let Some(event) = event_day.first() {\n\t\t\tevent_days.push(EventDay {\n\t\t\t\tmorning_events,\n\t\t\t\tnoon_events,\n\t\t\t\tafternoon_events,\n\t\t\t\tevening_events,\n\t\t\t\tdate: event.date,\n\t\t\t});\n\t\t}\n\t}\n\tevent_days.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n\tOk(event_days)\n}\n\n/// Inserts the events associated with this itinerary into the `event_list` table.\n/// Assumes the itinerary was already inserted into `itineraries` table.\npub async fn insert_event_list(itinerary: Itinerary, pool: \u0026PgPool) -\u003e ApiResult\u003c()\u003e {\n\tlet mut cap = 0;\n\tfor day in itinerary.event_days.iter() {\n\t\tcap += day.morning_events.len();\n\t\tcap += day.noon_events.len();\n\t\tcap += day.afternoon_events.len();\n\t\tcap += day.evening_events.len();\n\t}\n\n\tlet mut times = Vec::with_capacity(cap);\n\tlet mut dates = Vec::with_capacity(cap);\n\tlet mut events = Vec::with_capacity(cap);\n\tfor day in itinerary.event_days.into_iter() {\n\t\tlet morning_len = day.morning_events.len();\n\t\tlet noon_len = day.noon_events.len();\n\t\tlet afternoon_len = day.afternoon_events.len();\n\t\tlet evening_len = day.evening_events.len();\n\t\tlet len = morning_len + noon_len + afternoon_len + evening_len;\n\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Morning, morning_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Noon, noon_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Afternoon, afternoon_len));\n\t\ttimes.extend(std::iter::repeat_n(TimeOfDay::Evening, evening_len));\n\n\t\tdates.extend(std::iter::repeat_n(day.date, len));\n\n\t\tevents.extend(day.morning_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.noon_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.afternoon_events.into_iter().map(|event| event.id));\n\t\tevents.extend(day.evening_events.into_iter().map(|event| event.id));\n\t}\n\n\tsqlx::query!(\n\t\tr#\"\n\t\tINSERT INTO event_list (itinerary_id, event_id, time_of_day, date)\n\t\tSELECT $1, events, times, dates\n\t\tFROM UNNEST($2::int4[], $3::time_of_day[], $4::date[]) as u(events, times, dates);\n\t\t\"#,\n\t\titinerary.id,\n\t\tevents.as_slice(),\n\t\ttimes.as_slice() as \u0026[TimeOfDay],\n\t\tdates.as_slice()\n\t)\n\t.execute(pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tOk(())\n}\n\n/// Get all saved itineraries for the authenticated user.\n///\n/// # Method\n/// `GET /api/itinerary/saved`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - JSON body `{ \"itineraries\": [Itinerary] }` containing user's saved itineraries with eventlist\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/itinerary/saved\n///   -H \"Cookie: auth-token=...\"\n/// ```\n///\n#[utoipa::path(\n\tget,\n\tpath=\"/saved\",\n\tsummary=\"Fetch all the saved itineraries from this user\",\n\tdescription=\"Fetches all the itineraries from this user that are marked as saved.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"An array of itineraries\",\n\t\t\tbody=SavedResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_saved_itineraries(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cSavedResponse\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/itinerary/saved 'api_saved_itineraries' - User ID: {}\",\n\t\tuser.id\n\t);\n\n\t// Fetch all itineraries for the user\n\tlet itineraries: Vec\u003cItineraryRow\u003e = sqlx::query_as!(\n\t\tItineraryRow,\n\t\tr#\"SELECT\n        \tid,\n         \taccount_id,\n          \tstart_date,\n           \tend_date,\n            chat_session_id,\n            title\n        FROM itineraries WHERE account_id=$1 AND saved=TRUE\"#,\n\t\tuser.id\n\t)\n\t.fetch_all(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tlet mut res = Vec::with_capacity(itineraries.len());\n\tfor itinerary in itineraries.into_iter() {\n\t\tres.push(Itinerary {\n\t\t\tid: itinerary.id,\n\t\t\tstart_date: itinerary.start_date,\n\t\t\tend_date: itinerary.end_date,\n\t\t\tevent_days: itinerary_events(itinerary.id, \u0026pool).await?,\n\t\t\tchat_session_id: itinerary.chat_session_id,\n\t\t\ttitle: itinerary.title,\n\t\t});\n\t}\n\n\tOk(Json(SavedResponse { itineraries: res }))\n}\n\n/// Get a single saved itinerary either from the user or a public one\n///\n/// # Method\n/// `GET /api/itinerary/{id}`\n///\n/// # Auth\n/// Protected by `auth_middleware` which validates the `auth-token` private cookie,\n/// checks expiration, and injects `Extension\u003cAuthUser\u003e`.\n///\n/// # Responses\n/// - `200 OK` - JSON body `{ \"itinerary\": Itinerary }` containing itinerary metadata\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `404 NOT_FOUND` - When itinerary doesn't exist or doesn't belong to user\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X GET http://localhost:3001/api/itinerary/123\n///   -H \"Cookie: auth-token=...\"\n/// ```\n#[utoipa::path(\n\tget,\n\tpath=\"/saved/{id}\",\n\tsummary=\"Fetch a specific itinerary\",\n\tdescription=\"Fetches the specified itinerary if it belongs to this user or is public.\",\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"The desired itinerary\",\n\t\t\tbody=Itinerary,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=404, description=\"Itinerary not found\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be GET\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_get_itinerary(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tPath(itinerary_id): Path\u003ci32\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n) -\u003e ApiResult\u003cJson\u003cItinerary\u003e\u003e {\n\tdebug!(\n\t\t\"HANDLER -\u003e\u003e /api/itinerary/{} 'api_get_itinerary' - User ID: {}\",\n\t\titinerary_id, user.id\n\t);\n\n\t// Fetch the itinerary - from user or public\n\tlet itinerary: ItineraryRow = sqlx::query_as!(\n\t\tItineraryRow,\n\t\tr#\"SELECT\n        \tid,\n         \taccount_id,\n          \tstart_date,\n           \tend_date,\n            chat_session_id,\n            title\n        FROM itineraries WHERE id = $1 AND (account_id = $2 OR is_public=TRUE)\"#,\n\t\titinerary_id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.ok_or(AppError::NotFound)?;\n\n\tOk(Json(Itinerary {\n\t\tid: itinerary.id,\n\t\tstart_date: itinerary.start_date,\n\t\tend_date: itinerary.end_date,\n\t\tevent_days: itinerary_events(itinerary_id, \u0026pool).await?,\n\t\tchat_session_id: itinerary.chat_session_id,\n\t\ttitle: itinerary.title,\n\t}))\n}\n\n/// Update an existing or save a new itinerary for the user\n///\n/// # Method\n/// `POST /api/itinerary/save`\n///\n/// # Request Body\n/// - [Itinerary]\n///\n/// # Responses\n/// - `200 OK` - with body: [SaveResponse]\n/// - `400 BAD_REQUEST` - Request payload contains invalid data (public error)\n/// - `401 UNAUTHORIZED` - When authentication fails (handled in middleware, public error)\n/// - `500 INTERNAL_SERVER_ERROR` - Internal error (private)\n///\n/// # Examples\n/// ```bash\n/// curl -X POST http://localhost:3001/api/itinerary/save\n///   -H \"Content-Type: application/json\"\n///   -d '{\n///         \"id\": 3,\n///         \"start_date\": \"2025-07-15\",\n///         \"end_date\": \"2025-07-21\",\n///         \"event_days\": [\n///           {\n///             \"morning_events\": [],\n///             \"noon_events\": [\n///               {\n///                 \"id\": 4,\n///                 \"street_address\": \"3399 North Rd\",\n///                 \"postal_code\": 12601,\n///                 \"city\": \"Poughkeepsie\",\n///                 \"event_type\": \"Park\",\n///                 \"event_description\": \"Take a tour of Marist University\",\n///                 \"event_name\": \"Marist University\"\n///               }\n///             ],\n///             \"afternoon_events\": [],\n///             \"evening_events\": [],\n///             \"date\": \"2025-07-21\"\n///           }\n///         ],\n///         \"chat_session_id\": 4,\n///         \"title\": \"Poughkeepsie 7/15-21 2025\"\n///       }'\n/// ```\n#[utoipa::path(\n\tpost,\n\tpath=\"/save\",\n\tsummary=\"Save a new or update an existing itinerary\",\n\tdescription=\"If the itinerary id is already saved for this user, it's updated with the provided values. Otherwise a new one is created.\",\n\trequest_body(\n\t\tcontent=Itinerary,\n\t\tcontent_type=\"application/json\",\n\t\tdescription=\"The itinerary to save for the user.\",\n\t\t//TODO example\n\t),\n\tresponses(\n\t\t(\n\t\t\tstatus=200,\n\t\t\tdescription=\"The id of the itinerary that was just saved. It may be the same as the id passed in the request.\",\n\t\t\tbody=SaveResponse,\n\t\t\tcontent_type=\"application/json\",\n\t\t\t//TODO example\n\t\t),\n\t\t(status=400, description=\"Bad Request\"),\n\t\t(status=401, description=\"User has an invalid cookie/no cookie\"),\n\t\t(status=405, description=\"Method Not Allowed - Must be POST\"),\n\t\t(status=408, description=\"Request Timed Out\"),\n\t\t(status=500, description=\"Internal Server Error\")\n\t),\n\tsecurity((\"set-cookie\"=[])),\n\ttag=\"Itinerary\"\n)]\npub async fn api_save(\n\tExtension(user): Extension\u003cAuthUser\u003e,\n\tExtension(pool): Extension\u003cPgPool\u003e,\n\tJson(itinerary): Json\u003cItinerary\u003e,\n) -\u003e ApiResult\u003cJson\u003cSaveResponse\u003e\u003e {\n\t// check if itinerary id already exists for this user\n\tlet id_opt = sqlx::query!(\n\t\tr#\"SELECT id FROM itineraries WHERE id=$1 AND account_id=$2\"#,\n\t\titinerary.id,\n\t\tuser.id\n\t)\n\t.fetch_optional(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?\n\t.map(|record| record.id);\n\n\t// if it doesn't exist, insert a new one\n\tlet id = match id_opt {\n\t\tSome(id) =\u003e id,\n\t\tNone =\u003e {\n\t\t\tsqlx::query!(\n\t\t\t\tr#\"\n\t\t\t\tINSERT INTO itineraries (account_id, is_public, start_date, end_date, chat_session_id, saved, title)\n\t\t\t\tVALUES ($1, FALSE, $2, $3, $4, TRUE, $5)\n\t\t\t\tRETURNING id;\n\t\t\t\t\"#,\n\t\t\t\tuser.id,\n\t\t\t\titinerary.start_date,\n\t\t\t\titinerary.end_date,\n\t\t\t\titinerary.chat_session_id,\n\t\t\t\titinerary.title\n\t\t\t)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.map_err(|e| AppError::from(e))?\n\t\t\t.id\n\t\t}\n\t};\n\n\t// delete event_list for this itinerary and make a new one\n\tsqlx::query!(\n\t\tr#\"\n\t\tDELETE FROM event_list\n\t\tWHERE itinerary_id=$1;\n\t\t\"#,\n\t\tid\n\t)\n\t.execute(\u0026pool)\n\t.await\n\t.map_err(|e| AppError::from(e))?;\n\n\tinsert_event_list(itinerary, \u0026pool).await?;\n\n\tOk(Json(SaveResponse { id }))\n}\n\n/// Create the itinerary routes with authentication middleware.\n///\n/// # Routes\n/// - `GET /saved` - Get user's saved itineraries (protected)\n/// - `POST /save` - Inserts into or updates the user's itinerary in the db (protected)\n/// - `GET /{id}` - Get single itinerary metadata (protected)\n///\n/// # Middleware\n/// All routes are protected by `middleware_auth` which validates the `auth-token` cookie.\npub fn itinerary_routes() -\u003e AxumRouter {\n\tAxumRouter::new()\n\t\t.route(\"/saved\", get(api_saved_itineraries))\n\t\t.route(\"/save\", post(api_save))\n\t\t.route(\"/{id}\", get(api_get_itinerary))\n\t\t.route_layer(axum::middleware::from_fn(middleware_auth))\n}\n","traces":[{"line":43,"address":[16968471,16969275,16968647,16969419,16968416],"length":1,"stats":{"Line":4}},{"line":44,"address":[16969348,16972024,16969782,16969617,16968690,16969715,16969173,16969397,16968760,16968624],"length":1,"stats":{"Line":4}},{"line":63,"address":[16969260],"length":1,"stats":{"Line":1}},{"line":64,"address":[16969459,16969665,16969378,16968677,16969333],"length":1,"stats":{"Line":4}},{"line":65,"address":[16972044,16969692,16972032,16969750],"length":1,"stats":{"Line":1}},{"line":67,"address":[16969887,16969950],"length":1,"stats":{"Line":2}},{"line":68,"address":[16969980,16972064,16972107,16971684,16970056],"length":1,"stats":{"Line":5}},{"line":69,"address":[16970574,16970294],"length":1,"stats":{"Line":2}},{"line":70,"address":[16970612,16970675],"length":1,"stats":{"Line":2}},{"line":71,"address":[16970776,16970713],"length":1,"stats":{"Line":2}},{"line":72,"address":[16970877,16970814],"length":1,"stats":{"Line":2}},{"line":74,"address":[16970982,16970917],"length":1,"stats":{"Line":2}},{"line":75,"address":[16971110],"length":1,"stats":{"Line":1}},{"line":76,"address":[16971812,16971709],"length":1,"stats":{"Line":2}},{"line":77,"address":[16971847,16971736],"length":1,"stats":{"Line":2}},{"line":78,"address":[16971882,16971763],"length":1,"stats":{"Line":2}},{"line":79,"address":[16971790,16971917],"length":1,"stats":{"Line":2}},{"line":83,"address":[16971153],"length":1,"stats":{"Line":1}},{"line":84,"address":[16971392,16971569],"length":1,"stats":{"Line":2}},{"line":85,"address":[16971229],"length":1,"stats":{"Line":1}},{"line":86,"address":[16971269],"length":1,"stats":{"Line":1}},{"line":87,"address":[16971309],"length":1,"stats":{"Line":1}},{"line":88,"address":[16971349],"length":1,"stats":{"Line":1}},{"line":89,"address":[16971389],"length":1,"stats":{"Line":1}},{"line":93,"address":[16972171,16970320,16972128],"length":1,"stats":{"Line":3}},{"line":95,"address":[16970354],"length":1,"stats":{"Line":1}},{"line":100,"address":[16972473,16972192,16972247,16976587,16974773,16977123],"length":1,"stats":{"Line":4}},{"line":101,"address":[16972438],"length":1,"stats":{"Line":1}},{"line":102,"address":[16976561,16972580,16972450],"length":1,"stats":{"Line":3}},{"line":103,"address":[16972768,16976289,16976344],"length":1,"stats":{"Line":2}},{"line":104,"address":[16976370,16976328,16976425],"length":1,"stats":{"Line":2}},{"line":105,"address":[16976409,16976506,16976451],"length":1,"stats":{"Line":2}},{"line":106,"address":[16976566,16976532,16976490],"length":1,"stats":{"Line":2}},{"line":109,"address":[16972794],"length":1,"stats":{"Line":1}},{"line":110,"address":[16972831],"length":1,"stats":{"Line":1}},{"line":111,"address":[16972919],"length":1,"stats":{"Line":1}},{"line":112,"address":[16973008,16973263,16976143,16973129],"length":1,"stats":{"Line":4}},{"line":113,"address":[16973456,16974828],"length":1,"stats":{"Line":2}},{"line":114,"address":[16974836],"length":1,"stats":{"Line":1}},{"line":115,"address":[16974875],"length":1,"stats":{"Line":1}},{"line":116,"address":[16974914],"length":1,"stats":{"Line":1}},{"line":117,"address":[16975165,16974969],"length":1,"stats":{"Line":1}},{"line":119,"address":[16975209,16975127],"length":1,"stats":{"Line":2}},{"line":120,"address":[16975242],"length":1,"stats":{"Line":1}},{"line":121,"address":[16975339],"length":1,"stats":{"Line":1}},{"line":122,"address":[16975436],"length":1,"stats":{"Line":1}},{"line":124,"address":[16975521],"length":1,"stats":{"Line":1}},{"line":126,"address":[16977460,16977440,16975591],"length":1,"stats":{"Line":3}},{"line":127,"address":[16975723,16977508,16977488],"length":1,"stats":{"Line":3}},{"line":128,"address":[16977556,16975855,16977536],"length":1,"stats":{"Line":3}},{"line":129,"address":[16977604,16975987,16977584],"length":1,"stats":{"Line":3}},{"line":132,"address":[16973857,16976950,16974693,16974588,16976782,16973787,16973686,16973497,16973764,16974751,16976883,16973600],"length":1,"stats":{"Line":7}},{"line":139,"address":[16973522],"length":1,"stats":{"Line":1}},{"line":140,"address":[16973608],"length":1,"stats":{"Line":1}},{"line":141,"address":[16973694],"length":1,"stats":{"Line":1}},{"line":143,"address":[16974655],"length":1,"stats":{"Line":1}},{"line":144,"address":[17482320],"length":1,"stats":{"Line":4}},{"line":145,"address":[16977644,16976918,16977632,16976860],"length":1,"stats":{"Line":1}},{"line":147,"address":[16977007],"length":1,"stats":{"Line":1}},{"line":192,"address":[17194960],"length":1,"stats":{"Line":1}},{"line":196,"address":[16982835,16982273,16982416],"length":1,"stats":{"Line":3}},{"line":202,"address":[16985504,16982790,16984703,16985015,16984917,16984089,16984657,16984493,16985082,16984022],"length":1,"stats":{"Line":4}},{"line":214,"address":[16984580],"length":1,"stats":{"Line":1}},{"line":215,"address":[16984765,16984687,16984965,16982331,16984642],"length":1,"stats":{"Line":4}},{"line":216,"address":[16986912,16986924,16985050,16984992],"length":1,"stats":{"Line":1}},{"line":218,"address":[16985260,16985190],"length":1,"stats":{"Line":2}},{"line":219,"address":[16986153,16986213,16985397,16985286],"length":1,"stats":{"Line":3}},{"line":220,"address":[16986004,16986308],"length":1,"stats":{"Line":0}},{"line":221,"address":[16986322],"length":1,"stats":{"Line":0}},{"line":222,"address":[16986331],"length":1,"stats":{"Line":0}},{"line":223,"address":[16986340],"length":1,"stats":{"Line":0}},{"line":224,"address":[16986696,16986349,16982352,16985818,16985566,16985540],"length":1,"stats":{"Line":0}},{"line":225,"address":[16985958],"length":1,"stats":{"Line":0}},{"line":226,"address":[16985970],"length":1,"stats":{"Line":0}},{"line":230,"address":[16986403],"length":1,"stats":{"Line":1}},{"line":276,"address":[17199200],"length":1,"stats":{"Line":1}},{"line":281,"address":[16989955,16989513,16989370],"length":1,"stats":{"Line":3}},{"line":287,"address":[16991363,16992407,16992293,16991296,16992639,16993057,16992073,16992715,16993029,16991863,16992027,16992483,16989887],"length":1,"stats":{"Line":7}},{"line":300,"address":[16991950],"length":1,"stats":{"Line":1}},{"line":301,"address":[17482012],"length":1,"stats":{"Line":4}},{"line":302,"address":[16992451,16993900,16992384,16993888],"length":1,"stats":{"Line":1}},{"line":303,"address":[16992580,16992683],"length":1,"stats":{"Line":2}},{"line":305,"address":[16993448],"length":1,"stats":{"Line":1}},{"line":306,"address":[16992872],"length":1,"stats":{"Line":1}},{"line":307,"address":[16992878],"length":1,"stats":{"Line":1}},{"line":308,"address":[16992884],"length":1,"stats":{"Line":1}},{"line":309,"address":[16992969,16993067,16989449,16992890],"length":1,"stats":{"Line":3}},{"line":310,"address":[16993414],"length":1,"stats":{"Line":1}},{"line":311,"address":[16993420],"length":1,"stats":{"Line":1}},{"line":388,"address":[17204032],"length":1,"stats":{"Line":1}},{"line":394,"address":[16998132,16997576,16998031,16997753,16998295,16996845,16998199,16996985,16997055,16999626,16997808],"length":1,"stats":{"Line":5}},{"line":399,"address":[16997647],"length":1,"stats":{"Line":1}},{"line":400,"address":[16996909,16997786,16997738,16998079,16997870],"length":1,"stats":{"Line":4}},{"line":401,"address":[17001936,16998109,16998167,17001948],"length":1,"stats":{"Line":1}},{"line":402,"address":[16998260,17001968,17001974],"length":1,"stats":{"Line":3}},{"line":405,"address":[16998309],"length":1,"stats":{"Line":1}},{"line":406,"address":[16998332],"length":1,"stats":{"Line":1}},{"line":408,"address":[16998571,16999504,16999988,16999559,16998365,16999820,17000703,16999372,16999921,16998504],"length":1,"stats":{"Line":4}},{"line":420,"address":[16999446],"length":1,"stats":{"Line":1}},{"line":421,"address":[16999537,16996930,16999868,16999489,16999662],"length":1,"stats":{"Line":4}},{"line":422,"address":[17001984,16999898,17001996,16999956],"length":1,"stats":{"Line":1}},{"line":423,"address":[17000049],"length":1,"stats":{"Line":1}},{"line":428,"address":[17000118,17001281,17000054,17000681,16999589,17000520,17000874,17000629,17000975,17001042],"length":1,"stats":{"Line":4}},{"line":435,"address":[17000571],"length":1,"stats":{"Line":1}},{"line":436,"address":[17000716,16996951,17000614,17000922,17000662],"length":1,"stats":{"Line":4}},{"line":437,"address":[17002028,17002016,17001010,17000952],"length":1,"stats":{"Line":1}},{"line":439,"address":[17001795,17001294,16996972,17001099],"length":1,"stats":{"Line":2}},{"line":441,"address":[17001612],"length":1,"stats":{"Line":1}},{"line":453,"address":[17187776,17188348,17188323],"length":1,"stats":{"Line":1}},{"line":454,"address":[17188151,17187886,17188017,17187940,17188208,17188270,17187783,17188074],"length":1,"stats":{"Line":8}},{"line":455,"address":[17187838,17188383,17187945,17187899,17187845],"length":1,"stats":{"Line":3}},{"line":456,"address":[17187976,17187969,17188371,17188079,17188030],"length":1,"stats":{"Line":3}},{"line":457,"address":[17188103,17188110,17188359,17188164,17188213],"length":1,"stats":{"Line":3}},{"line":458,"address":[17188236,17188283,17188229,17188341],"length":1,"stats":{"Line":2}}],"covered":107,"coverable":114},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","controllers","mod.rs"],"content":"pub mod account;\npub mod chat;\npub mod itinerary;\n\n/// A regular [axum::Router] in test and release builds, or [utoipa_axum::router::OpenApiRouter] in non-test or dev builds\n#[cfg(any(test, not(debug_assertions)))]\npub type AxumRouter = axum::Router;\n/// A regular [axum::Router] in test and release builds, or [utoipa_axum::router::OpenApiRouter] in non-test or dev builds\n#[cfg(all(not(test), debug_assertions))]\npub type AxumRouter = utoipa_axum::router::OpenApiRouter;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","db.rs"],"content":"// src/db/pool.rs\nuse sqlx::{PgPool, postgres::PgPoolOptions};\nuse std::env;\n// Pgpool- A pool of PostgreSQL connections\n// PgPoolOptions - The \"configuration options\" for creating a pool (the max number of connections).\n\npub async fn create_pool() -\u003e PgPool {\n\t// Retrieve the database URL from an environment variable\n\tlet database_url = env::var(\"DATABASE_URL\")\n\t\t//\"Panic\" if no url is found\n\t\t.expect(\"DATABASE_URL must be set in .env or environment\");\n\n\t// Creates a connection pool with up to 5 connections\n\tPgPoolOptions::new()\n\t\t.max_connections(5)\n\t\t.connect(\u0026database_url)\n\t\t.await\n\t\t.expect(\"Failed to create database pool\")\n}\n","traces":[{"line":7,"address":[16934256,16934259],"length":1,"stats":{"Line":5}},{"line":9,"address":[18254384],"length":1,"stats":{"Line":1}},{"line":14,"address":[18254710,18254823,18254543,18255081],"length":1,"stats":{"Line":4}},{"line":16,"address":[18254718,18254659,18254642,18254562,18254867],"length":1,"stats":{"Line":2}},{"line":17,"address":[17570759],"length":1,"stats":{"Line":4}}],"covered":5,"coverable":5},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","error.rs"],"content":"use axum::http::StatusCode;\nuse axum::response::{IntoResponse, Response};\nuse std::fmt;\nuse tracing::error;\n\n// Unified API result type\n#[cfg(not(tarpaulin_include))]\npub type ApiResult\u003cT\u003e = std::result::Result\u003cT, AppError\u003e;\n\n// Single unified error for the API\n#[derive(Debug)]\n#[cfg(not(tarpaulin_include))]\npub enum AppError {\n\tValidation(String),\n\tBadRequest(String),\n\tUnauthorized,\n\tNotFound,\n\tConflict(String),\n\tInternal(String),\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl AppError {\n\tpub fn status_code(\u0026self) -\u003e StatusCode {\n\t\tmatch self {\n\t\t\tAppError::Validation(_) =\u003e StatusCode::BAD_REQUEST,\n\t\t\tAppError::BadRequest(_) =\u003e StatusCode::BAD_REQUEST,\n\t\t\tAppError::Unauthorized =\u003e StatusCode::UNAUTHORIZED,\n\t\t\tAppError::NotFound =\u003e StatusCode::NOT_FOUND,\n\t\t\tAppError::Conflict(_) =\u003e StatusCode::CONFLICT,\n\t\t\tAppError::Internal(_) =\u003e StatusCode::INTERNAL_SERVER_ERROR,\n\t\t}\n\t}\n\n\tpub fn log(\u0026self) {\n\t\tmatch self {\n\t\t\tAppError::Validation(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"validation\", message = %m)\n\t\t\t}\n\t\t\tAppError::BadRequest(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"bad_request\", message = %m)\n\t\t\t}\n\t\t\tAppError::Unauthorized =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"unauthorized\")\n\t\t\t}\n\t\t\tAppError::NotFound =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"not_found\")\n\t\t\t}\n\t\t\tAppError::Conflict(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"conflict\", message = %m)\n\t\t\t}\n\t\t\tAppError::Internal(m) =\u003e {\n\t\t\t\terror!(target: \"api_error\", prefix = \"ERROR -\u003e\u003e\", kind = \"internal\", message = %m)\n\t\t\t}\n\t\t}\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl fmt::Display for AppError {\n\tfn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n\t\tmatch self {\n\t\t\tAppError::Validation(m) =\u003e write!(f, \"validation error: {m}\"),\n\t\t\tAppError::BadRequest(m) =\u003e write!(f, \"bad request: {m}\"),\n\t\t\tAppError::Unauthorized =\u003e write!(f, \"unauthorized\"),\n\t\t\tAppError::NotFound =\u003e write!(f, \"not found\"),\n\t\t\tAppError::Conflict(m) =\u003e write!(f, \"conflict: {m}\"),\n\t\t\tAppError::Internal(m) =\u003e write!(f, \"internal error: {m}\"),\n\t\t}\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl std::error::Error for AppError {}\n\n// Convert common error types into unified Internal errors\n#[cfg(not(tarpaulin_include))]\nimpl From\u003csqlx::Error\u003e for AppError {\n\tfn from(e: sqlx::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"db error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cargon2::password_hash::Error\u003e for AppError {\n\tfn from(e: argon2::password_hash::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"password hash error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cserde_json::Error\u003e for AppError {\n\tfn from(e: serde_json::Error) -\u003e Self {\n\t\tAppError::Internal(format!(\"json error: {e:?}\"))\n\t}\n}\n#[cfg(not(tarpaulin_include))]\nimpl From\u003cstd::env::VarError\u003e for AppError {\n\tfn from(e: std::env::VarError) -\u003e Self {\n\t\tAppError::Internal(format!(\"env error: {e:?}\"))\n\t}\n}\n\n#[cfg(not(tarpaulin_include))]\nimpl IntoResponse for AppError {\n\tfn into_response(self) -\u003e Response {\n\t\t// Always log; return only status code\n\t\tself.log();\n\t\tself.status_code().into_response()\n\t}\n}\n","traces":[{"line":7,"address":[23269904,23270035,23270211,23270103,23269927,23270080,23269984,23270337],"length":1,"stats":{"Line":0}},{"line":8,"address":[19625813],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","global.rs"],"content":"pub const LOG_DIR: \u0026str = concat!(env!(\"CARGO_MANIFEST_DIR\"), \"/logs\");\npub const CRASH_LOG: \u0026str = \"crash.log\";\npub const LATEST_LOG: \u0026str = \"latest.log\";\npub const DIST_DIR: \u0026str = \"frontend/dist\";\npub const MESSAGE_PAGE_LEN: i32 = 10;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","account.rs"],"content":"/*\n * src/models/account.rs\n *\n * File for Account table models and related payload/response types\n *\n * Purpose:\n *   Strongly-typed models for the `accounts` table\n */\n\nuse crate::sql_models::{BudgetBucket, RiskTolerence};\nuse regex::Regex;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\n/// Request payload for POST `/api/account/login`.\n#[derive(Debug, Deserialize, ToSchema)]\npub struct LoginRequest {\n\t/// Account email\n\tpub email: String,\n\t/// Plaintext password submitted by the user\n\tpub password: String,\n}\n\n/// Request payload for POST `/api/account/signup`.\n/// Validated server-side before insert.\n#[derive(Debug, Deserialize, Clone, ToSchema)]\npub struct SignupRequest {\n\t/// Account email\n\tpub email: String,\n\tpub first_name: String,\n\tpub last_name: String,\n\t/// Plaintext password submitted by the user\n\tpub password: String,\n}\n\n/// Request payload for POST `/api/account/update`.\n/// - Only `Some` fields are updated.\n#[derive(Debug, Deserialize, ToSchema)]\npub struct UpdateRequest {\n\t/// Optional new email\n\tpub email: Option\u003cString\u003e,\n\t/// Optional new first name\n\tpub first_name: Option\u003cString\u003e,\n\t/// Optional new last name\n\tpub last_name: Option\u003cString\u003e,\n\t/// Optional new plaintext password\n\tpub password: Option\u003cString\u003e,\n\t/// Optional new budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional new risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional new food and allergies preferences\n\t/// * String is a comma-separated list of preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional new disabilites\n\t/// * String is a comma-separated list of preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\n/// API route response for POST `/api/account/update`.\n/// - Contains full updated account profile for convenience.\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct UpdateResponse {\n\t/// Current email\n\tpub email: String,\n\t/// Current first name\n\tpub first_name: String,\n\t/// Current last name\n\tpub last_name: String,\n\t/// Optional budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional food and allergies preferences\n\t/// * String is a comma-separated list of preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional disabilites\n\t/// * String is a comma-separated list of preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\n/// API route response for GET `/api/account/current`.\n/// - Safe-to-return account profile for current user\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct CurrentResponse {\n\t/// Email\n\tpub email: String,\n\t/// First name\n\tpub first_name: String,\n\t/// Last name\n\tpub last_name: String,\n\t/// Optional budget enum\n\tpub budget_preference: Option\u003cBudgetBucket\u003e,\n\t/// Optional risk enum\n\tpub risk_preference: Option\u003cRiskTolerence\u003e,\n\t/// Optional food and allergies preferences\n\tpub food_allergies: Option\u003cString\u003e,\n\t/// Optional food and allergies preferences\n\tpub disabilities: Option\u003cString\u003e,\n}\n\nimpl SignupRequest {\n\t/// Validate email format using regex.\n\t/// Validate email format using regex\n\tpub fn validate_email(email: \u0026str) -\u003e bool {\n\t\tlet email_regex = Regex::new(r\"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$\").unwrap();\n\t\temail_regex.is_match(email)\n\t}\n\n\t/// Validate password strength\n\t/// - Minimum 8 characters\n\t/// - Maximum 128 characters\n\t/// - At least one uppercase letter\n\t/// - At least one lowercase letter\n\t/// - At least one number\n\t/// - Only ASCII characters allowed (for security and compatibility)\n\tpub fn validate_password(password: \u0026str) -\u003e Result\u003c(), String\u003e {\n\t\tif password.len() \u003c 8 {\n\t\t\treturn Err(\"Password must be at least 8 characters long\".to_string());\n\t\t}\n\n\t\tif password.len() \u003e 128 {\n\t\t\treturn Err(\"Password must be 128 characters or less\".to_string());\n\t\t}\n\n\t\t// Only allow ASCII characters (prevents potential encoding issues)\n\t\tif !password.is_ascii() {\n\t\t\treturn Err(\"Password must contain only ASCII characters\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_uppercase()) {\n\t\t\treturn Err(\"Password must contain at least one uppercase letter\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_lowercase()) {\n\t\t\treturn Err(\"Password must contain at least one lowercase letter\".to_string());\n\t\t}\n\n\t\tif !password.chars().any(|c| c.is_numeric()) {\n\t\t\treturn Err(\"Password must contain at least one number\".to_string());\n\t\t}\n\n\t\tOk(())\n\t}\n\n\t/// Validate the entire signup payload\n\tpub fn validate(\u0026self) -\u003e Result\u003c(), String\u003e {\n\t\t// Validate email (trim before checking)\n\t\tlet email_trimmed = self.email.trim();\n\t\tif email_trimmed.is_empty() {\n\t\t\treturn Err(\"Email is required\".to_string());\n\t\t}\n\n\t\tif !Self::validate_email(email_trimmed) {\n\t\t\treturn Err(\"Invalid email format\".to_string());\n\t\t}\n\n\t\t// Validate first name (trim before checking)\n\t\tlet first_name_trimmed = self.first_name.trim();\n\t\tif first_name_trimmed.is_empty() {\n\t\t\treturn Err(\"First name is required\".to_string());\n\t\t}\n\n\t\tif first_name_trimmed.len() \u003e 50 {\n\t\t\treturn Err(\"First name must be 50 characters or less\".to_string());\n\t\t}\n\n\t\t// Validate last name (trim before checking)\n\t\tlet last_name_trimmed = self.last_name.trim();\n\t\tif last_name_trimmed.is_empty() {\n\t\t\treturn Err(\"Last name is required\".to_string());\n\t\t}\n\n\t\tif last_name_trimmed.len() \u003e 50 {\n\t\t\treturn Err(\"Last name must be 50 characters or less\".to_string());\n\t\t}\n\n\t\t// Validate password\n\t\tSelf::validate_password(\u0026self.password)?;\n\n\t\tOk(())\n\t}\n}\n","traces":[{"line":105,"address":[18149600,18149769,18149775],"length":1,"stats":{"Line":1}},{"line":106,"address":[18149627],"length":1,"stats":{"Line":1}},{"line":107,"address":[18149698],"length":1,"stats":{"Line":1}},{"line":117,"address":[18149792],"length":1,"stats":{"Line":1}},{"line":118,"address":[18149851],"length":1,"stats":{"Line":1}},{"line":119,"address":[18149887],"length":1,"stats":{"Line":1}},{"line":122,"address":[18149872],"length":1,"stats":{"Line":1}},{"line":123,"address":[18149967],"length":1,"stats":{"Line":1}},{"line":127,"address":[18149956],"length":1,"stats":{"Line":1}},{"line":128,"address":[18150023],"length":1,"stats":{"Line":1}},{"line":131,"address":[17262392,17262368],"length":1,"stats":{"Line":3}},{"line":132,"address":[18150133],"length":1,"stats":{"Line":1}},{"line":135,"address":[17262440,17262416],"length":1,"stats":{"Line":3}},{"line":136,"address":[18150249],"length":1,"stats":{"Line":1}},{"line":139,"address":[17262464,17262488],"length":1,"stats":{"Line":3}},{"line":140,"address":[18150368],"length":1,"stats":{"Line":1}},{"line":143,"address":[18150444],"length":1,"stats":{"Line":1}},{"line":147,"address":[18150464],"length":1,"stats":{"Line":1}},{"line":149,"address":[18150502],"length":1,"stats":{"Line":1}},{"line":150,"address":[18150550],"length":1,"stats":{"Line":1}},{"line":151,"address":[18150580],"length":1,"stats":{"Line":1}},{"line":154,"address":[18150569],"length":1,"stats":{"Line":1}},{"line":155,"address":[18150636],"length":1,"stats":{"Line":1}},{"line":159,"address":[18150697],"length":1,"stats":{"Line":1}},{"line":160,"address":[18150749],"length":1,"stats":{"Line":1}},{"line":161,"address":[18150800],"length":1,"stats":{"Line":1}},{"line":164,"address":[18150783],"length":1,"stats":{"Line":1}},{"line":165,"address":[18150936],"length":1,"stats":{"Line":1}},{"line":169,"address":[18150873],"length":1,"stats":{"Line":1}},{"line":170,"address":[18150925],"length":1,"stats":{"Line":1}},{"line":171,"address":[18151034],"length":1,"stats":{"Line":1}},{"line":174,"address":[18151017],"length":1,"stats":{"Line":1}},{"line":175,"address":[18151199],"length":1,"stats":{"Line":1}},{"line":179,"address":[18151110,18151275],"length":1,"stats":{"Line":2}},{"line":181,"address":[18151354],"length":1,"stats":{"Line":1}}],"covered":35,"coverable":35},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","chat_session.rs"],"content":"use serde::Serialize;\nuse utoipa::{ToResponse, ToSchema};\n\nuse crate::sql_models::message::ChatSessionRow;\n\n/// Response model from the `/api/chat/chats` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct ChatsResponse {\n\t/// chat session ids belonging to the user who made the request\n\tpub chat_sessions: Vec\u003cChatSessionRow\u003e,\n}\n\n/// Response model from the `/api/chat/newChat` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct NewChatResponse {\n\t/// this chat session is guaranteed to not have any messages in it\n\tpub chat_session_id: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","event.rs"],"content":"use serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\nuse crate::sql_models::event_list::EventListJoinRow;\n\n/// A single event without context from an itinerary\n#[derive(Debug, Serialize, Deserialize, FromRow, ToSchema)]\npub struct Event {\n\t/// Primary key\n\tpub id: i32,\n\tpub street_address: String,\n\tpub postal_code: i32,\n\tpub city: String,\n\tpub event_type: String,\n\tpub event_description: String,\n\tpub event_name: String,\n}\n\nimpl From\u003c\u0026EventListJoinRow\u003e for Event {\n\t#[cfg(not(tarpaulin_include))]\n\tfn from(value: \u0026EventListJoinRow) -\u003e Self {\n\t\tSelf {\n\t\t\tid: value.id,\n\t\t\tstreet_address: value.street_address.clone(),\n\t\t\tpostal_code: value.postal_code,\n\t\t\tcity: value.city.clone(),\n\t\t\tevent_type: value.event_type.clone(),\n\t\t\tevent_description: value.event_description.clone(),\n\t\t\tevent_name: value.event_name.clone(),\n\t\t}\n\t}\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","itinerary.rs"],"content":"/*\n * src/models/itinerary.rs\n *\n * File for Itinerary table models and related responses\n *\n * Purpose:\n *   Strongly-typed models for the `itineraries` response DTOs\n *   used by itinerary routes.\n */\n\nuse chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\nuse crate::http_models::event::Event;\n\n/// A complete itinerary with event details\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct Itinerary {\n\t/// Primary key\n\tpub id: i32,\n\t/// UTC date that the first event may take place (%Y-%m-%d)\n\tpub start_date: NaiveDate,\n\t/// UTC date that the last event may take place (%Y-%m-%d)\n\tpub end_date: NaiveDate,\n\t/// List of days containing events for that day\n\t/// * Days are guaranteed to be sorted in chronological order\n\tpub event_days: Vec\u003cEventDay\u003e,\n\t/// Possible associated chat session for easy editing on frontend\n\tpub chat_session_id: Option\u003ci32\u003e,\n\t/// Title of itinerary, defaults to include location and date range\n\tpub title: String,\n}\n\n/// A single day of events in an itinerary\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct EventDay {\n\t/// All the events taking place in the morning\n\tpub morning_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place around noon\n\tpub noon_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place in the afternoon\n\tpub afternoon_events: Vec\u003cEvent\u003e,\n\t/// All the events taking place in the evening\n\tpub evening_events: Vec\u003cEvent\u003e,\n\t/// The UTC date of this day within the range of itinerary start and end dates (%Y-%m-%d)\n\tpub date: NaiveDate,\n}\n\n/// API route response for GET `/api/itinerary/saved`\n#[derive(Debug, Serialize, Deserialize, ToSchema, ToResponse)]\npub struct SavedResponse {\n\t/// List of saved itineraries for the user.\n\tpub itineraries: Vec\u003cItinerary\u003e,\n}\n\n/// Response model from `/api/itinerary/save` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct SaveResponse {\n\t/// id of the itinerary that was just saved\n\t/// * May be the same as the itinerary id passed in the request\n\tpub id: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","message.rs"],"content":"use chrono::NaiveDateTime;\nuse serde::{Deserialize, Serialize};\nuse utoipa::{ToResponse, ToSchema};\n\n/// A message in a chat session\n#[derive(Debug, Serialize, ToSchema, ToResponse)]\npub struct Message {\n\t/// Primary key\n\tpub id: i32,\n\t/// Whether the message was sent by a user or generated by the LLM\n\tpub is_user: bool,\n\t/// UTC timestamp this message was sent (%Y-%m-%d %H:%M:%S)\n\tpub timestamp: NaiveDateTime,\n\t/// Content of this message\n\tpub text: String,\n\t/// Possible itinerary associated with this message\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/messagePage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct MessagePageRequest {\n\t/// chat session to fetch page from\n\tpub chat_session_id: i32,\n\t/// Possible message id to represent the end of the page\n\t/// * If Some, it will fetch this message and consecutive previous messages in chronological order\n\t/// * If None, it will fetch the latest consecutive messages from the chat session in chronological order\n\tpub message_id: Option\u003ci32\u003e,\n}\n\n/// Response model for `/api/chat/messagePage` endpoint\n#[derive(Serialize, ToSchema, ToResponse)]\npub struct MessagePageResponse {\n\t/// A page of messages guaranteed to be sorted in chronological order\n\tpub message_page: Vec\u003cMessage\u003e,\n\t/// The id of the message that comes chronologically before the first message in message_page, if it exists\n\tpub prev_message_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/updateMessage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct UpdateMessageRequest {\n\t/// ID of the message to update. This message must belong to a chat session which belongs to the user who made the request\n\tpub message_id: i32,\n\t/// The text to replace the old content with\n\tpub new_text: String,\n\t/// A possible itinerary to give context to the LLM\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Request model for `/api/chat/sendMessage` endpoint\n#[derive(Deserialize, ToSchema)]\npub struct SendMessageRequest {\n\t/// The chat session to send this message in. It must belong to the user making the request.\n\tpub chat_session_id: i32,\n\t/// The content of the message\n\tpub text: String,\n\t/// A possible itinerary to give context to the LLM\n\tpub itinerary_id: Option\u003ci32\u003e,\n}\n\n/// Response model for `/api/chat/sendMessage` endpoint\n#[derive(Debug, Serialize, ToSchema, ToResponse)]\npub struct SendMessageResponse {\n\t/// The newly-created id of the message you just sent\n\tpub user_message_id: i32,\n\t/// The response message from the LLM\n\tpub bot_message: Message,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","http_models","mod.rs"],"content":"pub mod account;\npub mod chat_session;\npub mod event;\npub mod itinerary;\npub mod message;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","log.rs"],"content":"use {\n\tcrate::global::*,\n\tstd::{\n\t\tfs::{self, File},\n\t\tio::{BufWriter, Write},\n\t\tpath::Path,\n\t\tsync::{Once, OnceLock},\n\t},\n\ttracing::error,\n\ttracing_appender::{non_blocking::NonBlocking, rolling},\n\ttracing_subscriber::{\n\t\tEnvFilter, Layer, fmt::time::SystemTime, layer::SubscriberExt, util::SubscriberInitExt,\n\t},\n};\n\nstatic INIT_LOG: Once = Once::new();\nstatic mut LOG_WRITER: OnceLock\u003cNonBlocking\u003e = OnceLock::new();\n\n/// When the program panics, the backtrace is outputted to `logs/crash.log`.\npub fn init_panic_handler() {\n\tunsafe {\n\t\t// Safety\n\t\t//\n\t\t// Always safe on Windows.\n\t\t//\n\t\t// Other platforms: risk of race condition in multi-threaded environment.\n\t\t// We are not reading/writing this environment variable from multiple threads, so we're good.\n\t\tstd::env::set_var(\"RUST_BACKTRACE\", \"full\");\n\t}\n\tstd::panic::set_hook(Box::new(move |panic_info| {\n\t\tconst WRITE_ERR: \u0026str = \"Could not write to crash log\";\n\t\terror!(\"{}\", panic_info);\n\t\tprintln!(\"{}\", panic_info);\n\n\t\tfs::create_dir_all(LOG_DIR).expect(\"Could create crash log\");\n\t\tlet file = File::create(Path::new(LOG_DIR).join(CRASH_LOG))\n\t\t\t.expect(\"Could not create crash log file\");\n\t\tlet backtrace = std::backtrace::Backtrace::capture();\n\t\tlet mut writer = BufWriter::new(file);\n\n\t\twriteln!(writer, \"Time: {}\", chrono::Local::now()).expect(WRITE_ERR);\n\t\twriteln!(writer, \"{panic_info}\").expect(WRITE_ERR);\n\t\twriteln!(writer, \"stack backtrace:\\n{backtrace}\").expect(WRITE_ERR);\n\t\twriteln!(writer, \"Process finished with exit code 101\").expect(WRITE_ERR);\n\t\twriter.flush().expect(WRITE_ERR);\n\t}));\n}\n\n/// Creates a tracing registry and adds a layer to it. Layer outputs to `logs/latest.log`.\n///\n/// See `.env` variable `RUST_LOG` for layer filter. These variables should be loaded into the environment for the filter to work.\n/// See [dotenvy].\npub fn init_logger() {\n\tINIT_LOG.call_once(|| {\n\t\t_ = fs::remove_file(Path::new(LOG_DIR).join(LATEST_LOG));\n\t\tlet (log_writer, log_guard) =\n\t\t\ttracing_appender::non_blocking(rolling::never(LOG_DIR, LATEST_LOG));\n\t\tlet latest_log_layer = tracing_subscriber::fmt::layer()\n\t\t\t.with_timer(SystemTime)\n\t\t\t.with_ansi(false)\n\t\t\t.log_internal_errors(true)\n\t\t\t.with_target(true)\n\t\t\t.with_file(true)\n\t\t\t.with_line_number(true)\n\t\t\t.with_level(true)\n\t\t\t.with_thread_names(true)\n\t\t\t.with_thread_ids(true)\n\t\t\t.pretty()\n\t\t\t.with_writer(log_writer.clone())\n\t\t\t.with_filter(EnvFilter::from_default_env());\n\t\ttracing_subscriber::registry().with(latest_log_layer).init();\n\n\t\t#[allow(static_mut_refs)]\n\t\tunsafe {\n\t\t\t_ = LOG_WRITER.set(log_writer);\n\t\t}\n\n\t\t// log_guard has to have a static lifetime.\n\t\t// We can just let the OS clean it up for us when the process is killed.\n\t\t// We can make as many loggers as we want.\n\t\tBox::leak(Box::new(log_guard));\n\t})\n}\n\n#[allow(unused)]\npub fn log_writer() -\u003e \u0026'static mut NonBlocking {\n\t#[allow(static_mut_refs)]\n\tunsafe {\n\t\tLOG_WRITER.get_mut().expect(\"Logger not initialized\")\n\t}\n}\n","traces":[{"line":23,"address":[19254256],"length":1,"stats":{"Line":1}},{"line":31,"address":[19254257],"length":1,"stats":{"Line":1}},{"line":33,"address":[16917565,16915264,16917559],"length":1,"stats":{"Line":2}},{"line":35,"address":[16916200,16915287],"length":1,"stats":{"Line":1}},{"line":36,"address":[16915924],"length":1,"stats":{"Line":1}},{"line":38,"address":[16915996],"length":1,"stats":{"Line":1}},{"line":39,"address":[16916064],"length":1,"stats":{"Line":1}},{"line":40,"address":[16916178],"length":1,"stats":{"Line":1}},{"line":41,"address":[16916840],"length":1,"stats":{"Line":1}},{"line":43,"address":[16916979,16916907],"length":1,"stats":{"Line":2}},{"line":44,"address":[16917115],"length":1,"stats":{"Line":1}},{"line":45,"address":[16917251],"length":1,"stats":{"Line":1}},{"line":46,"address":[16917371],"length":1,"stats":{"Line":1}},{"line":47,"address":[16917468],"length":1,"stats":{"Line":1}},{"line":55,"address":[19254320],"length":1,"stats":{"Line":1}},{"line":56,"address":[16918910,16917600,16918855],"length":1,"stats":{"Line":2}},{"line":57,"address":[16917637],"length":1,"stats":{"Line":1}},{"line":58,"address":[16917811],"length":1,"stats":{"Line":1}},{"line":59,"address":[16918386,16917948],"length":1,"stats":{"Line":2}},{"line":60,"address":[16918012],"length":1,"stats":{"Line":1}},{"line":61,"address":[16918037],"length":1,"stats":{"Line":1}},{"line":62,"address":[16918044],"length":1,"stats":{"Line":1}},{"line":63,"address":[16918097],"length":1,"stats":{"Line":1}},{"line":64,"address":[16918125],"length":1,"stats":{"Line":1}},{"line":65,"address":[16918153],"length":1,"stats":{"Line":1}},{"line":66,"address":[16918181],"length":1,"stats":{"Line":1}},{"line":67,"address":[16918209],"length":1,"stats":{"Line":1}},{"line":68,"address":[16918237],"length":1,"stats":{"Line":1}},{"line":69,"address":[16918260],"length":1,"stats":{"Line":1}},{"line":70,"address":[16918280],"length":1,"stats":{"Line":1}},{"line":71,"address":[16918345,16918869,16918418,16918326],"length":1,"stats":{"Line":2}},{"line":72,"address":[16918441,16918501],"length":1,"stats":{"Line":2}},{"line":75,"address":[16918587],"length":1,"stats":{"Line":1}},{"line":80,"address":[16918703],"length":1,"stats":{"Line":1}},{"line":85,"address":[19254352],"length":1,"stats":{"Line":1}},{"line":87,"address":[19254418,19254353],"length":1,"stats":{"Line":1}}],"covered":36,"coverable":36},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","main.rs"],"content":"#![allow(unexpected_cfgs)]\n\nmod controllers;\nmod db;\nmod error;\nmod global;\nmod http_models;\nmod log;\nmod middleware;\nmod sql_models;\n\n#[cfg(not(tarpaulin_include))]\nmod swagger;\n\n#[cfg(test)]\nmod tests;\n\nuse crate::controllers::AxumRouter;\nuse crate::global::*;\nuse axum::{Extension, routing::get_service};\nuse http::{Method, header::HeaderValue};\nuse std::env;\nuse std::net::SocketAddr;\nuse std::path::Path;\nuse std::str::FromStr;\nuse tower_cookies::CookieManagerLayer;\nuse tower_cookies::cookie::Key;\nuse tower_http::{\n\tcors::CorsLayer,\n\tservices::{ServeDir, ServeFile},\n};\n\n#[cfg(not(tarpaulin_include))]\n#[tokio::main]\nasync fn main() -\u003e std::result::Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n\t// Load our evironment variables\n\tdotenvy::dotenv().ok();\n\tlog::init_panic_handler();\n\tlog::init_logger();\n\n\t// Read and store loaded environment variables\n\tlet api_base_url = env::var(\"API_BASE_URL\").expect(\"API_BASE_URL must be set\");\n\tlet front_end_url = env::var(\"FRONTEND_URL\").expect(\"FRONTEND_URL must be set\");\n\tlet bind_address = env::var(\"BIND_ADDRESS\").expect(\"BIND_ADDRESS must be set\");\n\n\t// Initialize the database pool connection\n\tlet pool = db::create_pool().await;\n\n\t/*\n\t/ Configure CORS\n\t/ CORS is needed when a frontend (running on one domain or port)\n\t/ wants to send HTTP requests to a backend running on another domain or port.\n\t/ This is needed for the frontend to send requests to the backend.\n\t/ We allow all origins, methods, and headers currently, but this should be changed later for security.\n\t/ TODO: Ensure we have all the right values below, may need to constrict the requests we accept\n\t*/\n\tlet cors = CorsLayer::new()\n\t\t.allow_origin(\n\t\t\tfront_end_url\n\t\t\t\t.parse::\u003cHeaderValue\u003e()\n\t\t\t\t.expect(\"Invalid frontend_url format\"),\n\t\t)\n\t\t.allow_credentials(true)\n\t\t.allow_methods([Method::GET, Method::POST, Method::DELETE])\n\t\t.allow_headers([\n\t\t\thttp::header::CONTENT_TYPE,\n\t\t\thttp::header::ACCEPT,\n\t\t\thttp::header::AUTHORIZATION,\n\t\t\thttp::header::HeaderName::from_static(\"x-requested-with\"),\n\t\t]);\n\n\t// Use an encryption/signing key for private cookies\n\tlet cookie_key = Key::generate();\n\n\t// API routes with CORS middleware\n\tlet api_routes = AxumRouter::new()\n\t\t.nest(\"/account\", controllers::account::account_routes())\n\t\t.nest(\"/itinerary\", controllers::itinerary::itinerary_routes())\n\t\t.nest(\"/chat\", controllers::chat::chat_routes());\n\t// TODO: nest other routes...\n\n\tlet api_routes = AxumRouter::new().nest(\"/api\", api_routes);\n\n\t#[cfg(all(not(test), debug_assertions))]\n\tlet api_routes = crate::swagger::merge_swagger(api_routes);\n\n\t// Build the main router\n\tlet app = axum::Router::new()\n\t\t.merge(api_routes)\n\t\t// Static files served from /dist.\n\t\t// Fallback must be index.html since react handles routing on front end\n\t\t.fallback_service(get_service(\n\t\t\tServeDir::new(DIST_DIR)\n\t\t\t\t.fallback(ServeFile::new(Path::new(DIST_DIR).join(\"index.html\"))),\n\t\t))\n\t\t.layer(Extension(pool.clone()))\n\t\t.layer(Extension(cookie_key.clone()))\n\t\t.layer(CookieManagerLayer::new())\n\t\t.layer(cors);\n\n\t/*\n\t/ Bind the router to a specific port\n\t/ We use the SocketAddr struct to bind the router to the port\n\t/ We use the 0.0.0.0 address to bind the router to localhost\n\t/ We will bind to port 3001 for now\n\t*/\n\tlet addr = SocketAddr::from_str(\u0026bind_address).expect(\"Invalid BIND_ADDRESS format\");\n\tprintln!(\"Server starting on {}\", api_base_url);\n\n\t/*\n\t/ Serve the router ie: Start the server\n\t/ We will start the server with the configured router and address\n\t*/\n\tlet listener = tokio::net::TcpListener::bind(addr).await.unwrap();\n\taxum::serve(listener, app.into_make_service()).await?;\n\n\tOk(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","middleware.rs"],"content":"use crate::error::AppError;\nuse axum::{extract::Request, http::header, middleware::Next, response::IntoResponse};\nuse chrono::Utc;\nuse sqlx::PgPool;\nuse tower_cookies::cookie::{Cookie, CookieJar, Key};\n\n/// Inserted into request extensions on authenticated requests\n#[derive(Clone, Copy, Debug)]\npub struct AuthUser {\n\tpub id: i32,\n}\n\n/// Auth middleware for account routes\n/// - Decrypts `auth-token` private cookie using `Key` from extensions\n/// - Validates embedded expiration and that the user exists in DB\n/// - Inserts `AuthUser` into request extensions on success; otherwise 401\npub async fn middleware_auth(mut req: Request, next: Next) -\u003e impl IntoResponse {\n\tlet key = match req.extensions().get::\u003cKey\u003e() {\n\t\tSome(k) =\u003e k.clone(),\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet pool = match req.extensions().get::\u003cPgPool\u003e() {\n\t\tSome(p) =\u003e p.clone(),\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\t// Read Cookie header\n\tlet cookie_header = match req.headers().get(header::COOKIE) {\n\t\tSome(v) =\u003e v,\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet cookie_str = match cookie_header.to_str() {\n\t\tOk(s) =\u003e s,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\t// Build a jar from incoming cookies\n\tlet mut jar = CookieJar::new();\n\tfor pair in cookie_str.split(';') {\n\t\tlet s = pair.trim();\n\t\tif s.is_empty() {\n\t\t\tcontinue;\n\t\t}\n\t\tif let Ok(parsed) = Cookie::parse(s.to_string()) {\n\t\t\tjar.add(parsed);\n\t\t}\n\t}\n\n\t// Decrypt private cookie and extract token\n\tlet decrypted = match jar.private(\u0026key).get(\"auth-token\") {\n\t\tSome(c) =\u003e c,\n\t\tNone =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\tlet token = decrypted.value().to_string();\n\n\t// Expect format: user-\u003cid\u003e.\u003cexp\u003e.sign\n\tlet parts: Vec\u003c\u0026str\u003e = token.split('.').collect();\n\n\tif parts.len() != 3 || parts[2] != \"sign\" || !parts[0].starts_with(\"user-\") {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\tlet user_id: i32 = match parts[0][5..].parse() {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\tlet exp: i64 = match parts[1].parse() {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e return AppError::Unauthorized.into_response(),\n\t};\n\n\tif Utc::now().timestamp() \u003e exp {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\t// Ensure user exists\n\tlet exists_row =\n\t\tsqlx::query_as::\u003c_, (bool,)\u003e(\"SELECT EXISTS(SELECT 1 FROM accounts WHERE id = $1)\")\n\t\t\t.bind(user_id)\n\t\t\t.fetch_one(\u0026pool)\n\t\t\t.await\n\t\t\t.unwrap_or((false,));\n\n\tif !exists_row.0 {\n\t\treturn AppError::Unauthorized.into_response();\n\t}\n\n\t// Attach user to request\n\treq.extensions_mut().insert(AuthUser { id: user_id });\n\n\tnext.run(req).await\n}\n","traces":[{"line":22,"address":[17816467,17820661,17820325,17816400,17819805,17816655],"length":1,"stats":{"Line":4}},{"line":23,"address":[17816636,17816775],"length":1,"stats":{"Line":2}},{"line":24,"address":[17816845],"length":1,"stats":{"Line":1}},{"line":25,"address":[17816875],"length":1,"stats":{"Line":0}},{"line":27,"address":[17816949],"length":1,"stats":{"Line":1}},{"line":28,"address":[17817166,17817053],"length":1,"stats":{"Line":2}},{"line":29,"address":[17817102],"length":1,"stats":{"Line":0}},{"line":33,"address":[17817250,17817169],"length":1,"stats":{"Line":2}},{"line":34,"address":[17817354],"length":1,"stats":{"Line":1}},{"line":35,"address":[17817397],"length":1,"stats":{"Line":1}},{"line":37,"address":[17817370,17817479],"length":1,"stats":{"Line":2}},{"line":38,"address":[17817572],"length":1,"stats":{"Line":1}},{"line":39,"address":[17819800,17817526],"length":1,"stats":{"Line":0}},{"line":43,"address":[17817620],"length":1,"stats":{"Line":1}},{"line":44,"address":[17817729,17817654],"length":1,"stats":{"Line":2}},{"line":45,"address":[17817912,17819579],"length":1,"stats":{"Line":2}},{"line":46,"address":[17819611],"length":1,"stats":{"Line":1}},{"line":49,"address":[17819646],"length":1,"stats":{"Line":1}},{"line":50,"address":[17819777],"length":1,"stats":{"Line":1}},{"line":55,"address":[17817946],"length":1,"stats":{"Line":1}},{"line":56,"address":[17818114],"length":1,"stats":{"Line":1}},{"line":57,"address":[17818196],"length":1,"stats":{"Line":0}},{"line":59,"address":[17818173,17818337],"length":1,"stats":{"Line":2}},{"line":62,"address":[17818363,17818460],"length":1,"stats":{"Line":2}},{"line":64,"address":[17818709,17818526,17818611],"length":1,"stats":{"Line":3}},{"line":65,"address":[17819561,17818663],"length":1,"stats":{"Line":0}},{"line":68,"address":[17818861],"length":1,"stats":{"Line":1}},{"line":69,"address":[17819073],"length":1,"stats":{"Line":1}},{"line":70,"address":[17819559,17819027],"length":1,"stats":{"Line":0}},{"line":73,"address":[17819093],"length":1,"stats":{"Line":1}},{"line":74,"address":[17819217],"length":1,"stats":{"Line":1}},{"line":75,"address":[17819179,17819557],"length":1,"stats":{"Line":0}},{"line":78,"address":[17819238],"length":1,"stats":{"Line":1}},{"line":79,"address":[17819327,17819526],"length":1,"stats":{"Line":0}},{"line":83,"address":[17819471,17819997,17820084,17819296],"length":1,"stats":{"Line":4}},{"line":85,"address":[17819373],"length":1,"stats":{"Line":1}},{"line":86,"address":[17819410],"length":1,"stats":{"Line":1}},{"line":87,"address":[17577836],"length":1,"stats":{"Line":4}},{"line":88,"address":[17820069],"length":1,"stats":{"Line":1}},{"line":90,"address":[17820096],"length":1,"stats":{"Line":1}},{"line":91,"address":[17820165,17820100],"length":1,"stats":{"Line":0}},{"line":95,"address":[17820143,17820452],"length":1,"stats":{"Line":2}},{"line":97,"address":[17577857],"length":1,"stats":{"Line":1}}],"covered":34,"coverable":43},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","account.rs"],"content":"/// Row model for the `accounts` table.\n/// - Represents a persisted user.\npub struct AccountRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Unique email address\n\t#[allow(dead_code)] // email required for login route\n\tpub email: String,\n\t/// Argon2 hashed password\n\tpub password: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","event_list.rs"],"content":"use chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\n\nuse crate::sql_models::TimeOfDay;\n\n/// Row model for an inner join of `event_list` and `events` tables on chat session id.\n/// - Represents one event for an itinerary.\n#[derive(Debug, Serialize, Deserialize)]\npub struct EventListJoinRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Morning/Noon/Afternoon/Evening\n\tpub time_of_day: TimeOfDay,\n\t/// UTC date within itinerary date range (%Y-%m-%d)\n\tpub date: NaiveDate,\n\t/// Event address\n\tpub street_address: String,\n\t/// Event post code\n\tpub postal_code: i32,\n\t/// Event City\n\tpub city: String,\n\t/// Event type\n\tpub event_type: String,\n\t/// Event description\n\tpub event_description: String,\n\t/// Event name\n\tpub event_name: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","itinerary.rs"],"content":"use chrono::NaiveDate;\nuse serde::{Deserialize, Serialize};\n\n/// Row model for the `itineraries` table.\n#[derive(Debug, Serialize, Deserialize)]\npub struct ItineraryRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Owner account id (FK)\n\tpub account_id: Option\u003ci32\u003e,\n\t/// Start date for itinerary (UTC naive %Y-%m-%d)\n\tpub start_date: NaiveDate,\n\t/// End date for itinerary (UTC naive %Y-%m-%d)\n\tpub end_date: NaiveDate,\n\t/// Possible chat session to link to if this itinerary is edited\n\tpub chat_session_id: Option\u003ci32\u003e,\n\t/// Title of itinerary, defaults to include location and date range\n\tpub title: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","message.rs"],"content":"use chrono::NaiveDateTime;\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse utoipa::ToSchema;\n\n/// Row model for `chat_sessions` table\n#[derive(Serialize, Deserialize, FromRow, ToSchema)]\npub struct ChatSessionRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Name of chat for user context\n\tpub title: String,\n}\n\n/// Row model for `message` table\n#[derive(Serialize, Deserialize, FromRow)]\npub struct MessageRow {\n\t/// Primary key\n\tpub id: i32,\n\t/// Chat session this message belongs to\n\tpub chat_session_id: i32,\n\t/// Possible itinerary associated with this message\n\tpub itinerary_id: Option\u003ci32\u003e,\n\t/// Whether this message was sent by the user or generated by the LLM\n\tpub is_user: bool,\n\t/// UTC timestamp this message was sent (%Y-%m-%d %H:%M:%S)\n\tpub timestamp: NaiveDateTime,\n\t/// Content of the message\n\tpub text: String,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","sql_models","mod.rs"],"content":"use serde::{Deserialize, Serialize};\nuse sqlx::Type;\nuse utoipa::ToSchema;\n\npub mod account;\npub mod event_list;\npub mod itinerary;\npub mod message;\n\n/// Budget preference enum mapped to Postgres `budget_bucket`.\n/// Used in account preferences and returned by account APIs.\n/// - Fields:\n///   - Enum variants representing budget bands\n#[derive(Debug, Serialize, Deserialize, Clone, Type, ToSchema)]\n#[sqlx(type_name = \"budget_bucket\")]\npub enum BudgetBucket {\n\tVeryLowBudget,\n\tLowBudget,\n\tMediumBudget,\n\tHighBudget,\n\tLuxuryBudget,\n}\n\n/// Risk tolerance enum mapped to Postgres `risk_tolerence`.\n/// Used in account preferences and returned by account APIs.\n/// - Fields:\n///   - Enum variants representing risk appetite\n#[derive(Debug, Serialize, Deserialize, Clone, Type, ToSchema)]\n#[sqlx(type_name = \"risk_tolerence\")]\npub enum RiskTolerence {\n\tChillVibes,\n\tLightFun,\n\tAdventurer,\n\tRiskTaker,\n}\n\n/// The time of day the event will take place in the itinerary\n#[derive(Debug, Serialize, Deserialize, Clone, Type, PartialEq)]\n#[sqlx(type_name = \"time_of_day\")]\npub enum TimeOfDay {\n\tMorning,\n\tNoon,\n\tAfternoon,\n\tEvening,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","swagger.rs"],"content":"use axum::Router;\nuse std::fs::{self, File};\nuse std::io::Write;\nuse utoipa::{\n\tModify, OpenApi,\n\topenapi::security::{ApiKey, ApiKeyValue, SecurityScheme},\n};\nuse utoipa_axum::router::OpenApiRouter;\nuse utoipa_swagger_ui::SwaggerUi;\n\nuse crate::controllers::{account::AccountApiDoc, chat::ChatApiDoc, itinerary::ItineraryApiDoc};\n\n#[derive(OpenApi)]\n#[openapi(\n\tmodifiers(\u0026SecurityAddon),\n\tsecurity(\n\t\t(),\n\t\t(\"set-cookie\"=[])\n\t),\n    info(\n    \ttitle=\"Journey API\",\n    \tdescription = \"The public API documentation for the Journey web application.\"\n    ),\n    nest(\n    \t(path=\"/api/account\", api=AccountApiDoc),\n    \t(path=\"/api/chat\", api=ChatApiDoc),\n    \t(path=\"/api/itinerary\", api=ItineraryApiDoc)\n    ),\n    servers(\n    \t(url=\"http://localhost:3001\", description=\"Local host server for development\"),\n     \t//TODO add deployed production server URL\n    )\n)]\nstruct ApiDoc;\n\npub struct SecurityAddon;\n\nimpl Modify for SecurityAddon {\n\tfn modify(\u0026self, openapi: \u0026mut utoipa::openapi::OpenApi) {\n\t\tif let Some(components) = openapi.components.as_mut() {\n\t\t\tcomponents.add_security_scheme(\n                \"set-cookie\",\n                SecurityScheme::ApiKey(ApiKey::Cookie(ApiKeyValue::with_description(\n                \t\"auth-token\",\n                 \t\"An HTTP-only cookie which must encode a valid account id, expiration timestamp, and other information\"\n                ))),\n            )\n\t\t}\n\t}\n}\n\n/// Merges swagger with the current routes\npub fn merge_swagger(router: OpenApiRouter) -\u003e Router {\n\tlet doc = ApiDoc::openapi();\n\tfs::create_dir_all(\"docs\").unwrap();\n\tlet mut file = File::create(\"docs/openapi.json\").unwrap();\n\tfile.write_all(doc.to_pretty_json().unwrap().as_bytes())\n\t\t.unwrap();\n\tlet (router, api) = OpenApiRouter::with_openapi(doc)\n\t\t.merge(router)\n\t\t.split_for_parts();\n\trouter.merge(SwaggerUi::new(\"/swagger\").url(\"/docs/openapi.json\", api.clone()))\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","eclipse","marist","senior","capping","Capping2025","src","tests.rs"],"content":"use crate::{\n\tcontrollers, db,\n\tglobal::*,\n\thttp_models::{\n\t\taccount::{LoginRequest, SignupRequest, UpdateRequest},\n\t\titinerary::Itinerary,\n\t\tmessage::{MessagePageRequest, SendMessageRequest, UpdateMessageRequest},\n\t},\n\tlog,\n\tmiddleware::AuthUser,\n\tsql_models::{BudgetBucket, RiskTolerence},\n};\nuse argon2::{\n\tArgon2,\n\tpassword_hash::{PasswordHash, PasswordHasher, PasswordVerifier, SaltString, rand_core::OsRng},\n};\nuse axum::{Extension, Json, Router};\nuse chrono::{NaiveDate, Utc};\nuse serde_json::json;\nuse serial_test::serial;\nuse sqlx::{PgPool, migrate};\nuse std::{\n\tfs,\n\tio::Write,\n\tpath::Path,\n\ttime::{Duration, SystemTime},\n};\nuse tokio::net::TcpListener;\nuse tower_cookies::{\n\tCookie, CookieManagerLayer, Key,\n\tcookie::{CookieJar, SameSite, time},\n};\nuse tracing::{error, info, trace};\n\n// UNIT TESTS\n\n/// Test password verification logic\n#[test]\nfn test_password_verification() {\n\tlet password = \"test_password123\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hash the password\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify correct password\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// Verify incorrect password fails\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"wrong_password\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test token generation format\n#[test]\nfn test_token_generation() {\n\tlet user_id = 42;\n\tlet token = format!(\"user-{}.exp.sign\", user_id);\n\tassert_eq!(token, \"user-42.exp.sign\");\n\tassert!(token.starts_with(\"user-\"));\n\tassert!(token.ends_with(\".exp.sign\"));\n}\n\n/// Test cookie security settings\n#[test]\nfn test_cookie_security_development() {\n\tlet token_value = \"test-token-123\";\n\tlet on_production = false;\n\tlet domain = \"localhost\";\n\n\tlet cookie = Cookie::build((\"auth-token\", token_value))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.max_age(time::Duration::days(3))\n\t\t.build();\n\n\tassert_eq!(cookie.name(), \"auth-token\");\n\tassert_eq!(cookie.value(), token_value);\n\tassert_eq!(cookie.path(), Some(\"/\"));\n\tassert_eq!(cookie.http_only(), Some(true));\n\tassert_eq!(cookie.same_site(), Some(SameSite::Lax));\n\tassert!(!cookie.secure().unwrap_or(false));\n}\n\n/// Test cookie security settings for production\n#[test]\nfn test_cookie_security_production() {\n\tlet token_value = \"test-token-456\";\n\tlet on_production = true;\n\tlet domain = \"example.com\";\n\n\tlet cookie = Cookie::build((\"auth-token\", token_value))\n\t\t.domain(domain.to_string())\n\t\t.path(\"/\")\n\t\t.secure(on_production)\n\t\t.http_only(true)\n\t\t.same_site(if on_production {\n\t\t\tSameSite::Strict\n\t\t} else {\n\t\t\tSameSite::Lax\n\t\t})\n\t\t.max_age(time::Duration::days(3))\n\t\t.build();\n\n\tassert_eq!(cookie.name(), \"auth-token\");\n\tassert_eq!(cookie.value(), token_value);\n\tassert_eq!(cookie.http_only(), Some(true));\n\tassert_eq!(cookie.same_site(), Some(SameSite::Strict));\n\tassert!(cookie.secure().unwrap_or(false));\n}\n\n/// Test password hashing for signup\n#[test]\nfn test_signup_password_hashing() {\n\tlet password = \"secure_password_123\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hash the password (as done in signup)\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify the hash is not the same as the plain password\n\tassert_ne!(password_hash, password);\n\n\t// Verify the hash starts with expected format\n\tassert!(password_hash.starts_with(\"$argon2\"));\n\n\t// Verify we can verify the password later (as in login)\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n}\n\n/// Test that different salts produce different hashes\n#[test]\nfn test_signup_different_salts() {\n\tlet password = \"same_password\";\n\tlet argon2 = Argon2::default();\n\n\t// Generate two hashes with different salts\n\tlet salt1 = SaltString::generate(\u0026mut OsRng);\n\tlet hash1 = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt1)\n\t\t.unwrap()\n\t\t.to_string();\n\n\tlet salt2 = SaltString::generate(\u0026mut OsRng);\n\tlet hash2 = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt2)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Hashes should be different due to different salts\n\tassert_ne!(hash1, hash2);\n\n\t// But both should verify the same password\n\tlet parsed_hash1 = PasswordHash::new(\u0026hash1).unwrap();\n\tlet parsed_hash2 = PasswordHash::new(\u0026hash2).unwrap();\n\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash1)\n\t\t\t.is_ok()\n\t);\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(password.as_bytes(), \u0026parsed_hash2)\n\t\t\t.is_ok()\n\t);\n}\n\n/// Test that password hash cannot be reversed to plain text\n#[test]\nfn test_signup_hash_irreversibility() {\n\tlet password = \"my_secret_password_456\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Hash should not contain the plain password\n\tassert!(!password_hash.contains(password));\n\n\t// Hash should be significantly longer than input\n\tassert!(password_hash.len() \u003e password.len() * 2);\n}\n\n/// Test that any password can be hashed (even if it wouldn't pass validation)\n#[test]\nfn test_password_hashing_mechanism() {\n\t// Test that the hashing algorithm works with any input\n\tlet test_password = \"abc\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\t// Hashing mechanism should work regardless of validation rules\n\tlet result = argon2.hash_password(test_password.as_bytes(), \u0026salt);\n\tassert!(result.is_ok());\n\n\tlet password_hash = result.unwrap().to_string();\n\n\t// Verify the hash works\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(test_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// But wrong password should fail\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"wrong\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test password with special ASCII characters\n#[test]\nfn test_signup_special_characters_password() {\n\t// Only ASCII special characters are allowed\n\tlet special_password = \"Passw0rd!@#$%\";\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(special_password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify special characters are handled correctly\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(special_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n\n\t// Wrong password should fail\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(b\"Passw0rd!@#$\", \u0026parsed_hash)\n\t\t\t.is_err()\n\t);\n}\n\n/// Test maximum allowed password length (128 chars)\n#[test]\nfn test_signup_max_password_length() {\n\t// 128 characters with required complexity\n\tlet max_password = \"A\".to_string() + \u0026\"a\".repeat(126) + \"1\";\n\tassert_eq!(max_password.len(), 128);\n\n\tlet salt = SaltString::generate(\u0026mut OsRng);\n\tlet argon2 = Argon2::default();\n\n\tlet password_hash = argon2\n\t\t.hash_password(max_password.as_bytes(), \u0026salt)\n\t\t.unwrap()\n\t\t.to_string();\n\n\t// Verify max length password works\n\tlet parsed_hash = PasswordHash::new(\u0026password_hash).unwrap();\n\tassert!(\n\t\tArgon2::default()\n\t\t\t.verify_password(max_password.as_bytes(), \u0026parsed_hash)\n\t\t\t.is_ok()\n\t);\n}\n\n#[test]\nfn test_validate_email() {\n\t// valid\n\tassert!(SignupRequest::validate_email(\"user@example.com\"));\n\tassert!(SignupRequest::validate_email(\"test.user@domain.co.uk\"));\n\tassert!(SignupRequest::validate_email(\"name+tag@company.org\"));\n\tassert!(SignupRequest::validate_email(\"user123@test-domain.com\"));\n\n\t// invalid\n\tassert!(!SignupRequest::validate_email(\"\"));\n\tassert!(!SignupRequest::validate_email(\"notanemail\"));\n\tassert!(!SignupRequest::validate_email(\"@example.com\"));\n\tassert!(!SignupRequest::validate_email(\"user@\"));\n\tassert!(!SignupRequest::validate_email(\"user@.com\"));\n\tassert!(!SignupRequest::validate_email(\"user @example.com\"));\n\tassert!(!SignupRequest::validate_email(\"user@exam ple.com\"));\n}\n\n#[test]\nfn test_validate_password() {\n\t// valid\n\tassert!(SignupRequest::validate_password(\"Password1\").is_ok());\n\tassert!(SignupRequest::validate_password(\"MySecure123\").is_ok());\n\tassert!(SignupRequest::validate_password(\"Passw0rd!@#\").is_ok());\n\tassert!(SignupRequest::validate_password(\"LongerPassword123\").is_ok());\n\n\t// too short\n\tlet result = SignupRequest::validate_password(\"Pass1\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must be at least 8 characters long\"\n\t);\n\n\t// no uppercase\n\tlet result = SignupRequest::validate_password(\"password123\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one uppercase letter\"\n\t);\n\n\t// no lowercase\n\tlet result = SignupRequest::validate_password(\"PASSWORD123\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one lowercase letter\"\n\t);\n\n\t// no number\n\tlet result = SignupRequest::validate_password(\"PasswordOnly\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain at least one number\"\n\t);\n\n\t// too long\n\tlet password = \"A\".repeat(129) + \"1a\";\n\tlet result = SignupRequest::validate_password(\u0026password);\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must be 128 characters or less\"\n\t);\n\n\t// non ascii\n\tlet result = SignupRequest::validate_password(\"Password1パスワード\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain only ASCII characters\"\n\t);\n\n\t// emoji\n\tlet result = SignupRequest::validate_password(\"Password1🔒\");\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Password must contain only ASCII characters\"\n\t);\n\n\t// max length allowed\n\t// Test that exactly 128 characters is okay (with required chars)\n\tlet password = \"A\".to_string() + \u0026\"a\".repeat(126) + \"1\";\n\tassert_eq!(password.len(), 128);\n\tassert!(SignupRequest::validate_password(\u0026password).is_ok());\n}\n\n#[test]\nfn test_validate_signup_payload() {\n\t// valid\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tassert!(payload.validate().is_ok());\n\n\t// empty email\n\tlet payload = SignupRequest {\n\t\temail: \"\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Email is required\");\n\n\t// invalid email\n\tlet payload = SignupRequest {\n\t\temail: \"not-an-email\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Invalid email format\");\n\n\t// empty first name\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"First name is required\");\n\n\t// empty last name\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(result.unwrap_err(), \"Last name is required\");\n\n\t// first name too long\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"a\".repeat(51),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"First name must be 50 characters or less\"\n\t);\n\n\t// last name too long\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"a\".repeat(51),\n\t\tpassword: \"Password123\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert_eq!(\n\t\tresult.unwrap_err(),\n\t\t\"Last name must be 50 characters or less\"\n\t);\n\n\t// weak password\n\tlet payload = SignupRequest {\n\t\temail: \"test@example.com\".to_string(),\n\t\tfirst_name: \"John\".to_string(),\n\t\tlast_name: \"Doe\".to_string(),\n\t\tpassword: \"weak\".to_string(),\n\t};\n\tlet result = payload.validate();\n\tassert!(result.is_err());\n\tassert!(result.unwrap_err().contains(\"Password\"));\n\n\t// whitespace trimming\n\tlet payload = SignupRequest {\n\t\temail: \"  test@example.com  \".to_string(),\n\t\tfirst_name: \"  John  \".to_string(),\n\t\tlast_name: \"  Doe  \".to_string(),\n\t\tpassword: \"Password123\".to_string(), // Valid ASCII password\n\t};\n\t// Email and names should be validated after trimming whitespace\n\tassert!(payload.validate().is_ok());\n}\n\n/// Verifies that `db::create_pool` panics when `DATABASE_URL` is not set.\n#[test]\n#[serial(db)]\nfn test_db_pool_panics_without_env() {\n\t// Save and clear DATABASE_URL\n\tlet prev = std::env::var(\"DATABASE_URL\").ok();\n\tunsafe {\n\t\tstd::env::remove_var(\"DATABASE_URL\");\n\t}\n\n\tlet result = std::panic::catch_unwind(|| {\n\t\tlet rt = tokio::runtime::Runtime::new().unwrap();\n\t\trt.block_on(async {\n\t\t\t// Should panic due to missing env var\n\t\t\tlet _ = db::create_pool().await;\n\t\t});\n\t});\n\n\t// Restore DATABASE_URL\n\tmatch prev {\n\t\tSome(val) =\u003e unsafe { std::env::set_var(\"DATABASE_URL\", val) },\n\t\tNone =\u003e unsafe { std::env::remove_var(\"DATABASE_URL\") },\n\t}\n\n\tassert!(result.is_err());\n}\n\n/// Optional integration test requiring a real database in `DATABASE_URL`.\n/// Run with: `cargo test -- --ignored`\n#[tokio::test]\n#[ignore]\n#[serial(db)]\nasync fn test_db_pool_connects_and_selects() {\n\tlet database_url = match std::env::var(\"DATABASE_URL\") {\n\t\tOk(v) =\u003e v,\n\t\tErr(_) =\u003e {\n\t\t\t// Not set in most environments; mark as success skip\n\t\t\tinfo!(\"DATABASE_URL not set; skipping real DB test\");\n\t\t\treturn;\n\t\t}\n\t};\n\n\t// Ensure env var is present for this test\n\tunsafe {\n\t\tstd::env::set_var(\"DATABASE_URL\", database_url);\n\t}\n\n\tlet pool = db::create_pool().await;\n\n\t// Simple liveness query\n\tlet row: (i32,) = sqlx::query_as(\"SELECT 1\")\n\t\t.fetch_one(\u0026pool)\n\t\t.await\n\t\t.expect(\"SELECT 1 should succeed\");\n\tassert_eq!(row.0, 1);\n}\n\n/// Verifies that `logs/latest.log` is created and written to from log events.\n#[test]\n#[serial(log)]\nfn test_logger() {\n\t//dotenv doesn't work in github actions bc .env is ignored\n\tunsafe {\n\t\t// Safety\n\t\t//\n\t\t// Always safe on Windows.\n\t\t//\n\t\t// Other platforms: risk of race condition in multi-threaded environment.\n\t\t// We are not reading/writing this environment variable from multiple threads, so we're good.\n\t\tstd::env::set_var(\"RUST_LOG\", \"warn,Capping2025=debug\");\n\t}\n\tlet latest_log_path = Path::new(LOG_DIR).join(LATEST_LOG);\n\tlog::init_logger();\n\ttrace!(\"Test trace\");\n\terror!(\"Test error\");\n\tlog::log_writer().flush().unwrap();\n\t//wait for IO to finish because flushing doesn't work?\n\tstd::thread::sleep(Duration::from_millis(10));\n\tlet logs = fs::read_to_string(latest_log_path).unwrap();\n\tinfo!(\"{logs}\");\n\tassert!(logs.len() \u003e 0);\n}\n\n/// Verifies that `logs/crash.log` is created and written to on a panic.\n#[test]\n#[serial(panic_log)]\nfn test_panic_handler() {\n\tlog::init_panic_handler();\n\tstd::panic::catch_unwind(|| {\n\t\tpanic!(\"Test panic\");\n\t})\n\t.unwrap_err();\n\tlet content = fs::read_to_string(Path::new(LOG_DIR).join(CRASH_LOG)).unwrap();\n\tassert!(content.len() \u003e 0);\n}\n\n/// It's easier to have all these in 1 test to share a db pool, and we don't have to spin up a server\n#[tokio::test]\n#[serial(db)]\nasync fn test_controllers() {\n\t_ = dotenvy::dotenv();\n\tlet cookies = CookieJar::new();\n\tlet key = Extension(Key::derive_from(\u0026[0u8; 32]));\n\tlet pool = Extension(db::create_pool().await);\n\n\t_ = tokio::join!(\n\t\ttest_signup_conflict_on_duplicate_email(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_http_login_invalid_credentials(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_current_endpoint_returns_account(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_returns_account(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_partial_fields(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_update_endpoint_with_preferences(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_get_itinerary_id_not_found(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_invalid_signup_email(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_saved_itineraries_endpoint(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_save_itineraries(cookies.clone(), key.clone(), pool.clone()),\n\t\ttest_chat_flow(cookies.clone(), key.clone(), pool.clone()),\n\t);\n}\n\nasync fn test_signup_conflict_on_duplicate_email(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"dupe+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Bob\"),\n\t\tlast_name: String::from(\"Dupe\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// First signup should succeed\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json.clone())\n\t\t.await\n\t\t.unwrap();\n\t// Second signup with same email should 409\n\tassert_eq!(\n\t\tcontrollers::account::api_signup(\u0026mut cookies, key, pool, json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t409\n\t);\n}\n\nasync fn test_http_login_invalid_credentials(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"badEmail+{}@example.com\", unique);\n\tlet json = Json(LoginRequest {\n\t\temail,\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// attempt to login with nonexistant email\n\tassert_eq!(\n\t\tcontrollers::account::api_login(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\tlet email = format!(\"goodEmail+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail: email.clone(),\n\t\tfirst_name: String::from(\"Alice\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// signup\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\tlet json = Json(LoginRequest {\n\t\temail,\n\t\tpassword: String::from(\"ChickenNugget1234\"),\n\t});\n\t// attempt to login with a correct email, but the wrong password\n\tassert_eq!(\n\t\tcontrollers::account::api_login(\u0026mut cookies, key, pool, json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n}\n\nasync fn test_current_endpoint_returns_account(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"current+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Current\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\t// Test /current endpoint returns Account struct\n\t_ = controllers::account::api_current(pool.clone(), user)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_returns_account(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"update+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Update\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with all fields\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: Some(format!(\"updated+{}@example.com\", unique)),\n\t\tfirst_name: Some(String::from(\"Updated\")),\n\t\tlast_name: Some(String::from(\"User\")),\n\t\tpassword: Some(String::from(\"NewPassword123\")),\n\t\tbudget_preference: Some(BudgetBucket::HighBudget),\n\t\trisk_preference: Some(RiskTolerence::Adventurer),\n\t\tfood_allergies: Some(String::from(\"Peanuts, shellfish\")),\n\t\tdisabilities: Some(String::from(\"Wheelchair accessible\")),\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_partial_fields(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"partial+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Partial\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with only some fields\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: None,\n\t\tfirst_name: Some(String::from(\"PartiallyUpdated\")),\n\t\tlast_name: None,\n\t\tpassword: None,\n\t\tbudget_preference: None,\n\t\trisk_preference: None,\n\t\tfood_allergies: Some(String::from(\"Gluten\")),\n\t\tdisabilities: None,\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_update_endpoint_with_preferences(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"prefs+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Prefs\"),\n\t\tlast_name: String::from(\"Tester\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /update endpoint with enum preferences\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(UpdateRequest {\n\t\temail: None,\n\t\tfirst_name: None,\n\t\tlast_name: None,\n\t\tpassword: None,\n\t\tbudget_preference: Some(BudgetBucket::LuxuryBudget),\n\t\trisk_preference: Some(RiskTolerence::RiskTaker),\n\t\tfood_allergies: None,\n\t\tdisabilities: None,\n\t});\n\t_ = controllers::account::api_update(pool, user, json)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_get_itinerary_id_not_found(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"get_itinerary+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Get\"),\n\t\tlast_name: String::from(\"Itinerary\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /{id} endpoint with non-existent itinerary (should return 404)\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tassert_eq!(\n\t\tcontrollers::itinerary::api_get_itinerary(user, axum::extract::Path(999999), pool.clone())\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n}\n\nasync fn test_invalid_signup_email(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"invalid_email_{}\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Get\"),\n\t\tlast_name: String::from(\"Event\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tassert_eq!(\n\t\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n}\n\nasync fn test_saved_itineraries_endpoint(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"saved_itineraries+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// Test /saved endpoint returns user's itineraries\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\t_ = controllers::itinerary::api_saved_itineraries(user, pool)\n\t\t.await\n\t\t.unwrap();\n}\n\nasync fn test_save_itineraries(\n\tmut cookies: CookieJar,\n\tkey: Extension\u003cKey\u003e,\n\tpool: Extension\u003cPgPool\u003e,\n) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"test_save_itinerary_new+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// save itinerary with id not in db\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet json = Json(Itinerary {\n\t\tid: 0,\n\t\tstart_date: NaiveDate::parse_from_str(\"2025-01-01\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2025-12-31\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"Updated Title\"),\n\t});\n\tlet itinerary_id = controllers::itinerary::api_save(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap()\n\t\t.id;\n\tassert_ne!(itinerary_id, 0);\n\n\t// save itinerary with a matching id already in db\n\tlet json = Json(Itinerary {\n\t\tid: itinerary_id,\n\t\tstart_date: NaiveDate::parse_from_str(\"2026-01-01\", \"%Y-%m-%d\").unwrap(),\n\t\tend_date: NaiveDate::parse_from_str(\"2026-12-31\", \"%Y-%m-%d\").unwrap(),\n\t\tevent_days: vec![],\n\t\tchat_session_id: None,\n\t\ttitle: String::from(\"2nd Updated Title\"),\n\t});\n\tassert_eq!(\n\t\tcontrollers::itinerary::api_save(user, pool, json)\n\t\t\t.await\n\t\t\t.unwrap()\n\t\t\t.id,\n\t\titinerary_id\n\t);\n}\n\nasync fn test_chat_flow(mut cookies: CookieJar, key: Extension\u003cKey\u003e, pool: Extension\u003cPgPool\u003e) {\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"test_latest_message_page+{}@example.com\", unique);\n\tlet json = Json(SignupRequest {\n\t\temail,\n\t\tfirst_name: String::from(\"Saved\"),\n\t\tlast_name: String::from(\"Itineraries\"),\n\t\tpassword: String::from(\"Password123\"),\n\t});\n\t// Signup user\n\tcontrollers::account::api_signup(\u0026mut cookies, key.clone(), pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\n\t// create new chat\n\tlet cookie = cookies.get(\"auth-token\").unwrap();\n\tlet parts: Vec\u003c\u0026str\u003e = cookie.value().split(\u0026['-', '.']).collect();\n\tlet user = Extension(AuthUser {\n\t\tid: parts[1].parse().unwrap(),\n\t});\n\tlet first_chat_session_id = controllers::chat::api_new_chat(user, pool.clone())\n\t\t.await\n\t\t.unwrap()\n\t\t.chat_session_id;\n\tassert_ne!(first_chat_session_id, 0);\n\n\t// create chat session - reusing first one because it's empty\n\tlet chat_session_id = controllers::chat::api_new_chat(user, pool.clone())\n\t\t.await\n\t\t.unwrap()\n\t\t.chat_session_id;\n\tassert_eq!(first_chat_session_id, chat_session_id);\n\n\t// send a bunch of messages\n\tlet mut message_ids = [0; MESSAGE_PAGE_LEN as usize + 5];\n\tfor i in 0..MESSAGE_PAGE_LEN as usize + 5 {\n\t\tlet json = Json(SendMessageRequest {\n\t\t\tchat_session_id,\n\t\t\ttext: format!(\"Test msg {}\", i),\n\t\t\titinerary_id: None,\n\t\t});\n\t\tmessage_ids[i] = controllers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap()\n\t\t\t.user_message_id;\n\t\tassert_ne!(message_ids[i], 0);\n\t}\n\n\t// send empty message\n\tlet json = Json(SendMessageRequest {\n\t\tchat_session_id,\n\t\ttext: String::new(),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\t// send message invalid chat session\n\tlet json = Json(SendMessageRequest {\n\t\tchat_session_id: 0,\n\t\ttext: String::from(\"Test msg invalid chat session id\"),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_send_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n\n\t// get latest messages and make sure messages are in chronological order\n\tlet chat_session = controllers::chat::api_chats(user, pool.clone())\n\t\t.await\n\t\t.unwrap();\n\tlet chat_session = chat_session.0.chat_sessions.first().unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tlatest_page\n\t\t\t.0\n\t\t\t.message_page\n\t\t\t.is_sorted_by(|a, b| a.timestamp \u003c b.timestamp)\n\t);\n\n\t// get specific messages and make sure messages are in chronological order\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: Some(latest_page.message_page[0].id),\n\t});\n\tlet next_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tnext_page\n\t\t\t.0\n\t\t\t.message_page\n\t\t\t.is_sorted_by(|a, b| a.timestamp \u003c b.timestamp)\n\t);\n\tassert_eq!(\n\t\tlatest_page.message_page[0].id,\n\t\tnext_page.message_page.last().unwrap().id\n\t);\n\n\t// get page with invalid message id\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: Some(0),\n\t});\n\tlet empty_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(empty_page.message_page.len(), 0);\n\tassert_eq!(empty_page.prev_message_id, None);\n\n\t// get page with invalid chat session id\n\n\t// update message with empty text\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: message_ids[0],\n\t\tnew_text: String::new(),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_update_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t400\n\t);\n\n\t// update message with invalid message id\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: 0,\n\t\tnew_text: String::from(\"Updated message\"),\n\t\titinerary_id: None,\n\t});\n\tassert_eq!(\n\t\tcontrollers::chat::api_update_message(user, pool.clone(), json)\n\t\t\t.await\n\t\t\t.unwrap_err()\n\t\t\t.status_code()\n\t\t\t.as_u16(),\n\t\t404\n\t);\n\n\t// update message\n\tlet json = Json(UpdateMessageRequest {\n\t\tmessage_id: message_ids[0],\n\t\tnew_text: String::from(\"Updated message\"),\n\t\titinerary_id: None,\n\t});\n\t_ = controllers::chat::api_update_message(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool.clone(), json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(latest_page.prev_message_id, None);\n\tassert_eq!(latest_page.message_page.len(), 2);\n\n\t//delete chat session\n\tcontrollers::chat::api_delete_chat(user, pool.clone(), axum::extract::Path(chat_session_id))\n\t\t.await\n\t\t.unwrap();\n\tlet json = Json(MessagePageRequest {\n\t\tchat_session_id: chat_session.id,\n\t\tmessage_id: None,\n\t});\n\tlet latest_page = controllers::chat::api_message_page(user, pool, json)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(latest_page.prev_message_id, None);\n\tassert_eq!(latest_page.message_page.len(), 0);\n}\n\n// INTEGRATION TESTS\n\nstatic mut PORT: u16 = 0;\n\n#[tokio::test]\n#[serial(db, log, panic_log)]\nasync fn test_endpoints() {\n\t// Only use dotenvy for local testing\n\t// CI testing should use GitHub environment variables\n\t_ = dotenvy::dotenv();\n\n\t// Initialize project logger once so test logs are written to logs/latest.log\n\t// Set a default log level for tests if not provided\n\tif std::env::var(\"RUST_LOG\").is_err() {\n\t\tunsafe { std::env::set_var(\"RUST_LOG\", \"debug\") };\n\t}\n\tlog::init_panic_handler();\n\tlog::init_logger();\n\n\tlet pool = db::create_pool().await;\n\tmatch migrate!().run(\u0026pool).await {\n\t\tOk(_) =\u003e (),\n\t\tErr(sqlx::migrate::MigrateError::VersionMismatch(_)) =\u003e {\n\t\t\teprintln!(\"migrations version mismatch; assuming DB already prepared. Skipping.\");\n\t\t}\n\t\tErr(e) =\u003e panic!(\"migrations run: {e}\"),\n\t}\n\n\t// Build app\n\t// Use an encryption/signing key for private cookies\n\tlet cookie_key = Key::generate();\n\tlet account_routes = controllers::account::account_routes();\n\tlet itinerary_routes = controllers::itinerary::itinerary_routes();\n\tlet chat_routes = controllers::chat::chat_routes();\n\tlet api_routes = Router::new()\n\t\t.nest(\"/account\", account_routes)\n\t\t.nest(\"/itinerary\", itinerary_routes)\n\t\t.nest(\"/chat\", chat_routes);\n\tlet app = Router::new()\n\t\t.nest(\"/api\", api_routes)\n\t\t.layer(Extension(pool.clone()))\n\t\t.layer(Extension(cookie_key.clone()))\n\t\t.layer(CookieManagerLayer::new());\n\n\t// Bind to ephemeral port and spawn server\n\tlet listener = TcpListener::bind(\"127.0.0.1:0\")\n\t\t.await\n\t\t.expect(\"bind test server\");\n\tunsafe { PORT = listener.local_addr().unwrap().port() };\n\tlet server = axum::serve(listener, app.into_make_service()).into_future();\n\ttokio::spawn(server);\n\n\t// Any unit tests that test cookies or middleware, or any integration tests should go here.\n\t// Any other unit test should not go here. Instead, run it as a separate unit test and just invoke the controller directly.\n\ttokio::join!(\n\t\ttest_signup_and_login_happy_path(\u0026cookie_key),\n\t\ttest_auth_for_all_required(),\n\t\ttest_http_signup_and_login_flow(),\n\t\ttest_validate_with_bad_and_good_cookie(),\n\t\ttest_get_itinerary_invalid_format(),\n\t\ttest_signup_logout(),\n\t\t// just throw all the tests in here\n\t);\n}\n\nasync fn test_signup_and_login_happy_path(key: \u0026Key) {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"user+{}@example.com\", unique);\n\n\t// Signup\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Alice\",\n\t\t\t\t\"last_name\": \"Tester\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(resp.status().as_u16(), 200);\n\n\t// Login\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"user+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(resp.status().as_u16(), 200);\n\t// Extract cookie and decrypt via private jar\n\tlet set_cookie = resp.header(\"set-cookie\").unwrap();\n\t// Parse full Set-Cookie line (handles '=' inside value)\n\tlet parsed = Cookie::parse(set_cookie.to_string()).unwrap();\n\tlet mut jar = CookieJar::new();\n\tjar.add(parsed.clone());\n\tlet decrypted = jar.private(\u0026key).get(parsed.name()).unwrap();\n\t// token: user-\u003cid\u003e.\u003cexp\u003e.sign\n\tlet parts: Vec\u003c\u0026str\u003e = decrypted.value().split('.').collect();\n\tassert_eq!(parts.len(), 3);\n\tassert!(parts[0].starts_with(\"user-\"));\n\tassert_eq!(parts[2], \"sign\");\n\tlet exp: i64 = parts[1].parse().unwrap();\n\tlet now = chrono::Utc::now().timestamp();\n\tassert!(exp \u003e now);\n}\n\nasync fn test_auth_for_all_required() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\n\tlet account_update_payload = json!({});\n\tlet chat_message_page_payload = json!({\n\t\t\"chat_session_id\": 1,\n\t\t\"message_id\": 1\n\t});\n\tlet chat_update_message_payload = json!({\n\t\t\"message_id\": 1,\n\t\t\"new_text\": \"test\"\n\t});\n\tlet chat_send_message_payload = json!({\n\t\t\"chat_session_id\": 1,\n\t\t\"text\": \"test\"\n\t});\n\tlet itinerary_save_payload = json!({\n\t\t\"id\": 1,\n\t\t\"start_date\": \"2025-11-05 00:00:00\",\n\t\t\"end_date\": \"2025-11-10 00:00:00\",\n\t\t\"morning_events\": [],\n\t\t\"noon_events\": [],\n\t\t\"afternoon_events\": [],\n\t\t\"evening_events\": []\n\t});\n\n\tfor res in futures::future::join_all([\n\t\thc.do_get(\"/api/account/current\"),\n\t\thc.do_get(\"/api/account/validate\"),\n\t\thc.do_get(\"/api/account/logout\"),\n\t\thc.do_get(\"/api/chat/chats\"),\n\t\thc.do_get(\"/api/chat/newChat\"),\n\t\thc.do_get(\"/api/itinerary/saved\"),\n\t\thc.do_get(\"/api/itinerary/:id\"),\n\t])\n\t.await\n\t.iter()\n\t{\n\t\tassert_eq!(\n\t\t\tres.as_ref().unwrap().status().as_u16(),\n\t\t\t401,\n\t\t\t\"Protected route should require authentication\"\n\t\t);\n\t}\n\n\tfor res in futures::future::join_all([\n\t\thc.do_post(\"/api/account/update\", account_update_payload),\n\t\thc.do_post(\"/api/chat/messagePage\", chat_message_page_payload),\n\t\thc.do_post(\"/api/chat/updateMessage\", chat_update_message_payload),\n\t\thc.do_post(\"/api/chat/sendMessage\", chat_send_message_payload),\n\t\thc.do_post(\"/api/itinerary/save\", itinerary_save_payload),\n\t])\n\t.await\n\t.iter()\n\t{\n\t\tassert_eq!(\n\t\t\tres.as_ref().unwrap().status().as_u16(),\n\t\t\t401,\n\t\t\t\"Protected route should require authentication\"\n\t\t);\n\t}\n}\n\nasync fn test_http_signup_and_login_flow() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"user+{}@example.com\", unique);\n\n\t// Signup\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Alice\",\n\t\t\t\t\"last_name\": \"Tester\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tresp.status().is_success(),\n\t\t\"signup failed: {}\",\n\t\tresp.status()\n\t);\n\n\t// Login\n\tlet resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"user+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert!(\n\t\tresp.status().is_success(),\n\t\t\"login failed: {}\",\n\t\tresp.status()\n\t);\n}\n\nasync fn test_validate_with_bad_and_good_cookie() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\t// No cookie (treated similarly to bad/invalid cookie): expect unauthorized\n\tlet resp = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tresp.status().as_u16(),\n\t\t401,\n\t\t\"Missing/invalid cookie should return 401\"\n\t);\n\n\t// Good cookie: create user and login to receive a valid private cookie, then validate\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"cookie+{}@example.com\", unique);\n\n\tlet signup = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Cook\",\n\t\t\t\t\"last_name\": \"Ie\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup.status().as_u16(), 200);\n\n\tlet login = hc\n\t\t.do_post(\n\t\t\t\"/api/account/login\",\n\t\t\tjson!({\n\t\t\t\t\"email\": format!(\"cookie+{}@example.com\", unique),\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(login.status().as_u16(), 200);\n\n\t// Client should now hold the private cookie; call validate and expect 200\n\tlet resp = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tresp.status().as_u16(),\n\t\t200,\n\t\t\"/validate with good cookie should return 200\"\n\t);\n}\n\nasync fn test_get_itinerary_invalid_format() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"get_itinerary+{}@example.com\", unique);\n\n\t// Signup user\n\tlet signup_resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Get\",\n\t\t\t\t\"last_name\": \"Itinerary\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup_resp.status().as_u16(), 200);\n\n\t// Test with invalid ID format (should return 400)\n\tlet invalid_resp = hc.do_get(\"/api/itinerary/invalid\").await.unwrap();\n\tassert_eq!(invalid_resp.status().as_u16(), 400);\n}\n\nasync fn test_signup_logout() {\n\tlet hc = httpc_test::new_client(format!(\"http://localhost:{}\", unsafe { PORT })).unwrap();\n\tlet unique = Utc::now().timestamp_nanos_opt().unwrap();\n\tlet email = format!(\"login_then_logout+{}@example.com\", unique);\n\n\t// Signup user\n\tlet signup_resp = hc\n\t\t.do_post(\n\t\t\t\"/api/account/signup\",\n\t\t\tjson!({\n\t\t\t\t\"email\": email,\n\t\t\t\t\"first_name\": \"Get\",\n\t\t\t\t\"last_name\": \"Event\",\n\t\t\t\t\"password\": \"Password123\"\n\t\t\t}),\n\t\t)\n\t\t.await\n\t\t.unwrap();\n\tassert_eq!(signup_resp.status().as_u16(), 200);\n\n\tlet cookie = signup_resp.res_cookie(\"auth-token\").unwrap();\n\tassert!(cookie.expires.unwrap() \u003e SystemTime::now());\n\n\t// Logout\n\tlet logout_resp = hc.do_get(\"/api/account/logout\").await.unwrap();\n\tassert_eq!(logout_resp.status().as_u16(), 200);\n\n\tlet cookie = logout_resp.res_cookie(\"auth-token\").unwrap();\n\tassert!(cookie.expires.unwrap() \u003c SystemTime::now());\n\n\t// Hit any protected route\n\tlet validate_res = hc.do_get(\"/api/account/validate\").await.unwrap();\n\tassert_eq!(\n\t\tvalidate_res.status().as_u16(),\n\t\t401,\n\t\t\"Missing/invalid cookie should return 401\"\n\t);\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>